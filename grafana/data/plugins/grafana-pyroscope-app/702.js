"use strict";(self.webpackChunkgrafana_pyroscope_app=self.webpackChunkgrafana_pyroscope_app||[]).push([[702],{702:(e,t,n)=>{n.r(t),n.d(t,{default:()=>G});var r=n(4776),o=n(1049),a=n(5959),i=n.n(a),l=n(6089),c=n(2007);const s=e=>({container:l.css`
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: ${e.spacing(1)};
    width: 100%;
  `,column:l.css`
    width: 50%;
  `});function p({left:e,right:t}){const n=(0,c.useStyles2)(s);return i().createElement("div",{className:n.container},i().createElement("div",{className:n.column},e),i().createElement("div",{className:n.column},t))}var u=n(7907),f=n(2673),m=n(5656);function d(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function y(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){d(a,r,o,i,l,"next",e)}function l(e){d(a,r,o,i,l,"throw",e)}i(void 0)}))}}class g extends m.O{get(e,t){var n=this;return y((function*(){const r=yield n.fetch("/adhocprofiles.v1.AdHocProfileService/Get",{method:"POST",body:JSON.stringify({id:e,profile_type:t})}),o=yield r.json();return{id:o.id,name:o.name,profileTypes:o.profileTypes,profile:JSON.parse(o.flamebearerProfile)}}))()}uploadSingle(e){var t=this;return y((function*(){const n=yield t._readProfileFile(e),r=yield t.fetch("/adhocprofiles.v1.AdHocProfileService/Upload",{method:"POST",body:JSON.stringify({name:e.name,profile:n})}),o=yield r.json();return{id:o.id,name:e.name,profileTypes:o.profileTypes,profile:JSON.parse(o.flamebearerProfile)}}))()}uploadDiff(){return y((function*(){return{id:"?",name:"??",profileTypes:[],profile:null}}))()}_readProfileFile(e){return y((function*(){return new Promise(((t,n)=>{const r=new FileReader;r.addEventListener("load",(()=>{try{t(function(e){const[,t]=e.split(";base64,");if(!t)throw new Error("No content after stripping the base64 prefix.");if(e===t)throw new Error("No base64 prefix?!");return t}(r.result))}catch(e){n(e)}})),r.addEventListener("error",(()=>{n(new Error(`Error while reading file "${e.name}"!`))})),r.readAsDataURL(e)}))}))()}}const h=new g;function b(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function v(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){b(a,r,o,i,l,"next",e)}function l(e){b(a,r,o,i,l,"throw",e)}i(void 0)}))}}function O(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){O(e,t,n[t])}))}return e}function w(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const j={id:"",name:"",profileTypes:[],profile:null};function P(){const[e,t]=(0,a.useState)(!1),[n,r]=(0,a.useState)(j);(0,a.useEffect)((()=>()=>{h.abort()}),[]);const o=(0,a.useCallback)((()=>{h.abort(),t(!1),r(j)}),[]),i=(0,a.useCallback)(function(){var e=v((function*(e){o();try{t(!0);const n=yield h.uploadSingle(e);r(n)}catch(e){r(j),h.isAbortError(e)||(0,f.jx)(e,["Error while uploading profile!",e.message])}t(!1)}));return function(t){return e.apply(this,arguments)}}(),[o]),l=(0,a.useCallback)(function(){var e=v((function*(e){const o=e.value;if(o&&n.id&&n.profileTypes.includes(o)){h.abort(),t(!1),r((e=>w(E({},e),{profile:null}))),t(!0);try{const e=yield h.get(n.id,o);r((t=>w(E({},t),{profile:e.profile})))}catch(e){h.isAbortError(e)||(0,f.jx)(e,["Error while fetching profile!",e.message])}t(!1)}}));return function(t){return e.apply(this,arguments)}}(),[n.id,n.profileTypes]);return{processFile:i,profileTypes:n.profileTypes,selectProfileType:l,profile:n.profile,removeFile:o,isLoading:e}}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){S(e,t,n[t])}))}return e}function T(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const x={accept:{"application/gzip":[".gz"],"application/json":[".json"],"application/proto":[".pb",".pprof"]},multiple:!1,onError(e){(0,f.jx)(e,["Error while uploading file!",e.toString()])}};function C({onFileDropped:e,onFileRemove:t}){const n=(0,a.useCallback)((function(t){e(t[0])}),[e]);return i().createElement(c.FileDropzone,{options:T(_({},x),{onDropAccepted:n}),onFileRemove:t})}var D=n(8629);const F=e=>({flamegraph:l.css`
    margin-top: ${e.spacing(2)};
  `});function N({profile:e,diff:t}){const n=(0,c.useStyles2)(F);return i().createElement("div",{className:n.flamegraph,"data-testid":"flamegraph"},i().createElement(D.C,{profile:e,diff:t}))}const k=e=>({selectorContainer:l.css`
    display: flex;
    justify-content: center;
    margin-bottom: ${e.spacing(2)};
  `});function R({profileTypes:e,onChange:t}){const n=(0,c.useStyles2)(k),r=(0,a.useMemo)((()=>e.map((e=>({value:e,label:e})))),[e]),[o,l]=(0,a.useState)(),s=(0,a.useCallback)((e=>{l(e),t(e)}),[t]);return(0,a.useEffect)((()=>{l(r[0])}),[r]),i().createElement("div",{className:n.selectorContainer},i().createElement(c.InlineFieldRow,null,i().createElement(c.InlineField,{label:"Profile",disabled:!r.length,"data-testid":"profile-types-dropdown"},i().createElement(c.Select,{key:null==o?void 0:o.value,value:o,options:r,onChange:s,width:16}))))}const A=e=>({spinner:l.css`
    text-align: center;
    margin-top: ${e.spacing(2)};
  `});function $(){const e=(0,c.useStyles2)(A);return i().createElement("div",{className:e.spinner},i().createElement(c.Spinner,{size:36}))}function L(){const{processFile:e,profileTypes:t,selectProfileType:n,profile:r,removeFile:o,isLoading:a}=P();return i().createElement("div",null,i().createElement(R,{profileTypes:t,onChange:e=>{(0,u.r)("g_pyroscope_app_ad_hoc_profile_metric_selected"),n(e)}}),i().createElement(C,{onFileDropped:t=>{(0,u.r)("g_pyroscope_app_ad_hoc_file_dropped",{fileType:t.type}),e(t)},onFileRemove:()=>{(0,u.r)("g_pyroscope_app_ad_hoc_file_removed"),o()}}),a&&!r?i().createElement($,null):null,r&&i().createElement(N,{profile:r}))}const B=(0,a.memo)(L);function I(){return i().createElement(p,{left:i().createElement(B,null),right:i().createElement(B,null)})}const M=e=>({tabContent:l.css`
    padding: ${e.spacing(2)};
    margin: ${e.spacing(2)};
  `});function J(){const e=(0,c.useStyles2)(M),[t,n]=(0,a.useState)(0);return i().createElement("div",null,i().createElement(c.TabsBar,null,i().createElement(c.Tab,{label:" Single view",active:0===t,onChangeTab:()=>n(0)}),i().createElement(c.Tab,{label:" Comparison view",active:1===t,onChangeTab:()=>n(1)})),i().createElement(c.TabContent,{className:e.tabContent},0===t&&i().createElement(B,null),1===t&&i().createElement(I,null)))}function G(){return(0,r.f)("ad_hoc"),i().createElement(i().Fragment,null,i().createElement(o.s,{title:"Ad hoc view"}),i().createElement(J,null))}},9897:(e,t,n)=>{n.d(t,{N:()=>r});var r=function(e){return e.BASELINE="baseline",e.COMPARISON="comparison",e}({})},8629:(e,t,n)=>{n.d(t,{C:()=>C});var r=n(7781),o=n(3062),a=n(2007),i=n(5959),l=n.n(i),c=n(2673),s=n(7907),p=(n(8727),n(2249)),u=n.n(p),f=n(9090);function m(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}class d extends f.Q{upload(e,t){var n,r=this;return(n=function*(){const n=yield r.fetch("/upload/v1",{method:"POST",body:JSON.stringify({name:e,profile:btoa(JSON.stringify(t)),fileTypeData:{units:t.metadata.units,spyName:t.metadata.spyName},type:"json"})});return yield n.json()},function(){var e=this,t=arguments;return new Promise((function(r,o){var a=n.apply(e,t);function i(e){m(a,r,o,i,l,"next",e)}function l(e){m(a,r,o,i,l,"throw",e)}i(void 0)}))})()}constructor(){super("https://flamegraph.com/api",{"content-type":"application/json"})}}const y=new d;var g=n(9897);const h=new Intl.DateTimeFormat("fr-CA",{year:"numeric",month:"2-digit",day:"2-digit",hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"});function b(e){const t=h.formatToParts(e).reduce(((e,{type:t,value:n})=>(e[t]=n,e)),{});return`${t.year}-${t.month}-${t.day}_${t.hour}${t.minute}`}function v(e){const t=new Date(Math.round(1e3*e.from.unix())),n=new Date(Math.round(1e3*e.to.unix()));return`${b(t)}-to-${b(n)}`}function O(e){const[t,n]=e===g.N.BASELINE?["diffFrom","diffTo"]:["diffFrom-2","diffTo-2"],o=new URLSearchParams(window.location.search),a=o.get(t),i=o.get(n);return{raw:{from:a,to:i},from:(0,r.dateTimeParse)(a),to:(0,r.dateTimeParse)(i)}}function E(e){const t=["baseline",v(O(g.N.BASELINE)),"comparison",v(O(g.N.COMPARISON))];return e?[e,...t].join("_"):["flamegraph",...t].join("_")}function w(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function j({profile:e,enableFlameGraphDotComExport:t}){const n=function(){var t,n=(t=function*(){(0,s.r)("g_pyroscope_app_export_profile",{format:"flamegraph.com"});const t=E(e.metadata.appName);let n;try{n=yield y.upload(t,e)}catch(e){return void(0,c.jx)(e,["Failed to export to flamegraph.com!",e.message])}const r=document.createElement("a");r.target="_blank",r.href=n.url,document.body.appendChild(r),r.click(),document.body.removeChild(r)},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){w(a,r,o,i,l,"next",e)}function l(e){w(a,r,o,i,l,"throw",e)}i(void 0)}))});return function(){return n.apply(this,arguments)}}();return{data:{shouldDisplayFlamegraphDotCom:Boolean(t)},actions:{downloadPng:()=>{(0,s.r)("g_pyroscope_app_export_profile",{format:"png"});const t=`${E(e.metadata.appName)}.png`;document.querySelector('canvas[data-testid="flameGraph"]').toBlob((e=>{if(e)u()(e,t);else{const e=new Error("No Blob, the image cannot be created.");(0,c.jx)(e,["Failed to export to png!",e.message])}}),"image/png")},downloadJson:()=>{(0,s.r)("g_pyroscope_app_export_profile",{format:"json"});const t=`${E(e.metadata.appName)}.json`,n=`data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(e))}`;try{u()(n,t)}catch(e){return void(0,c.jx)(e,["Failed to export to JSON!",e.message])}},uploadToFlamegraphDotCom:n}}}function P(e){const{actions:t}=j(e);return l().createElement(a.Menu,null,l().createElement(a.Menu.Item,{label:"png",onClick:t.downloadPng}),l().createElement(a.Menu.Item,{label:"json",onClick:t.downloadJson}))}function S(e){const{profile:t,enableFlameGraphDotComExport:n}=e;return l().createElement(a.Dropdown,{overlay:l().createElement(P,{profile:t,enableFlameGraphDotComExport:n})},l().createElement(a.Button,{icon:"download-alt",size:"sm",variant:"secondary",fill:"outline","aria-label":"Export profile data",tooltip:"Export profile data"}))}const _=(0,i.memo)(S);function T(e,t,n){const r=[],o=n?7:4;for(let a=0;a<e.length;a+=o)r.push({level:0,label:n?t[e[a+6]]:t[e[a+3]],offset:e[a],val:e[a+1],self:e[a+2],selfRight:n?e[a+5]:0,valRight:n?e[a+4]:0,valTotal:n?e[a+1]+e[a+4]:e[a+1],offsetRight:n?e[a+3]:0,offsetTotal:n?e[a]+e[a+3]:e[a],children:[]});return r}function x({profile:e,diff:t,vertical:n,enableFlameGraphDotComExport:c,collapsedFlamegraphs:s,getExtraContextMenuButtons:p}){const{isLight:u}=(0,a.useTheme2)(),f=(0,i.useMemo)((()=>function(e,t,n,o){if(!e.length)return;const a=[];for(let n=0;n<e.length;n++){a[n]=[];for(const r of T(e[n],t,o))if(r.level=n,a[n].push(r),n>0){const e=a[n].slice(0,-1).reduce(((e,t)=>t.offsetTotal+t.valTotal+e),0)+r.offsetTotal,t=a[n-1];let o=0;for(const n of t){const t=o+n.offsetTotal,a=t+n.valTotal;if(t<=e&&a>e){n.children.push(r);break}o+=n.offsetTotal+n.valTotal}}}const i=[a[0][0]],l=[],c=[],s=[],p=[],u=[],f=[];for(;i.length;){const e=i.shift();l.push(e.label),c.push(e.level),s.push(e.self),p.push(e.val),u.push(e.selfRight),f.push(e.valRight),i.unshift(...e.children)}let m="short";switch(n){case"samples":case"trace_samples":case"lock_nanoseconds":case"nanoseconds":m="ns";break;case"bytes":m="bytes"}const d=[{name:"level",values:c},{name:"label",values:l,type:r.FieldType.string},{name:"self",values:s,config:{unit:m}},{name:"value",values:p,config:{unit:m}}];o&&d.push({name:"selfRight",values:u,config:{unit:m}},{name:"valueRight",values:f,config:{unit:m}});const y={name:"response",meta:{preferredVisualisationType:"flamegraph"},fields:d};return(0,r.createDataFrame)(y)}(e.flamebearer.levels,e.flamebearer.names,e.metadata.units,Boolean(t))),[e,t]);return l().createElement(o.A,{data:f,disableCollapsing:!s,extraHeaderElements:l().createElement(_,{profile:e,enableFlameGraphDotComExport:c}),vertical:n,getTheme:()=>(0,r.createTheme)({colors:{mode:u?"light":"dark"}}),getExtraContextMenuButtons:p,keepFocusOnDataChange:!0})}const C=(0,i.memo)(x)},2673:(e,t,n)=>{n.d(t,{HA:()=>s,jx:()=>c,qq:()=>p});var r=n(7781),o=n(8531),a=n(2096);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function c(e,t){const n=t.reduce(((e,t,n)=>l(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){i(e,t,n[t])}))}return e}({},e),{[`info${n+1}`]:t})),{handheldBy:"displayError"});a.v.error(e,n),(0,o.getAppEvents)().publish({type:r.AppEvents.alertError.name,payload:t})}function s(e){a.v.warn(e),(0,o.getAppEvents)().publish({type:r.AppEvents.alertWarning.name,payload:e})}function p(e){(0,o.getAppEvents)().publish({type:r.AppEvents.alertSuccess.name,payload:e})}},7907:(e,t,n)=>{n.d(t,{r:()=>s});var r=n(8531),o=n(4137),a=n(5176);const i=o.bw.EXPLORE.slice(1);function l(){const{pathname:e}=new URL(window.location.toString());return e.split("/").pop()||""}function c(){const e={appRelease:r.config.apps[o.R2].version,appVersion:a.t,page:l()};return e.page===i&&(e.view=new URLSearchParams(window.location.search).get("explorationType")||""),e}function s(e,t){(0,r.reportInteraction)(e,{props:t,meta:c()})}},4776:(e,t,n)=>{n.d(t,{f:()=>a});var r=n(7907),o=n(5959);function a(e){const[t,n]=(0,o.useState)(!1);(0,o.useEffect)((()=>{t||(n(!0),(0,r.r)("g_pyroscope_app_page_initialized",{page:e}))}),[e,t])}}}]);
//# sourceMappingURL=702.js.map