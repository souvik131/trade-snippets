"use strict";(self.webpackChunkgrafana_pyroscope_app=self.webpackChunkgrafana_pyroscope_app||[]).push([[75],{7746:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ec});var r=n(4776),o=n(5959),a=n.n(o),i=n(6089),s=n(6356),l=n(2007),c=n(2673);function u(){history.pushState(null,"")}var d,p,m,f=n(7907),h=n(7781),g=n(897),y=n(2096),b=n(3241);class v extends h.BusEventWithPayload{}m="timeseries-data-received",(p="type")in(d=v)?Object.defineProperty(d,p,{value:m,enumerable:!0,configurable:!0,writable:!0}):d[p]=m;var E=function(e){return e.partial="partial",e["attribute-operator-value"]="attribute-operator-value",e["attribute-operator"]="attribute-operator",e}({}),S=function(e){return e["="]="=",e["!="]="!=",e.in="in",e["not-in"]="not-in",e["is-empty"]="is-empty",e["=~"]="=~",e["!~"]="!~",e}({}),w=function(e){return e.attribute="attribute",e.operator="operator",e.value="value",e}({}),O=function(e){return e.attribute="attribute",e.operator="operator",e.value="value",e}({});var x=n(1015),T=n(7268),P=n(8987),C=n(9221),k=n(8531),A=n(9090);class j extends A.Q{constructor(e){var t;const{dataSourceUid:n}=e;let{appSubUrl:r="",bootData:o}=k.config;"/"!==(null==r?void 0:r.at(-1))&&(r+="/"),super(`${r}api/datasources/proxy/uid/${n}`,{"content-type":"application/json","X-Grafana-Org-Id":String((null==o||null===(t=o.user)||void 0===t?void 0:t.orgId)||"")}),function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(this,"dataSourceUid",void 0),this.dataSourceUid=e.dataSourceUid}}function N(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function _(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){N(a,r,o,i,s,"next",e)}function s(e){N(a,r,o,i,s,"throw",e)}i(void 0)}))}}class I extends j{static queryToMatchers(e){const t=e.indexOf("{");if(t>0){return[`{__profile_type__="${e.substring(0,t)}", ${e.substring(t+1,e.length)}`]}return 0===t?[e]:[`{__profile_type__="${e}"}`]}fetchLabels(e,t,n){var r=this;return _((function*(){return r._post("/querier.v1.QuerierService/LabelNames",{matchers:I.queryToMatchers(e),start:t,end:n}).then((e=>e.json()))}))()}fetchLabelValues(e,t,n,r){var o=this;return _((function*(){return o._post("/querier.v1.QuerierService/LabelValues",{name:e,matchers:I.queryToMatchers(t),start:n,end:r}).then((e=>e.json()))}))()}_post(e,t){return super.fetch(e,{method:"POST",body:JSON.stringify(t)})}constructor(e){super(e)}}class R{static buildCacheKey(e){let t="";for(const n of e)t+=String(n);return t}get(e){return this.store.get(R.buildCacheKey(e))}set(e,t){this.store.set(R.buildCacheKey(e),t)}delete(e){this.store.delete(R.buildCacheKey(e))}constructor(){!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(this,"store",new Map)}}function L(e,t){if(!e)throw new Error(t)}function D(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class F{setApiClient(e){this.apiClient=e}setCacheClient(e){this.cacheClient=e}cancel(e){this.apiClient.abort(e)}constructor(e){D(this,"apiClient",void 0),D(this,"cacheClient",void 0),this.apiClient=e.apiClient,this.cacheClient=null==e?void 0:e.cacheClient}}var $=n(5656);function B(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function M(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){B(a,r,o,i,s,"next",e)}function s(e){B(a,r,o,i,s,"throw",e)}i(void 0)}))}}class U extends $.O{static queryToMatchers(e){const t=e.indexOf("{");if(t>0){return[`{__profile_type__="${e.substring(0,t)}", ${e.substring(t+1,e.length)}`]}return 0===t?[e]:[`{__profile_type__="${e}"}`]}fetchLabels(e,t,n){var r=this;return M((function*(){return r._post("/querier.v1.QuerierService/LabelNames",{matchers:U.queryToMatchers(e),start:t,end:n}).then((e=>e.json()))}))()}fetchLabelValues(e,t,n,r){var o=this;return M((function*(){return o._post("/querier.v1.QuerierService/LabelValues",{name:e,matchers:U.queryToMatchers(t),start:n,end:r}).then((e=>e.json()))}))()}_post(e,t){return super.fetch(e,{method:"POST",body:JSON.stringify(t)})}}function V(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function q(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){V(a,r,o,i,s,"next",e)}function s(e){V(a,r,o,i,s,"throw",e)}i(void 0)}))}}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class K extends F{static parseLabelsResponse(e){if(!Array.isArray(e.names))return[];return Array.from(new Set(e.names.filter(K.isNotMetaLabelOrServiceName))).map((e=>({value:e,label:e})))}static parseLabelValuesResponse(e){if(!Array.isArray(e.names))return[];return e.names.map((e=>({value:e,label:e})))}static assertParams(e,t,n){L(Boolean(e),'Missing "query" parameter!'),L(t>0&&n>0&&n>t,"Invalid timerange!")}listLabels({query:e,from:t,to:n}){var r=this;return q((function*(){K.assertParams(e,t,n);const o=[r.apiClient.baseUrl,e,t,n],a=r.cacheClient.get(o);if(a){const e=yield a,t=K.parseLabelsResponse(e);return t.length||r.cacheClient.delete(o),t}const i=r.apiClient.fetchLabels(e,t,n);r.cacheClient.set(o,i);try{const e=yield i;return K.parseLabelsResponse(e)}catch(e){throw r.cacheClient.delete(o),e}}))()}listLabelValues({label:e,query:t,from:n,to:r}){var o=this;return q((function*(){K.assertParams(t,n,r),L(Boolean(e),"Missing label value!");const a=[o.apiClient.baseUrl,e,t,n,r],i=o.cacheClient.get(a);if(i){const e=yield i,t=K.parseLabelsResponse(e);return t.length||o.cacheClient.delete(a),t}const s=o.apiClient.fetchLabelValues(e,t,n,r);o.cacheClient.set(a,s);try{const e=yield s;return K.parseLabelValuesResponse(e)}catch(e){throw o.cacheClient.delete(a),e}}))()}constructor(e){super({apiClient:e.apiClient}),G(this,"cacheClient",void 0),this.cacheClient=e.cacheClient}}G(K,"isNotMetaLabelOrServiceName",(e=>!/^(__.+__|service_name)$/.test(e)));const H=new K({apiClient:new U,cacheClient:new R});function z(e,t){const n=e.filter((({type:e})=>e!==E.partial)),r=t.filter((({type:e})=>e!==E.partial));return n.length===r.length&&n.every((e=>r.find((({type:t,attribute:n,operator:r,value:o})=>{var a,i;return t===e.type&&n.value===e.attribute.value&&(null==r?void 0:r.value)===(null===(a=e.operator)||void 0===a?void 0:a.value)&&(null==o?void 0:o.value)===(null===(i=e.value)||void 0===i?void 0:i.value)}))))}function Y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Q={type:E["attribute-operator"],operator:{value:S["is-empty"],label:"is empty"},value:{value:S["is-empty"],label:""}},W=e=>function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Y(e,t,n[t])}))}return e}({},e,Q);function J(e,t){const n=t.filter((({type:e})=>e!==E.partial)).map((e=>{const{attribute:t,operator:n,value:r}=e;switch(n.value){case S.in:return`${t.value}=~"${r.value}"`;case S["not-in"]:return`${t.value}!~"${r.value}"`;case S["is-empty"]:return`${t.value}=""`;default:return`${t.value}${n.value}"${r.value}"`}}));var r;const[,o]=null!==(r=e.match(/{.*(service_name="[^"]*").*}/))&&void 0!==r?r:[];return o&&n.unshift(o),e.replace(/{(.*)}$/,`{${n.join(",")}}`)}const X=e=>e.at(-1)||null,Z=e=>e===S.in||e===S["not-in"],ee=e=>(L(Boolean(e),"The filter is falsy!"),e.type===E.partial);function te(e,t){return e!==t&&(t!==S["is-empty"]&&([S["=~"],S["!~"],S.in,S["not-in"],S["is-empty"]].includes(e)||[S["=~"],S["!~"],S.in,S["not-in"]].includes(t)))}function ne(e,t){L(void 0!==e.operator,"No operator for the filter under edition!");return te(e.operator.value,t)}function re(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function oe(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const ae=e=>{const t=e.matchAll(/(\w+)(=|!=|=~|!~)"([^"]*)"/g);return Array.from(t).map((([,e,t,n])=>[e,t,n]))},ie=/.+:[^{]+\{(.+)\}$/,se=/.*(\^|\$|\*|\+|\{|\}|\?).*/;function le(e){if(!e)return[];const t=e.match(ie);if(!t)return[];return ae(t[1]).filter((([e])=>"service_name"!==e)).map((([e,t,n])=>{const r={id:(0,P.Ak)(10),type:E["attribute-operator-value"],active:!0,attribute:{value:e,label:e},operator:{value:t,label:t},value:{value:n,label:n}};if(t===S["="]&&""===n)return W(r);return[S["=~"],S["!~"]].includes(t)&&!se.test(n)?oe(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){re(e,t,n[t])}))}return e}({},r),{operator:t===S["=~"]?{value:S.in,label:"in"}:{value:S["not-in"],label:"not in"},value:{value:n,label:n.split("|").map((e=>e.trim())).join(", ")}}):r}))}function ce(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ue(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const de=(e,t)=>e.map((e=>e.type!==E.partial?ue(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){ce(e,t,n[t])}))}return e}({},e),{active:t}):e));function pe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function me(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){pe(e,t,n[t])}))}return e}function fe(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function he(e,t){const n=z(e,le(t.inputParams.query));return{filters:n?de(e,!0):e,query:J(t.query,e),isQueryUpToDate:n}}const ge={cancelAllLoad:()=>{H.cancel("Discarded by user")},setFilterAttribute:(0,C.kp)(((e,t)=>{const n=[...e.filters,{id:(0,P.Ak)(10),type:E.partial,active:!1,attribute:t.data}];return fe(me({},e),{filters:n,isQueryUpToDate:z(n,le(e.inputParams.query))})})),editFilterAttribute:(0,C.kp)(((e,t)=>{if(null===e.edition)throw new Error("Cannot edit filter attribute without edition data!");const{filterId:n}=e.edition,r=e.filters.map((e=>e.id===n?fe(me({},e),{attribute:t.data,operator:void 0,value:void 0}):e));return fe(me({},e),{filters:r,isQueryUpToDate:z(r,le(e.inputParams.query)),edition:null})})),setFilterOperator:(0,C.kp)(((e,t)=>{const n=e.filters.map((e=>{if(!ee(e))return e;const n=t.data;return n.value===S["is-empty"]?W(e):fe(me({},e),{operator:n,value:void 0})}));return me({},e,he(n,e))})),editFilterOperator:(0,C.kp)(((e,t)=>{if(null===e.edition)throw new Error("Cannot edit filter operator without edition data!");const{filterId:n}=e.edition,r=t.data;let o=null;const a=e.filters.map((t=>{const a=t.operator.value;return t.id!==n||a===r.value?t:r.value===S["is-empty"]?W(fe(me({},t),{active:!1})):(a===S["is-empty"]&&(t.value={value:"(no value)",label:"(no value)"}),!ee(t)&&te(a,r.value)&&(o=fe(me({},e.edition),{part:w.value})),fe(me({},t),{operator:r,value:Z(a)&&!Z(r.value)&&t.value?{value:t.value.value.split("|").shift(),label:t.value.label.split(", ").shift()}:t.value,active:!1}))}));return fe(me({},e,he(a,e)),{edition:o})})),setFilterValue:(0,C.kp)(((e,t)=>{const n=e.filters.map((e=>ee(e)?fe(me({},e),{type:E["attribute-operator-value"],active:!1,value:t.data}):e));return me({},e,he(n,e))})),editFilterValue:(0,C.kp)(((e,t)=>{if(null===e.edition)throw new Error("Cannot edit filter value without edition data!");const{filterId:n}=e.edition,r=e.filters.map((e=>e.id===n?fe(me({},e),{type:E["attribute-operator-value"],active:!1,value:t.data}):e));return fe(me({},e,he(r,e)),{edition:null})})),removeFilter:(0,C.kp)(((e,t)=>{const n=t.data,r=de(e.filters.filter((({id:e})=>e!==n)),!1);return me({},e,he(r,e))})),removeLastFilter:(0,C.kp)((e=>{const{filters:t}=e,n=X(t);if(!n)return e;if(ee(n)&&n.operator){const r=t.slice(0,t.length-1).concat(fe(me({},n),{operator:void 0}));return fe(me({},e),{filters:r,isQueryUpToDate:!0})}const r=t.slice(0,t.length-1).map((e=>fe(me({},e),{active:!1})));return me({},e,he(r,e))})),setEdition:(0,C.kp)({edition:(e,t)=>t.data}),changeInputParams:(0,C.kp)(((e,t)=>(t.data.dataSourceUid&&H.setApiClient(new I({dataSourceUid:t.data.dataSourceUid})),{inputParams:t.data,query:t.data.query,filters:le(t.data.query),isQueryUpToDate:!0}))),activateFilters:(0,C.kp)((e=>me({},e,he(e.filters,e))))};function ye(e){const{edition:t,filters:n}=e;L(null!==t,'"edition" is null!');const r=n.find((({id:e})=>e===t.filterId));return L(void 0!==r,"Cannot find the filter under edition!"),r}const be={shouldSuggestAttributes:e=>{const t=X(e.filters);return!t||!ee(t)},shouldSuggestOperators:e=>{var t;return!(null===(t=X(e.filters))||void 0===t?void 0:t.operator)},shouldSuggestValues:e=>{const t=X(e.filters);return Boolean((null==t?void 0:t.operator)&&!(null==t?void 0:t.value))},isEditing:e=>null!==e.edition,shouldSuggestValuesAfterOperatorEdition:(e,t)=>!!e.edition&&ne(ye(e),t.data.value),shouldNotSuggestValuesAfterOperatorEdition:(e,t)=>!!e.edition&&!ne(ye(e),t.data.value),hasPartialFilter:e=>{const t=X(e.filters);return Boolean(t&&ee(t))},shouldEditAttribute:(e,t)=>t.data.part===w.attribute,shouldEditOperator:(e,t)=>t.data.part===w.operator,shouldEditValue:(e,t)=>t.data.part===w.value};function ve(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}const Ee=new class{list(){return(e=function*(){return[{value:"=",label:"="},{value:"!=",label:"!="},{value:"is-empty",label:"is empty"},{value:"in",label:"in",description:"Is one of"},{value:"not-in",label:"not in",description:"Is not one of"},{value:"=~",label:"=~",description:"Matches regex"},{value:"!~",label:"!~",description:"Does not match regex"}]},function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){ve(a,r,o,i,s,"next",e)}function s(e){ve(a,r,o,i,s,"throw",e)}i(void 0)}))})();var e}},Se=e=>e.startsWith("__");function we(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Oe(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){we(a,r,o,i,s,"next",e)}function s(e){we(a,r,o,i,s,"throw",e)}i(void 0)}))}}function xe(e,t){if(e instanceof DOMException&&"AbortError"===e.name)return[];throw y.v.error(e,{info:t}),e}const Te={fetchLabels:function(){var e=Oe((function*(e){const{from:t,to:n}=e.inputParams;try{const r=yield H.listLabels({query:e.query,from:t,to:n}),o=[],a=[];return r.forEach((e=>{Se(e.value)?a.push(e):o.push(e)})),[...o,...a]}catch(e){return xe(e,"Error while fetching labels!")}}));return function(t){return e.apply(this,arguments)}}(),fetchOperators:Oe((function*(){try{return yield Ee.list()}catch(e){return xe(e,"Error while fetching operators!")}})),fetchLabelValues:function(){var e=Oe((function*(e){let t,{query:n,edition:r,suggestions:o}=e;try{if(r){const o=e.filters.filter((e=>e.id!==r.filterId||(t=e,!1)));if(!t)throw new Error(`Impossible to edit filter id="${r.filterId}": no filter found!`);n=J(n,o)}else if(t=X(e.filters),(null==t?void 0:t.type)!==E.partial)throw new Error("Impossible to load label values: no partial filter found!");if(o.disabled)return[];const a=t.attribute.value,{from:i,to:s}=e.inputParams;return yield H.listLabelValues({label:a,query:n,from:i,to:s})}catch(e){return xe(e,"Error while fetching label values!")}}));return function(t){return e.apply(this,arguments)}}()},Pe={always:[{cond:"shouldSuggestOperators",target:"loadOperators"},{cond:"shouldSuggestValues",target:"loadLabelValues"},{target:"idle"}]},Ce={FILTER_ADD:"Filter by label values...",SELECT_LABEL:"Select a label...",SELECT_OPERATOR:"Select an operator...",SELECT_VALUE:"Select a value...",SELECT_VALUES:"Select values...",TYPE_VALUE:"Type a regex...",LOADING:"Loading...",ERROR_LOAD:"An unexpected error occurred while loading! Please try again.",SUGGESTIONS_NONE:"No suggestions available.",SUGGESTIONS_DISABLED:"Suggestions are disabled for this label."},ke=e=>e===S["=~"]||e===S["!~"];function Ae(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function je(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Ne={entry:["cancelAllLoad",(0,C.kp)({suggestions:e=>{let t=Ce.FILTER_ADD,n=!1;const r=X(e.filters);return r&&ee(r)&&(r.operator?(n=ke(r.operator.value),t=Z(r.operator.value)?Ce.SELECT_VALUES:n?Ce.TYPE_VALUE:Ce.SELECT_VALUE):t=Ce.SELECT_OPERATOR),je(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Ae(e,t,n[t])}))}return e}({},Qe.suggestions),{placeholder:t,allowCustomValue:n})},edition:null})],on:{START_INPUT:[{cond:"shouldSuggestAttributes",target:"loadLabels"},{cond:"shouldSuggestOperators",target:"loadOperators"},{cond:"shouldSuggestValues",target:"loadLabelValues"}],EDIT_FILTER:[{cond:"shouldEditAttribute",target:"loadLabels",actions:["setEdition"]},{cond:"shouldEditOperator",target:"loadOperators",actions:["setEdition"]},{cond:"shouldEditValue",target:"loadLabelValues",actions:["setEdition"]}],REMOVE_FILTER:[{cond:"hasPartialFilter",target:"autoSuggestProxy",actions:["removeFilter"]},{target:"idle",actions:["removeFilter"]}],REMOVE_LAST_FILTER:{target:"idle",actions:["removeLastFilter"]},CHANGE_INPUT_PARAMS:{target:"idle",actions:["changeInputParams"]},EXECUTE_QUERY:{target:"idle",actions:["activateFilters"]}}};function _e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ie(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){_e(e,t,n[t])}))}return e}function Re(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Le={entry:(0,C.kp)({suggestions:()=>Re(Ie({},Qe.suggestions),{isVisible:!0,isLoading:!0})}),invoke:{id:"fetchLabels",src:"fetchLabels",onDone:{target:"displayLabels",actions:(0,C.kp)({suggestions:(e,t)=>Re(Ie({},e.suggestions),{items:t.data.filter((({value:t})=>!e.filters.some((e=>{var n;return(null===(n=e.attribute)||void 0===n?void 0:n.value)===t})))),isLoading:!1})})},onError:{target:"displayLabels",actions:(0,C.kp)({suggestions:(e,t)=>Re(Ie({},e.suggestions),{isLoading:!1,error:t.data})})}},on:{DISCARD_SUGGESTIONS:"idle"}},De={entry:(0,C.kp)({suggestions:e=>Re(Ie({},e.suggestions),{type:O.attribute,isVisible:!0,placeholder:Ce.SELECT_LABEL})}),on:{DISCARD_SUGGESTIONS:"idle",SELECT_SUGGESTION:[{cond:"isEditing",target:"loadOperators",actions:["editFilterAttribute"]},{target:"loadOperators",actions:["setFilterAttribute"]}],REMOVE_LAST_FILTER:{target:"idle",actions:["removeLastFilter"]}}};function Fe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function $e(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Fe(e,t,n[t])}))}return e}function Be(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Me={entry:(0,C.kp)({suggestions:e=>{const t=e.edition?ye(e):X(e.filters);return L(void 0!==typeof(null==t?void 0:t.operator),"No operator for the target filter!"),Be($e({},Qe.suggestions),{disabled:["=~","!~"].includes(t.operator.value)||Se(t.attribute.value),isVisible:!0,isLoading:!0})}}),invoke:{id:"fetchLabelValues",src:"fetchLabelValues",onDone:{target:"displayLabelValues",actions:(0,C.kp)({suggestions:(e,t)=>Be($e({},e.suggestions),{items:t.data,isLoading:!1})})},onError:{target:"displayLabelValues",actions:(0,C.kp)({suggestions:(e,t)=>Be($e({},e.suggestions),{items:[],isLoading:!1,error:t.data})})}},on:{DISCARD_SUGGESTIONS:"idle"}},Ue={entry:(0,C.kp)({suggestions:e=>{const t=e.edition?ye(e):X(e.filters);L(void 0!==typeof(null==t?void 0:t.operator),"No operator for the target filter!");const n=t.operator.value,r=ke(n)||e.suggestions.disabled,o=Z(n);let a,i;return a=r?Ce.TYPE_VALUE:o?Ce.SELECT_VALUES:Ce.SELECT_VALUE,i=e.suggestions.error?Ce.ERROR_LOAD:e.suggestions.disabled?Ce.SUGGESTIONS_DISABLED:Ce.SUGGESTIONS_NONE,Be($e({},e.suggestions),{type:O.value,isVisible:!0,placeholder:a,noOptionsMessage:i,allowCustomValue:r,multiple:o})}}),on:{DISCARD_SUGGESTIONS:"idle",SELECT_SUGGESTION:[{cond:"isEditing",target:"autoSuggestProxy",actions:["editFilterValue"]},{target:"idle",actions:["setFilterValue"]}],REMOVE_LAST_FILTER:{target:"loadOperators",actions:["removeLastFilter"]}}};function Ve(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function qe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Ve(e,t,n[t])}))}return e}function Ge(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Ke={entry:(0,C.kp)({suggestions:()=>Ge(qe({},Qe.suggestions),{isVisible:!0,isLoading:!0})}),invoke:{id:"fetchOperators",src:"fetchOperators",onDone:{target:"displayOperators",actions:(0,C.kp)({suggestions:(e,t)=>Ge(qe({},e.suggestions),{items:t.data,isLoading:!1})})},onError:{target:"displayOperators",actions:(0,C.kp)({suggestions:(e,t)=>Ge(qe({},e.suggestions),{items:[],isLoading:!1,error:t.data})})}},on:{DISCARD_SUGGESTIONS:"idle"}},He={entry:(0,C.kp)({suggestions:e=>Ge(qe({},e.suggestions),{type:O.operator,isVisible:!0,placeholder:Ce.SELECT_OPERATOR,allowCustomValue:!1,multiple:!1})}),on:{DISCARD_SUGGESTIONS:"idle",SELECT_SUGGESTION:[{cond:"shouldSuggestValuesAfterOperatorEdition",target:"loadLabelValues",actions:["editFilterOperator"]},{cond:"shouldNotSuggestValuesAfterOperatorEdition",target:"autoSuggestProxy",actions:["editFilterOperator"]},{cond:"hasPartialFilter",target:"autoSuggestProxy",actions:["setFilterOperator"]},{target:"loadLabelValues",actions:["setFilterOperator"]}],REMOVE_LAST_FILTER:{target:"loadLabels",actions:["removeLastFilter"]}}};function ze(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ye(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Qe=Object.freeze({inputParams:{query:"",from:0,to:0},query:"",filters:[],isQueryUpToDate:!0,edition:null,suggestions:{type:null,items:[],isVisible:!1,isLoading:!1,error:null,placeholder:"",noOptionsMessage:"",allowCustomValue:!1,multiple:!1,disabled:!1}}),We=e=>({id:"query-builder",initial:"idle",context:e,predictableActionArguments:!0,states:{idle:Ne,loadLabels:Le,displayLabels:De,loadOperators:Ke,displayOperators:He,loadLabelValues:Me,displayLabelValues:Ue,autoSuggestProxy:Pe}}),Je={guards:be,services:Te,actions:ge};function Xe(e){const{query:t}=e,n=Ye(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){ze(e,t,n[t])}))}return e}({},Qe),{inputParams:e,query:t,filters:le(t)}),r=(0,x.O)(We(n),Je);return{actor:(0,T.U4)(r),initialContext:n}}const Ze=new Intl.Collator("en",{sensitivity:"case"}).compare,et=e=>(t,n)=>{const r=e.some((e=>e.value===t.value)),o=e.some((e=>e.value===n.value));return r&&o?Ze(t.value,n.value):o?1:r?-1:0};function tt({selection:e,suggestions:t,onCloseMenu:n}){const r=(0,l.useStyles2)(nt),i=(0,o.useMemo)((()=>{const t=e.value.split("|"),n=e.label.split(", ");return t.map(((e,t)=>({value:e,label:n[t]})))}),[e]),[s,c]=(0,o.useState)(i),u=(0,o.useMemo)((()=>t.items.sort(et(s))),[t.items]),d=(0,o.useCallback)((e=>{c(e.map((({value:e="",label:t=""})=>({value:e,label:t}))))}),[]),p=(0,o.useCallback)((()=>{n(s)}),[n,s]);return a().createElement(l.MultiSelect,{className:r.editionSelect,placeholder:t.placeholder,loadingMessage:Ce.LOADING,closeMenuOnSelect:!1,hideSelectedOptions:!1,backspaceRemovesValue:!0,autoFocus:!0,value:s,onChange:d,onCloseMenu:p,options:u,isOpen:!0,isLoading:t.isLoading,invalid:Boolean(t.error),noOptionsMessage:t.noOptionsMessage})}const nt=()=>({editionSelect:i.css`
    position: absolute;
    z-index: 1;

    [aria-label='Remove'] svg {
      display: none;
    }
  `});function rt({placeholder:e,defaultValue:t,onFocus:n,onChange:r,onBlur:s}){const c=(0,l.useStyles2)(ot),u=(0,o.useRef)(null),[d,p]=(0,o.useState)(!1);return(0,o.useEffect)((()=>{u.current&&u.current.focus()}),[]),a().createElement(l.Input,{ref:u,className:(0,i.cx)(t&&c.edition),invalid:d,placeholder:e,defaultValue:t,onFocus:n,onKeyUp:e=>{const t=e.target.value.trim();"Enter"===e.code&&(t?r({value:t,label:t}):p(!0))},onBlur:e=>{const t=e.target.value.trim();t?r({value:t,label:t}):s()}})}const ot=()=>({edition:i.css`
    position: absolute;
    z-index: 1;
  `}),at=()=>({editionSelect:i.css`
    position: absolute;
    z-index: 1;
    min-width: 160px;
    box-shadow: none;

    & input:focus {
      outline: none !important;
    }
  `});function it({selection:e,suggestions:t,onChange:n,onCloseMenu:r}){const o=(0,l.useStyles2)(at);return t.allowCustomValue?a().createElement(rt,{defaultValue:e.value,placeholder:t.placeholder,onChange:n,onBlur:r}):a().createElement(l.Select,{className:o.editionSelect,placeholder:t.placeholder,loadingMessage:Ce.LOADING,closeMenuOnSelect:!1,autoFocus:!0,value:e.value,onChange:n,onCloseMenu:r,options:t.items,isOpen:!0,isLoading:t.isLoading,invalid:Boolean(t.error),noOptionsMessage:t.noOptionsMessage})}const st=()=>{},lt=({filter:e,onClick:t,onRemove:n})=>{const r=(0,l.useStyles2)(ft),{attribute:o,operator:s,active:c}=e,u=c?r.chiclet:(0,i.cx)(r.chiclet,r.inactiveChiclet);return a().createElement("div",{className:u,"aria-label":"Filter"},a().createElement(l.Tag,{"aria-label":"Filter label",className:r.chicletAttribute,name:o.label,onClick:st}),a().createElement(l.Tag,{"aria-label":"Filter operator",className:r.chicletOperator,name:s.label,onClick:(n,r)=>t(r,e,w.operator),tabIndex:0}),a().createElement(l.Tag,{"aria-label":"Remove filter",className:r.chicletRemoveButton,icon:"times",name:"",onClick:(t,r)=>n(r,e),tabIndex:0}))},ct=()=>{},ut=({filter:e,onClick:t,onRemove:n})=>{const r=(0,l.useStyles2)(ft),{attribute:o,operator:s,value:c,active:u}=e,d=u?r.chiclet:(0,i.cx)(r.chiclet,r.inactiveChiclet);return a().createElement("div",{className:d,"aria-label":"Filter"},a().createElement(l.Tag,{"aria-label":"Filter label",className:r.chicletAttribute,name:o.label,onClick:ct}),a().createElement(l.Tag,{"aria-label":"Filter operator",className:r.chicletOperator,name:s.label,onClick:(n,r)=>t(r,e,w.operator),tabIndex:0}),a().createElement(l.Tooltip,{content:c.label},a().createElement(l.Tag,{"aria-label":"Filter value",name:c.label,className:r.chicletValue,onClick:(n,r)=>t(r,e,w.value),tabIndex:0})),a().createElement(l.Tag,{"aria-label":"Remove filter",className:r.chicletRemoveButton,icon:"times",name:"",onClick:(t,r)=>n(r,e),tabIndex:0}))},dt=({filter:e,onClick:t})=>{const n=(0,l.useStyles2)(ft),{attribute:r,operator:o}=e;return r||o?a().createElement("div",{className:(0,i.cx)(n.chiclet,n.partialChiclet),"aria-label":"Partial filter"},a().createElement(l.Tag,{colorIndex:9,name:r.label,title:`Edit "${r.label}"`,onClick:(n,r)=>t(r,e,w.attribute),tabIndex:0}),o&&a().createElement(l.Tag,{colorIndex:9,name:o.label,title:`Edit "${o.label}"`,className:n.chicletOperator,onClick:(n,r)=>t(r,e,w.operator),tabIndex:0})):null},pt="rgb(61, 113, 217)",mt="#4a4b52",ft=e=>({chiclet:i.css`
    display: flex;
    align-items: center;
    border: 1px solid ${pt};
    border-radius: 2px;

    & > button {
      height: 30px;
      background-color: ${e.colors.background.primary};
      color: ${e.colors.text.maxContrast};
    }

    & > :first-child {
      background-color: ${pt};
      color: ${"#fff"};
      border-radius: 0;

      &:hover {
        cursor: not-allowed !important;
      }
    }

    & > :last-child {
      border-left: 1px solid ${pt};
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
  `,partialChiclet:i.css`
    border-color: ${mt};
    border-right: 0;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;

    & > :first-child {
      background-color: ${e.colors.background.secondary};
      color: ${e.colors.text.maxContrast};
      border-radius: 0;
      border-left: 0;

      &:hover {
        cursor: pointer !important;
      }
    }

    & > :last-child {
      border-color: ${mt};
      color: ${e.colors.text.maxContrast};
    }
  `,inactiveChiclet:i.css`
    border-color: ${mt};

    & > button {
      color: ${e.colors.text.maxContrast};
    }

    & > :first-child {
      background-color: ${e.colors.background.secondary};
      color: ${e.colors.text.maxContrast};
    }

    & > :last-child {
      border-color: ${mt};
    }
  `,chicletAttribute:i.css`
    &:hover {
      opacity: 1 !important;
    }
  `,chicletOperator:i.css`
    &:hover {
      background-color: ${e.colors.background.secondary};
    }
  `,chicletValue:i.css`
    flex-grow: 1;
    text-align: left;
    max-width: 420px;
    text-overflow: ellipsis;
    text-wrap: nowrap;
    overflow: hidden;

    &:hover {
      background-color: ${e.colors.background.secondary};
    }
  `,chicletRemoveButton:i.css`
    &:hover {
      background-color: ${e.colors.background.secondary};
    }

    & svg {
      width: 12px;
      height: 12px;
    }
  `}),ht=({filter:e,onClick:t,onRemove:n})=>{switch(e.type){case E.partial:return a().createElement(dt,{filter:e,onClick:t});case E["attribute-operator-value"]:return a().createElement(ut,{filter:e,onClick:t,onRemove:n});case E["attribute-operator"]:return a().createElement(lt,{filter:e,onClick:t,onRemove:n});default:throw new TypeError(`Unsupported filter type "${e.type}" (${JSON.stringify(e)})!`)}},gt=(0,o.memo)(ht,((e,t)=>JSON.stringify(e.filter)===JSON.stringify(t.filter))),yt=()=>({chicletsList:i.css`
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 4px;
  `,editChicletContainer:i.css`
    position: relative;
  `});function bt({filters:e,onClickChiclet:t,onRemoveChiclet:n,edition:r,suggestions:o,onChangeSingleSuggestion:i,onCloseSingleSuggestionsMenu:s,onCloseMultipleSuggestionsMenu:c}){const u=(0,l.useStyles2)(yt);return a().createElement("div",{className:u.chicletsList,"data-testid":"filtersList"},e.map((e=>a().createElement("div",{key:e.id,className:u.editChicletContainer},a().createElement(gt,{filter:e,onClick:t,onRemove:n}),(null==r?void 0:r.filterId)===e.id?o.multiple?a().createElement(tt,{selection:e[r.part],suggestions:o,onCloseMenu:c}):a().createElement(it,{key:r.part,selection:e[r.part],suggestions:o,onChange:i,onCloseMenu:s}):null))))}const vt=(0,o.memo)(bt),Et=()=>({select:i.css`
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
  `});function St({suggestions:e,onFocus:t,onChange:n,onKeyDown:r,onCloseMenu:i}){const s=(0,l.useStyles2)(Et),c=function(e){const[t,n]=(0,o.useState)(!1);return(0,o.useEffect)((()=>{!e||t?e!==t&&n(e):setTimeout((()=>n(!0)),0)}),[t,e]),t}(e.isVisible);return e.allowCustomValue?a().createElement(rt,{placeholder:e.placeholder,onFocus:t,onChange:n,onBlur:i}):a().createElement(l.Select,{className:s.select,placeholder:e.placeholder,loadingMessage:Ce.LOADING,closeMenuOnSelect:!1,value:null,onFocus:t,onKeyDown:r,onChange:n,onCloseMenu:i,options:e.items,isOpen:c,isLoading:e.isLoading,invalid:Boolean(e.error),noOptionsMessage:e.noOptionsMessage})}const wt=()=>{};function Ot(){const e=(0,l.useStyles2)(Et);return a().createElement(l.Select,{disabled:!0,className:e.select,placeholder:Ce.FILTER_ADD,onChange:wt})}function xt({suggestions:e,onFocus:t,onKeyDown:n,onCloseMenu:r}){const i=(0,l.useStyles2)(Tt),[s,c]=(0,o.useState)([]),u=(0,o.useCallback)((e=>{c(e.map((({value:e="",label:t=""})=>({value:e,label:t}))))}),[]),d=(0,o.useCallback)((e=>{n(e,s)}),[n,s]),p=(0,o.useCallback)((()=>{r(s)}),[r,s]);return a().createElement(l.MultiSelect,{className:i.select,placeholder:e.placeholder,loadingMessage:Ce.LOADING,closeMenuOnSelect:!1,hideSelectedOptions:!1,backspaceRemovesValue:!0,autoFocus:!0,value:s,onFocus:t,onKeyDown:d,onChange:u,onCloseMenu:p,options:e.items,isOpen:e.isVisible,isLoading:e.isLoading,invalid:Boolean(e.error),noOptionsMessage:e.noOptionsMessage})}const Tt=()=>({select:i.css`
    [aria-label='Remove'] svg {
      display: none;
    }
  `}),Pt=()=>({queryBuilder:i.css`
    display: flex;
    justify-content: flex-start;
    align-items: flex-end;
    flex-wrap: wrap;
    gap: 4px;
    width: 100%;
  `,controls:i.css`
    display: flex;
    align-self: flex-start;
    flex-grow: 1;
  `,executeButton:i.css`
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  `});function Ct(e){const t=(0,l.useStyles2)(Pt),{actor:n,internalProps:r}=function({dataSourceUid:e,query:t,from:n,to:r,onChangeQuery:a}){const{actor:i,initialContext:s}=(0,o.useMemo)((()=>Xe({query:t,from:n,to:r})),[]);(0,o.useEffect)((()=>{i.send({type:"CHANGE_INPUT_PARAMS",data:{dataSourceUid:e,query:t,from:n,to:r}})}),[i,e,t,n,r]);const[l,c]=(0,o.useState)(s);return(0,o.useEffect)((()=>(i.start(),i.subscribe((({event:e,context:t})=>{"EXECUTE_QUERY"===e.type&&a(t.query,t.filters),c(t)})),()=>{i.stop()})),[i]),{actor:i,internalProps:l}}(e),{filters:s,edition:c,isQueryUpToDate:u,suggestions:d}=r,{onClickChiclet:p,onRemoveChiclet:m}=function(e){const t=(0,o.useCallback)(((t,n,r)=>{e.send({type:"EDIT_FILTER",data:{filterId:n.id,part:r}})}),[e]),n=(0,o.useCallback)(((t,n)=>{e.send({type:"REMOVE_FILTER",data:n.id})}),[e]);return{onClickChiclet:t,onRemoveChiclet:n}}(n),{onFocus:f,onChangeSingleSuggestion:h,onSingleSelectKeyDown:g,onCloseSingleMenu:y,onMultipleSelectKeyDown:b,onCloseMultipleMenu:v}=function(e,t,n){const r=(0,o.useCallback)((()=>{e.send({type:"START_INPUT"})}),[e]),a=(0,o.useCallback)((t=>{const{value:n="",label:r=""}=t;e.send({type:"SELECT_SUGGESTION",data:{value:n,label:r}})}),[e]),i=(0,o.useCallback)((t=>{"Backspace"!==t.code||t.target.value||e.send({type:"REMOVE_LAST_FILTER"})}),[e]),s=(0,o.useCallback)((()=>{e.send({type:"DISCARD_SUGGESTIONS"})}),[e]),l=(0,o.useCallback)(((t,n)=>{"Backspace"!==t.code||t.target.value||n.length||e.send({type:"REMOVE_LAST_FILTER"})}),[e]),c=(0,o.useCallback)((t=>{t.length?e.send({type:"SELECT_SUGGESTION",data:{value:t.map((e=>e.value)).join("|"),label:t.map((e=>e.label)).join(", ")}}):e.send({type:"DISCARD_SUGGESTIONS"})}),[e]),u=function(e){const t=(0,o.useRef)();return(0,o.useEffect)((()=>{t.current=e})),t.current}(t.isVisible);return(0,o.useEffect)((()=>{var e;!t.isVisible&&u&&(null===(e=document.querySelector(`#${n} input`))||void 0===e||e.blur())}),[t.isVisible,u,n]),{onFocus:r,onChangeSingleSuggestion:a,onSingleSelectKeyDown:i,onMultipleSelectKeyDown:l,onCloseSingleMenu:s,onCloseMultipleMenu:c}}(n,d,e.id),E=(0,o.useCallback)((()=>{n.send({type:"EXECUTE_QUERY"})}),[n]);return(0,o.useEffect)((()=>{if(!e.autoExecute)return;const t=({value:e,context:t,event:r})=>{"idle"!==e||t.isQueryUpToDate||"EXECUTE_QUERY"===r.type||n.send({type:"EXECUTE_QUERY"})};return n.onTransition(t),()=>{n.off(t)}}),[n,e.autoExecute]),a().createElement("div",{id:e.id,className:(0,i.cx)(t.queryBuilder,e.className)},s.length>0?a().createElement(vt,{filters:s,onClickChiclet:p,onRemoveChiclet:m,edition:c,suggestions:d,onChangeSingleSuggestion:h,onCloseSingleSuggestionsMenu:y,onCloseMultipleSuggestionsMenu:v}):null,a().createElement("div",{className:t.controls},c?a().createElement(Ot,null):d.multiple?a().createElement(xt,{suggestions:d,onFocus:f,onKeyDown:b,onCloseMenu:v}):a().createElement(St,{suggestions:d,onFocus:f,onChange:h,onKeyDown:g,onCloseMenu:y}),!e.autoExecute&&a().createElement(l.Button,{onClick:E,tooltip:u?"Nothing to execute, all filters applied":"Execute new query",className:t.executeButton,disabled:u},"Execute")))}const kt=(0,o.memo)(Ct),At=JSON.parse('{"block:contentions:count:contentions:count":{"id":"block:contentions:count:contentions:count","description":"Number of blocking contentions","type":"contentions","group":"block","unit":"short"},"block:delay:nanoseconds:contentions:count":{"id":"block:delay:nanoseconds:contentions:count","description":"Time spent in blocking delays","type":"delay","group":"block","unit":"ns"},"goroutine:goroutine:count:goroutine:count":{"id":"goroutine:goroutine:count:goroutine:count","description":"Number of goroutines","type":"goroutine","group":"goroutine","unit":"short"},"goroutines:goroutine:count:goroutine:count":{"id":"goroutines:goroutine:count:goroutine:count","description":"Number of goroutines","type":"goroutine","group":"goroutine","unit":"short"},"memory:alloc_in_new_tlab_bytes:bytes::":{"id":"memory:alloc_in_new_tlab_bytes:bytes::","description":"Size of memory allocated inside Thread-Local Allocation Buffers (TLAB)","type":"alloc_in_new_tlab_bytes","group":"memory","unit":"bytes"},"memory:alloc_in_new_tlab_objects:count::":{"id":"memory:alloc_in_new_tlab_objects:count::","description":"Number of objects allocated inside Thread-Local Allocation Buffers (TLAB)","type":"alloc_in_new_tlab_objects","group":"memory","unit":"short"},"memory:alloc_objects:count:space:bytes":{"id":"memory:alloc_objects:count:space:bytes","description":"Number of objects allocated","type":"alloc_objects","group":"memory","unit":"short"},"memory:alloc_space:bytes:space:bytes":{"id":"memory:alloc_space:bytes:space:bytes","description":"Size of memory allocated in the heap","type":"alloc_space","group":"memory","unit":"bytes"},"memory:inuse_objects:count:space:bytes":{"id":"memory:inuse_objects:count:space:bytes","description":"Number of objects currently in use","type":"inuse_objects","group":"memory","unit":"short"},"memory:inuse_space:bytes:space:bytes":{"id":"memory:inuse_space:bytes:space:bytes","description":"Size of memory currently in use","type":"inuse_space","group":"memory","unit":"bytes"},"mutex:contentions:count:contentions:count":{"id":"mutex:contentions:count:contentions:count","description":"Number of observed mutex contentions","type":"contentions","group":"mutex","unit":"short"},"mutex:delay:nanoseconds:contentions:count":{"id":"mutex:delay:nanoseconds:contentions:count","description":"Time spent waiting due to mutex contentions","type":"delay","group":"mutex","unit":"ns"},"process_cpu:alloc_samples:count:cpu:nanoseconds":{"id":"process_cpu:alloc_samples:count:cpu:nanoseconds","description":"Number of memory allocation samples during CPU time","type":"alloc_samples","group":"memory","unit":"short"},"process_cpu:alloc_size:bytes:cpu:nanoseconds":{"id":"process_cpu:alloc_size:bytes:cpu:nanoseconds","description":"Size of memory allocated during CPU time","type":"alloc_size","group":"alloc_size","unit":"bytes"},"process_cpu:cpu:nanoseconds:cpu:nanoseconds":{"id":"process_cpu:cpu:nanoseconds:cpu:nanoseconds","description":"CPU time consumed","type":"cpu","group":"process_cpu","unit":"ns"},"process_cpu:exception:count:cpu:nanoseconds":{"id":"process_cpu:exception:count:cpu:nanoseconds","description":"Number of exceptions within the sampled CPU time","type":"exceptions","group":"exceptions","unit":"short"},"process_cpu:lock_count:count:cpu:nanoseconds":{"id":"process_cpu:lock_count:count:cpu:nanoseconds","description":"Number of lock acquisitions attempted during CPU time","type":"lock_count","group":"locks","unit":"short"},"process_cpu:lock_time:nanoseconds:cpu:nanoseconds":{"id":"process_cpu:lock_time:nanoseconds:cpu:nanoseconds","description":"Cumulative time spent acquiring locks","type":"lock_time","group":"locks","unit":"ns"},"process_cpu:samples:count::milliseconds":{"id":"process_cpu:samples:count::milliseconds","description":"Number of process samples collected","type":"samples","group":"process_cpu","unit":"short"},"process_cpu:samples:count:cpu:nanoseconds":{"id":"process_cpu:samples:count:cpu:nanoseconds","description":"Number of samples collected over CPU time","type":"samples","group":"process_cpu","unit":"short"}}');function jt(e){if(At[e])return At[e];const[t="?",n="?"]=e?e.split(":"):[];return{id:e,description:"",type:n,group:t,unit:"short"}}var Nt=n(1269);const _t=Object.freeze({type:"grafana-pyroscope-datasource",uid:"$dataSource"}),It=Object.freeze({type:"grafana-pyroscope-series-datasource",uid:"grafana-pyroscope-series-datasource"}),Rt=Object.freeze({type:"grafana-pyroscope-favorites-datasource",uid:"grafana-pyroscope-favorites-datasource"}),Lt=Object.freeze({type:"grafana-pyroscope-labels-datasource",uid:"grafana-pyroscope-labels-datasource"});function Dt(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Ft(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class $t extends s.fS{onActivate(){this.state.value||this.setState({value:$t.DEFAULT_VALUE})}update(e=!1){var t,n=this;return(t=function*(){if(!e&&n.state.loading)return;let t=[],r=null;n.setState({loading:!0,options:[],error:null});try{t=yield(0,Nt.lastValueFrom)(n.getValueOptions({}))}catch(e){r=e}finally{n.setState({loading:!1,options:t,error:r})}},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){Dt(a,r,o,i,s,"next",e)}function s(e){Dt(a,r,o,i,s,"throw",e)}i(void 0)}))})()}static buildCascaderOptions(e){const t=new Map;for(const{value:n}of e){const e=jt(n),{group:r,type:o}=e,a=t.get(r)||{value:r,label:r,items:[]},i=a.items||[];i.push({value:n,label:o}),a.items=i,t.set(r,a)}return Array.from(t.values()).sort(((e,t)=>Ze(t.label,e.label)))}constructor(e){super(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Ft(e,t,n[t])}))}return e}({key:"profileMetricId",name:"profileMetricId",label:"Profile type",datasource:It,query:$t.QUERY_DEFAULT,loading:!0,refresh:h.VariableRefresh.onTimeRangeChanged},e)),Ft(this,"onSelect",(e=>{(0,f.r)("g_pyroscope_app_profile_metric_selected"),this.state.skipUrlSync||u(),this.changeValueTo(e)})),this.changeValueTo=this.changeValueTo.bind(this),this.addActivationHandler(this.onActivate.bind(this))}}Ft($t,"DEFAULT_VALUE","process_cpu:cpu:nanoseconds:cpu:nanoseconds"),Ft($t,"QUERY_DEFAULT","$dataSource and all profile metrics"),Ft($t,"QUERY_SERVICE_NAME_DEPENDENT","$dataSource and only $serviceName profile metrics"),Ft($t,"Component",(({model:e})=>{const t=(0,l.useStyles2)(Bt),{loading:n,value:r,options:i,error:s}=e.useState(),c=(0,o.useMemo)((()=>$t.buildCascaderOptions(i)),[i]);return s?a().createElement(l.Tooltip,{theme:"error",content:s.toString()},a().createElement(l.Icon,{className:t.iconError,name:"exclamation-triangle",size:"xl"})):a().createElement(l.Cascader,{key:(0,P.Ak)(5),"aria-label":"Profile metrics list",width:24,separator:"/",displayAllSelectedLevels:!0,placeholder:n?"Loading...":`Select a profile metric (${i.length})`,options:c,initialValue:r,changeOnSelect:!1,onSelect:e.onSelect})}));const Bt=e=>({iconError:i.css`
    height: 32px;
    align-self: center;
    color: ${e.colors.error.text};
  `});var Mt=n(550);function Ut(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Vt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class qt extends s.fS{onActivate(){const{serviceName:e}=Mt.x.get(Mt.x.KEYS.PROFILES_EXPLORER)||{};e&&!this.state.value&&this.setState({value:e}),this.subscribeToState(((e,t)=>{if(e.value&&e.value!==t.value){const t=Mt.x.get(Mt.x.KEYS.PROFILES_EXPLORER)||{};t.serviceName=e.value,Mt.x.set(Mt.x.KEYS.PROFILES_EXPLORER,t)}}))}update(){var e,t=this;return(e=function*(){if(t.state.loading)return;let e=[],n=null;t.setState({loading:!0,options:[],error:null});try{e=yield(0,Nt.lastValueFrom)(t.getValueOptions({}))}catch(e){n=e}finally{t.setState({loading:!1,options:e,error:n})}},function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Ut(a,r,o,i,s,"next",e)}function s(e){Ut(a,r,o,i,s,"throw",e)}i(void 0)}))})()}constructor(e){super(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Vt(e,t,n[t])}))}return e}({key:"serviceName",name:"serviceName",label:"Service",datasource:It,query:qt.QUERY_DEFAULT,loading:!0,refresh:h.VariableRefresh.onTimeRangeChanged},e)),Vt(this,"selectNewValue",(e=>{(0,f.r)("g_pyroscope_app_service_name_selected"),this.state.skipUrlSync||u(),this.changeValueTo(e)})),this.addActivationHandler(this.onActivate.bind(this))}}Vt(qt,"QUERY_DEFAULT","$dataSource and all services"),Vt(qt,"QUERY_PROFILE_METRIC_DEPENDENT","$dataSource and only $profileMetricId services"),Vt(qt,"Component",(({model:e})=>{const t=(0,l.useStyles2)(Gt),{loading:n,value:r,options:i,error:s}=e.useState(),c=(0,o.useMemo)((()=>function(e){const t=[];for(const n of e){const e=n.split("/");let r;const o=[];let a=t;for(let t=0;t<e.length;t+=1){r=e[t],o.push(r);const n=o.join("/"),i=a.find((e=>e.value===n));if(i)a=i.items;else{const o={value:n,label:r,items:t<e.length-1?[]:void 0};a.push(o),a=o.items||[]}}}return t}(i.map((({label:e})=>e)))),[i]);return s?a().createElement(l.Tooltip,{theme:"error",content:s.toString()},a().createElement(l.Icon,{className:t.iconError,name:"exclamation-triangle",size:"xl"})):a().createElement(l.Cascader,{key:(0,P.Ak)(5),"aria-label":"Services list",width:32,separator:"/",displayAllSelectedLevels:!0,placeholder:n?"Loading services...":`Select a service (${i.length})`,options:c,initialValue:r,changeOnSelect:!1,onSelect:e.selectNewValue})}));const Gt=e=>({iconError:i.css`
    height: 32px;
    align-self: center;
    color: ${e.colors.error.text};
  `});function Kt(e,t){const{value:n}=s.jh.findByKeyAndType(e,"serviceName",qt).useState(),{value:r}=s.jh.findByKeyAndType(e,"profileMetricId",$t).useState(),{filterExpression:a}=s.jh.findByKeyAndType(e,t,on).useState();return(0,o.useMemo)((()=>`${r}{service_name="${n}",${a}}`),[a,r,n])}class Ht extends s.mI{onActivate(){this.setState({skipUrlSync:!1}),this.subscribeToState(((e,t)=>{if(e.value&&e.value!==t.value){const t=Mt.x.get(Mt.x.KEYS.PROFILES_EXPLORER)||{};t.dataSource=e.value,Mt.x.set(Mt.x.KEYS.PROFILES_EXPLORER,t)}}))}constructor(){super({pluginId:"grafana-pyroscope-datasource",key:"dataSource",name:"dataSource",label:"Data source",skipUrlSync:!0,value:$.O.selectDefaultDataSource().uid}),this.addActivationHandler(this.onActivate.bind(this))}}function zt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Yt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){zt(e,t,n[t])}))}return e}function Qt(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Wt=e=>{let t=e.operator.value;return e.operator.value===S.in?t=S["=~"]:e.operator.value===S["not-in"]&&(t=S["!~"]),{key:e.attribute.value,operator:t,value:e.value.value}};function Jt(e,t){let n;const r=e.filter((e=>e.key!==t||(n=e,!1)));return{found:n,filtersWithoutFound:r}}const Xt=(e,t)=>[...e,t];function Zt(e,t){const{found:n,filtersWithoutFound:r}=Jt(e,t.key);if(!n)return Xt(e,Qt(Yt({},t),{operator:"=~"}));if(["!~","!="].includes(n.operator))return Xt(r,Qt(Yt({},t),{operator:"=~"}));const o=new Set(n.value.split("|"));return"=~"===n.operator?Xt(r,Qt(Yt({},n),{value:Array.from(o.add(t.value)).join("|")})):n.value===t.value?e:Xt(r,Qt(Yt({},t),{operator:"=~",value:Array.from(o.add(t.value)).join("|")}))}function en(e,t){const{found:n,filtersWithoutFound:r}=Jt(e,t.key);if(!n)return Xt(e,Qt(Yt({},t),{operator:"!~"}));if(["=~","="].includes(n.operator))return Xt(r,Qt(Yt({},t),{operator:"!~"}));const o=new Set(n.value.split("|"));return"!~"===n.operator?Xt(r,Qt(Yt({},n),{value:Array.from(o.add(t.value)).join("|")})):n.value===t.value?e:Xt(r,Qt(Yt({},t),{operator:"!~",value:Array.from(o.add(t.value)).join("|")}))}function tn(e,t){const{found:n,filtersWithoutFound:r}=Jt(e,t.key);if(!n)return e;const o=n.value.split("|").filter((e=>e!==t.value));return o.length>0?Xt(r,Qt(Yt({},n),{value:o.join("|")})):[...r]}const nn=e=>e.operator in S;function rn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class on extends s.H9{reset(){this.setState({filters:on.DEFAULT_VALUE})}static resetAll(e){["filters","filtersBaseline","filtersComparison"].forEach((t=>{s.jh.findByKeyAndType(e,t,on).reset()}))}onActivate(){const e=s.jh.findByKeyAndType(this,"dataSource",Ht).subscribeToState((()=>{this.reset()}));return()=>{e.unsubscribe()}}constructor({key:e}){super({key:e,name:e,label:"Filters",filters:on.DEFAULT_VALUE,expressionBuilder:e=>e.filter(nn).map((({key:e,operator:t,value:n})=>t===S["is-empty"]?`${e}=""`:`${e}${t}"${n}"`)).join(",")}),rn(this,"onChangeQuery",((e,t)=>{(0,f.r)("g_pyroscope_app_filters_changed",{name:this.state.name,count:t.length,operators:(0,b.uniq)(t.map((e=>e.operator.label)))}),this.setState({filters:t.map(Wt)})})),this.addActivationHandler(this.onActivate.bind(this))}}function an(e,t){var n;return null===(n=s.jh.lookupVariable(t,e))||void 0===n?void 0:n.getValue()}function sn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}rn(on,"DEFAULT_VALUE",[]),rn(on,"Component",(({model:e})=>{const{key:t}=e.useState(),n=Kt(e,t),{value:r}=s.jh.findByKeyAndType(e,"dataSource",Ht).useState(),{from:o,to:i}=s.jh.getTimeRange(e).state.value;return a().createElement(kt,{id:`query-builder-${t}`,autoExecute:!0,dataSourceUid:r,query:n,from:1e3*o.unix(),to:1e3*i.unix(),onChangeQuery:e.onChangeQuery})}));var ln=function(e){return e.TIMESERIES="time-series",e.BARGAUGE="bar-gauge",e.TABLE="table",e.HISTOGRAM="histogram",e}({});class cn extends s.Bs{getUrlState(){return{panelType:this.state.panelType}}updateFromUrl(e){const t={};"string"==typeof e.panelType&&e.panelType!==this.state.panelType&&(t.panelType=Object.values(ln).includes(e.panelType)?e.panelType:cn.DEFAULT_PANEL_TYPE),this.setState(t)}reset(){this.setState({panelType:cn.DEFAULT_PANEL_TYPE})}constructor(){super({key:"panel-type-switcher",panelType:cn.DEFAULT_PANEL_TYPE}),sn(this,"_urlSync",new s.So(this,{keys:["panelType"]})),sn(this,"onChange",(e=>{(0,f.r)("g_pyroscope_app_panel_type_changed",{panelType:e}),this.setState({panelType:e})}))}}sn(cn,"OPTIONS",[{label:"Time series",value:"time-series",icon:"heart-rate"},{label:"Totals",value:"bar-gauge",icon:"align-left"},{label:"Maxima",value:"table",icon:"angle-double-up"},{label:"Histograms",value:"histogram",icon:"graph-bar"}]),sn(cn,"DEFAULT_PANEL_TYPE","time-series"),sn(cn,"Component",(({model:e})=>{const{panelType:t}=e.useState();return a().createElement(l.RadioButtonGroup,{"aria-label":"Panel type switcher",options:cn.OPTIONS,value:t,onChange:e.onChange,fullWidth:!1})}));var un=n(3321);function dn(e){const t=k.config.theme2.visualization;return t.getColorByName(t.palette[e%8])}const pn=(e,t)=>{var n;return(null===(n=e.labels)||void 0===n?void 0:n[t])||"(no value)"},mn=(e,t)=>{var n,r,o;return null===(o=e.meta)||void 0===o||null===(r=o.stats)||void 0===r||null===(n=r.find((e=>e.displayName===t)))||void 0===n?void 0:n.value};function fn(e){const[,t=""]=e.match(/.+\{.*service_name="([^"]+)".*\}/)||[],[,n=""]=e.match(/([^{]+)\{.*}/)||[],r=e.substring(e.indexOf("{")),o=r.replace(/(\{|\})/,"").split(",").map((e=>{var t;return null===(t=e.match(/\W*([^=!~]+)(=|!=|=~|!~)"(.*)"/))||void 0===t?void 0:t[0]})).filter((e=>e&&!e.includes("service_name")));return{serviceId:t,profileMetricId:n,labelsSelector:r,labels:o}}function hn(e){return e.addActivationHandler((()=>{const{profileTypeId:t,labelSelector:n}=e.state.queries[0];if(!t)return void e.setState({queries:[{refId:"null"}],data:gn(e,"Missing profile type!")});if(!n)return void e.setState({queries:[{refId:"null"}],data:gn(e,"Missing label selector!")});if(!s.jh.interpolate(e,"$profileMetricId"))return void e.setState({queries:[{refId:"null"}],data:gn(e,"Missing profile type!")});fn(s.jh.interpolate(e,`$profileTypeId${n})`)).serviceId||e.setState({queries:[{refId:"null"}],data:gn(e,"Missing service name!")})})),e}function gn(e,t){const n=new Error(t);return y.v.error(n),{state:h.LoadingState.Error,errors:[n],series:[],timeRange:s.jh.getTimeRange(e).state.value}}function yn({serviceName:e,profileMetricId:t,groupBy:n,filters:r},o){const a=r?[...r]:[];a.unshift({key:"service_name",operator:"=",value:e||"$serviceName"});const i=a.map((({key:e,operator:t,value:n})=>`${e}${t}"${n}"`)).join(",");return hn(new s.dt({datasource:_t,queries:[{refId:`${t||"$profileMetricId"}-${i}-${(null==n?void 0:n.label)||"no-group-by"}`,queryType:"metrics",profileTypeId:t||"$profileMetricId",labelSelector:`{${i},$filters}`,groupBy:(null==n?void 0:n.label)?[n.label]:[],limit:o}]}))}const bn=()=>e=>e.pipe((0,Nt.map)((e=>null==e?void 0:e.map(((e,t)=>(0,b.merge)(e,{refId:`${e.refId}-${t}`})))))),vn=()=>e=>e.pipe((0,Nt.map)((e=>{const t=null==e?void 0:e.length;return null==e?void 0:e.map((e=>{var n,r;let o=Number.NEGATIVE_INFINITY;const a=null===(r=e.fields)||void 0===r||null===(n=r.find((e=>"number"===e.type)))||void 0===n?void 0:n.values.reduce(((e,t)=>(t>o&&(o=t),e+t)),0);return(0,b.merge)(e,{meta:{stats:[{displayName:"totalSeriesCount",value:t},{displayName:"allValuesSum",value:a},{displayName:"maxValue",value:o}]}})}))})));class En extends s.Bs{onActivate(e){const{body:t}=this.state,n=t.state.$data.subscribeToState((n=>{var r;if((null===(r=n.data)||void 0===r?void 0:r.state)!==h.LoadingState.Done)return;const{series:o}=n.data;(null==o?void 0:o.length)&&t.setState(this.getConfig(e,o)),this.publishEvent(new v({series:o}),!0)}));return()=>{n.unsubscribe()}}getConfig(e,t){var n;let r=Number.NEGATIVE_INFINITY;for(const e of t){const t=mn(e,"allValuesSum")||0;t>r&&(r=t)}const o=null===(n=e.queryRunnerParams.groupBy)||void 0===n?void 0:n.label,a=o?"This panel displays aggregate values over the current time period":void 0;return{title:t.length>1?`${e.label} (${t.length})`:e.label,description:a,options:{reduceOptions:{values:!1,calcs:["sum"]},orientation:h.VizOrientation.Horizontal,displayMode:un.eX.Gradient,valueMode:un.$l.Text,showUnfilled:!0,sizing:un.T6.Manual,text:{titleSize:13,valueSize:13},namePlacement:un.TZ.Top,minVizHeight:36,maxVizHeight:36,legend:{showLegend:!1}},fieldConfig:{defaults:{displayName:1===t.length?o:void 0,min:0,max:r,thresholds:{mode:h.ThresholdsMode.Percentage,steps:[]}},overrides:this.getOverrides(e,t)}}}getOverrides(e,t){var n;const{index:r,queryRunnerParams:o}=e,a=null===(n=o.groupBy)||void 0===n?void 0:n.label;return t.map(((e,t)=>({matcher:{id:h.FieldMatcherID.byFrameRefID,options:e.refId},properties:[{id:"displayName",value:pn(e.fields[1],a)},{id:"color",value:{mode:"fixed",fixedColor:dn(r+t)}}]})))}static Component({model:e}){const{body:t}=e.useState();return a().createElement(t.Component,{model:t})}constructor({item:e,headerActions:t}){super({key:"bar-gauge-label-values",body:s.d0.bargauge().setTitle(e.label).setData(new s.Es({$data:yn(e.queryRunnerParams),transformations:[bn,vn]})).setHeaderActions(t(e)).build()}),this.addActivationHandler(this.onActivate.bind(this,e))}}function Sn(e,t){const n=t.fields[1].config.unit,r=mn(t,"allValuesSum")||0,o=(0,h.getValueFormat)(n)(r),a=mn(t,"maxValue")||0,i=(0,h.getValueFormat)(n)(a);return`total ${e} = ${o.text}${o.suffix} / max = ${i.text}${i.suffix}`}class wn extends s.Bs{onActivate(e){const{body:t}=this.state,n=t.state.$data.subscribeToState((n=>{var r;if((null===(r=n.data)||void 0===r?void 0:r.state)!==h.LoadingState.Done)return;const{series:o}=n.data;(null==o?void 0:o.length)&&t.setState(this.getConfig(e,o)),this.publishEvent(new v({series:o}),!0)}));return()=>{n.unsubscribe()}}getConfig(e,t){var n;const{legendPlacement:r}=this.state,o=null===(n=e.queryRunnerParams.groupBy)||void 0===n?void 0:n.label;return{title:t.length>1?`${e.label} (${t.length})`:e.label,options:{tooltip:{mode:l.TooltipDisplayMode.Single,sort:un.xB.None},legend:{showLegend:!0,displayMode:l.LegendDisplayMode.List,placement:r,calcs:[]}},fieldConfig:{defaults:{displayName:1===t.length?o:void 0,custom:{lineWidth:1}},overrides:this.getOverrides(e,t)}}}getOverrides(e,t){var n;const{index:r,queryRunnerParams:o}=e,a=null===(n=o.groupBy)||void 0===n?void 0:n.label;return t.map(((e,n)=>{const o=e.fields[1];let i=a?pn(o,a):o.name;return 1===t.length&&(i=Sn(i,e)),{matcher:{id:h.FieldMatcherID.byFrameRefID,options:e.refId},properties:[{id:"displayName",value:i},{id:"color",value:{mode:"fixed",fixedColor:dn(r+n)}}]}}))}static Component({model:e}){const{body:t}=e.useState();return a().createElement(t.Component,{model:t})}constructor({item:e,headerActions:t,legendPlacement:n}){super({key:"histogram-label-values",legendPlacement:n||"bottom",body:s.d0.histogram().setTitle(e.label).setData(new s.Es({$data:yn(e.queryRunnerParams),transformations:[bn,vn]})).setHeaderActions(t(e)).build()}),this.addActivationHandler(this.onActivate.bind(this,e))}}class On extends s.Bs{onActivate(e){const{body:t}=this.state,n=t.state.$data.subscribeToState((n=>{var r;if((null===(r=n.data)||void 0===r?void 0:r.state)!==h.LoadingState.Done)return;const{series:o}=n.data;(null==o?void 0:o.length)&&t.setState(this.getConfig(e,o)),this.publishEvent(new v({series:o}),!0)}));return()=>{n.unsubscribe()}}getConfig(e,t){const n=t[0].fields[0].values.length,r=jt(s.jh.findByKeyAndType(this,"profileMetricId",$t).state.value).unit;return{title:n>1?`${e.label} (${n})`:e.label,fieldConfig:{defaults:{custom:{filterable:!0,cellOptions:{}}},overrides:[{matcher:{id:"byName",options:"max"},properties:[{id:"unit",value:r},{id:"custom.width",value:100}]}]}}}static Component({model:e}){const t=(0,l.useStyles2)(xn),{body:n}=e.useState();return a().createElement("span",{className:t.container},a().createElement(n.Component,{model:n}))}constructor({item:e,headerActions:t}){super({key:"table-label-values",body:s.d0.table().setTitle(e.label).setData(new s.Es({$data:yn(e.queryRunnerParams),transformations:[{id:h.DataTransformerID.reduce,options:{reducers:["max"],labelsToFields:!0}},{id:h.DataTransformerID.filterFieldsByName,options:{exclude:{names:["Field"]}}},{id:h.DataTransformerID.renameByRegex,options:{regex:"Max",renamePattern:"max"}},{id:h.DataTransformerID.sortBy,options:{sort:[{field:"max",desc:!0}]}}]})).setHeaderActions(t(e)).build()}),this.addActivationHandler(this.onActivate.bind(this,e))}}const xn=()=>({container:i.css`
    [data-testid='data-testid table body'] [role='row']:first-child {
      color: ${dn(3)};
      font-weight: 500;
    }
  `});function Tn(e){return{from:1e4*Math.floor((e.from.valueOf()||0)/1e4),to:1e4*Math.floor((e.to.valueOf()||0)/1e4)}}function Pn(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Cn(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Pn(a,r,o,i,s,"next",e)}function s(e){Pn(a,r,o,i,s,"throw",e)}i(void 0)}))}}function kn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function An(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){kn(e,t,n[t])}))}return e}function jn(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Nn=(0,n(8537).A)(20);class _n extends s.UU{query(){return Cn((function*(){return{state:h.LoadingState.Done,data:[{name:"Labels",fields:[{name:"Label",type:h.FieldType.other,values:[],config:{}}],length:0}]}}))()}getParams(e){var t;const{scopedVars:n,range:r}=e,o=null==n||null===(t=n.__sceneObject)||void 0===t?void 0:t.value,a=s.jh.interpolate(o,"$dataSource"),i=s.jh.interpolate(o,"$serviceName"),l=s.jh.interpolate(o,"$profileMetricId"),c=`${l}{service_name="${i}"}`,{from:u,to:d}=Tn(r);return{dataSourceUid:a,serviceName:i,profileMetricId:l,query:c,from:u,to:d}}fetchLabels(e,t,n,r,o){return Cn((function*(){H.setApiClient(new I({dataSourceUid:e}));try{return yield H.listLabels({query:t,from:n,to:r})}catch(e){throw y.v.error(e,{info:"Error while loading Pyroscope label names!",variableName:o||""}),e}}))()}fetchLabelValues(e,t,n,r,o,a){return Cn((function*(){let e;try{e=yield H.listLabelValues({query:t,from:n,to:r,label:o})}catch(e){y.v.error(e,{info:"Error while loading Pyroscope label values!",variableName:a||""})}const i=e?e.length:-1;return{value:{value:o,groupBy:{label:o,values:e||[]}},text:`${o} (${i>-1?i:"?"})`,count:i}}))()}metricFindQuery(e,t){var n=this;return Cn((function*(){var e,r,o;if(!(null===(r=t.scopedVars)||void 0===r||null===(e=r.__sceneObject)||void 0===e?void 0:e.value).isActive)return[];const{dataSourceUid:a,serviceName:i,profileMetricId:s,query:l,from:c,to:u}=n.getParams(t);if(!i||!s)return y.v.warn('LabelsDataSource: either serviceName="%s" and/or profileMetricId="%s" is empty! Discarding request.',i,s),[];const d=yield n.fetchLabels(a,l,c,u,null===(o=t.variable)||void 0===o?void 0:o.name),p=yield Promise.all(d.filter((({value:e})=>!Se(e))).map((({value:e},r)=>Nn((()=>{var o;return n.fetchLabelValues(r,l,c,u,e,null===(o=t.variable)||void 0===o?void 0:o.name)}))))),m=p.sort(((e,t)=>t.count-e.count)).map((({value:e,text:t},n)=>({value:JSON.stringify(jn(An({},e),{index:n})),text:t})));return[{value:"all",text:"All"},...m]}))()}testDatasource(){return Cn((function*(){return{status:"success",message:"OK"}}))()}constructor(){super(Lt.type,Lt.uid)}}kn(_n,"MAX_TIMESERIES_LABEL_VALUES",10);const In=n.p+"e6c722427cfa8715e19d.svg";function Rn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ln(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Rn(e,t,n[t])}))}return e}function Dn(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function Fn(e){const t=jt(e);return`${t.type} (${t.group})`}function $n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Bn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){$n(e,t,n[t])}))}return e}function Mn(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Un=[{text:"Linear",scaleDistribution:{type:un.L4.Linear}},{text:"Log2",scaleDistribution:{type:un.L4.Log,log:2}}];class Vn extends s.Bs{onActivate(){this.setState({items:this.buildMenuItems()})}buildMenuItems(e){const{items:t,scaleType:n}=this.state,r=[{text:"Scale type",type:"group",subMenu:Un.map((e=>({text:`${n===e.scaleDistribution.type?"✔ ":""}${e.text}`,onClick:()=>this.onClickScaleOption(e)})))},{type:"divider",text:""},{iconClassName:"compass",text:"Open in Explore",onClick:()=>this.onClickExplore()}];if(e)r.push({iconClassName:"plus-square",text:"Add to investigation (beta)",onClick:()=>{e.onClick()}});else{const e=null==t?void 0:t.find((e=>e.text.includes("Add to investigation")));e&&r.push(Bn({},e))}return r}onClickScaleOption(e){const{scaleDistribution:t,text:n}=e;(0,k.reportInteraction)("g_pyroscope_app_timeseries_scale_changed",{scale:t.type});s.jh.getAncestor(this,qn).changeScale(t,n),this.setState({scaleType:t.type,items:this.buildMenuItems()})}onClickExplore(){(0,k.reportInteraction)("g_pyroscope_app_open_in_explore_clicked");const e=function(e,t,n){const r=JSON.stringify({"pyroscope-explore":{range:(0,h.toURLRange)(e),queries:[Dn(Ln({},t),{datasource:n})],panelsState:{},datasource:n}});var o;const a=null!==(o=k.config.appSubUrl)&&void 0!==o?o:"";return h.urlUtil.renderUrl(`${a}/explore`,{panes:r,schemaVersion:1})}(s.jh.getTimeRange(this).state.value.raw,this.getInterpolatedQuery(),s.jh.interpolate(this,"${dataSource}"));window.open(e,"_blank")}getInterpolatedQuery(){var e;const t=null===(e=s.jh.getAncestor(this,qn).state.body.state.$data)||void 0===e?void 0:e.state.$data,n=null==t?void 0:t.state.queries[0];return Object.entries(n).map((([e,t])=>[e,"string"==typeof t?s.jh.interpolate(this,t):t])).reduce(((e,[t,n])=>Mn(Bn({},e),{[t]:n})),{})}useGetInvestigationPluginLinkContext(){const{refId:e,queryType:t,profileTypeId:n,labelSelector:r,groupBy:a}=this.getInterpolatedQuery(),i=fn(`${n}${r}`),l=[i.serviceId,Fn(i.profileMetricId)];(null==a?void 0:a.length)&&l.push(a[0]),i.labels.length&&l.push(i.labels.join(", "));const c=l.join(" · "),u=s.jh.interpolate(this,"${dataSource}"),d=s.jh.getTimeRange(this).state.value;return(0,o.useMemo)((()=>({id:(0,P.Ak)(),origin:"Explore Profiles",url:window.location.href,logoPath:In,title:c,type:"timeseries",timeRange:Bn({},d),queries:[{refId:e,queryType:t,profileTypeId:n,labelSelector:r,groupBy:a}],datasource:u})),[u,a,r,n,t,e,d,c])}useUpdateMenuItems(){const e=function({extensionPointId:e,context:t,pluginId:n}){const r=(0,k.usePluginLinks)({extensionPointId:e,context:t}),[o]=r.links.filter((e=>e.pluginId===n));return o}({extensionPointId:"grafana-pyroscope-app/exploration/v1",context:this.useGetInvestigationPluginLinkContext(),pluginId:"grafana-explorations-app"});(0,o.useEffect)((()=>{e&&this.setState({items:this.buildMenuItems(e)})}),[e])}static Component({model:e}){return e.useUpdateMenuItems(),a().createElement(s.Lw.Component,{model:e})}constructor(e){super(Bn({scaleType:un.L4.Linear},e)),this.addActivationHandler(this.onActivate.bind(this))}}class qn extends s.Bs{onActivate(){const{body:e}=this.state,t=e.state.$data.subscribeToState(((t,n)=>{var r,o,a,i;if((null===(r=t.data)||void 0===r?void 0:r.state)!==h.LoadingState.Done)return;!(null===(o=t.data.annotations)||void 0===o?void 0:o.length)&&(null===(i=n.data)||void 0===i||null===(a=i.annotations)||void 0===a?void 0:a.length)&&(t.data.annotations=n.data.annotations);const{series:s}=t.data;if(null==s?void 0:s.length){const t=this.state.displayAllValues?this.getAllValuesConfig(s):this.getConfig(s);e.setState((0,b.merge)({},e.state,t))}this.publishEvent(new v({series:s}),!0)}));return()=>{t.unsubscribe()}}getConfig(e){var t;const{body:n,item:r,legendPlacement:o}=this.state;let a,{title:i}=n.state;return(null===(t=r.queryRunnerParams.groupBy)||void 0===t?void 0:t.label)&&(i=e.length>1?`${r.label} (${e.length})`:r.label,a=this.buildDescription(r.queryRunnerParams.groupBy)),{title:i,description:a,options:{tooltip:{mode:"single",sort:"none"},legend:{showLegend:!0,displayMode:"list",placement:o}},fieldConfig:{defaults:{min:0,custom:{fillOpacity:e.length>=_n.MAX_TIMESERIES_LABEL_VALUES?0:9,gradientMode:1===e.length?un.on.None:un.on.Opacity,pointSize:3}},overrides:this.getOverrides(e)}}}buildDescription(e){return e?e.values?e.values.length>_n.MAX_TIMESERIES_LABEL_VALUES?`Showing only ${_n.MAX_TIMESERIES_LABEL_VALUES} out of ~${e.values.length} series to preserve readability. To view all the series for the current filters, click on the expand icon on this panel.`:"":`Showing only ${_n.MAX_TIMESERIES_LABEL_VALUES} series to preserve readability. To view all the series, click on the expand icon on this panel.`:""}getAllValuesConfig(e){const{legendPlacement:t}=this.state;return{options:{tooltip:{mode:l.TooltipDisplayMode.Single,sort:un.xB.None},legend:{showLegend:!0,displayMode:l.LegendDisplayMode.List,placement:t,calcs:[]}},fieldConfig:{defaults:{min:0,custom:{fillOpacity:0,pointSize:5}},overrides:this.getOverrides(e)}}}getOverrides(e){var t;if(this.state.overrides)return this.state.overrides(e);const{item:n}=this.state,r=null===(t=n.queryRunnerParams.groupBy)||void 0===t?void 0:t.label;return e.map(((t,o)=>{const a=t.fields[1];let i=r?pn(a,r):a.name;return 1===e.length&&(i=Sn(i,t)),{matcher:{id:h.FieldMatcherID.byFrameRefID,options:t.refId},properties:[{id:"displayName",value:i},{id:"color",value:{mode:"fixed",fixedColor:dn(n.index+o)}}]}}))}updateItem(e){var t,n;const{item:r,headerActions:o,body:a}=this.state,i=(0,b.merge)({},r,e);if((null===(t=e.queryRunnerParams)||void 0===t?void 0:t.hasOwnProperty("groupBy"))&&(void 0===e.queryRunnerParams.groupBy?delete i.queryRunnerParams.groupBy:i.queryRunnerParams.groupBy=e.queryRunnerParams.groupBy),(null===(n=e.queryRunnerParams)||void 0===n?void 0:n.hasOwnProperty("filters"))&&void 0===e.queryRunnerParams.filters&&delete i.queryRunnerParams.filters,this.setState({item:i}),a.setState({title:e.label,description:this.buildDescription(i.queryRunnerParams.groupBy),headerActions:o(i)}),!(0,b.isEqual)(r.queryRunnerParams,i.queryRunnerParams)){var s;const{queries:e}=yn(i.queryRunnerParams,_n.MAX_TIMESERIES_LABEL_VALUES).state,t=null===(s=a.state.$data)||void 0===s?void 0:s.state.$data;null==t||t.setState({queries:e}),null==t||t.runQueries()}}changeScale(e,t){const{body:n}=this.state;n.clearFieldConfigCache(),n.setState({fieldConfig:(0,b.merge)({},n.state.fieldConfig,{defaults:{custom:{scaleDistribution:e,axisLabel:e.type!==un.L4.Linear?t:""}}})})}static Component({model:e}){const{body:t}=e.useState();return a().createElement(t.Component,{model:t})}constructor({item:e,headerActions:t,displayAllValues:n,legendPlacement:r,data:o,overrides:a}){super({key:"timeseries-label-values",item:e,headerActions:t,displayAllValues:Boolean(n),legendPlacement:r||"bottom",overrides:a,body:s.d0.timeseries().setTitle(e.label).setData(o||new s.Es({$data:yn(e.queryRunnerParams,n?void 0:_n.MAX_TIMESERIES_LABEL_VALUES),transformations:[bn,vn]})).setHeaderActions(t(e)).setMenu(new Vn({})).build()}),this.addActivationHandler(this.onActivate.bind(this))}}function Gn(e,t){switch(e){case ln.BARGAUGE:return new En(t);case ln.TABLE:return new On(t);case ln.HISTOGRAM:return new wn(t);case ln.TIMESERIES:default:return new qn(t)}}var Kn=n(9488);const Hn=n.p+"944c737f589d02ecf603.svg",zn=n.p+"e79edcfbe2068fae2364.svg",Yn=(e=50)=>{const[t,n]=(0,o.useState)({x:null,y:null});return(0,o.useEffect)((()=>{const t=(0,b.throttle)((e=>{n({x:e.clientX,y:e.clientY})}),e);return window.addEventListener("mousemove",t),()=>{window.removeEventListener("mousemove",t)}}),[e]),t},Qn=({width:e="auto",height:t,show404:n=!1})=>{const r=(0,l.useTheme2)(),{x:o,y:i}=Yn(),s=(0,l.useStyles2)(Wn,o,i,n);return a().createElement(Kn.A,{src:r.isDark?Hn:zn,className:s.svg,height:t,width:e})};Qn.displayName="GrotNotFound";const Wn=(e,t,n,r)=>{const{innerWidth:o,innerHeight:a}=window,s=n&&n/a,l=t&&t/o,c=null!==s?Jn(s,-20,5):0,u=null!==l?Jn(l,-5,5):0;return{svg:(0,i.css)({"#grot-404-arm, #grot-404-magnifier":{transform:`rotate(${c}deg) translateX(${u}%)`,transformOrigin:"center",transition:"transform 50ms linear"},"#grot-404-text":{display:r?"block":"none"}})}},Jn=(e,t,n)=>e*(n-t)+t,Xn=({message:e})=>{const t=(0,l.useStyles2)(Zn);return a().createElement("div",{className:t.container},a().createElement(l.Box,{paddingY:8},a().createElement(l.Stack,{direction:"column",alignItems:"center",gap:3},a().createElement(Qn,{width:300}),a().createElement(l.Text,{variant:"h5"},e))))};function Zn(){return{container:(0,i.css)({width:"100%",display:"flex",justifyContent:"space-evenly",flexDirection:"column"})}}Xn.displayName="EmptyState";class er extends s.Bs{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(er,"Component",(({model:e})=>{const{message:t}=e.useState();return a().createElement(Xn,{message:t})}));class tr extends s.Bs{}function nr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(tr,"Component",(({model:e})=>{const{message:t}=e.useState();return a().createElement(l.Alert,{title:"Query error!",severity:"error"},t)}));var rr=function(e){return e.GRID="grid",e.ROWS="rows",e}({});class or extends s.Bs{getUrlState(){return{layout:this.state.layout}}updateFromUrl(e){const t={};"string"==typeof e.layout&&e.layout!==this.state.layout&&(t.layout=Object.values(rr).includes(e.layout)?e.layout:or.DEFAULT_LAYOUT),this.setState(t)}constructor(){super({key:"layout-switcher",layout:or.DEFAULT_LAYOUT}),nr(this,"_urlSync",new s.So(this,{keys:["layout"]})),nr(this,"onChange",(e=>{(0,f.r)("g_pyroscope_app_layout_changed",{layout:e}),this.setState({layout:e})}))}}function ar(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}nr(or,"OPTIONS",[{label:"Grid",value:"grid"},{label:"Rows",value:"rows"}]),nr(or,"DEFAULT_LAYOUT","grid"),nr(or,"Component",(({model:e})=>{const{layout:t}=e.useState();return a().createElement(l.RadioButtonGroup,{"aria-label":"Layout switcher",options:or.OPTIONS,value:t,onChange:e.onChange,fullWidth:!1})}));class ir extends s.Bs{getUrlState(){return{hideNoData:this.state.hideNoData}}updateFromUrl(e){const t={};"string"==typeof e.hideNoData&&e.hideNoData!==this.state.hideNoData&&(t.hideNoData=["on","off"].includes(e.hideNoData)?e.hideNoData:ir.DEFAULT_VALUE),this.setState(t)}constructor(){super({key:"no-data-switcher",hideNoData:ir.DEFAULT_VALUE}),ar(this,"_urlSync",new s.So(this,{keys:["hideNoData"]})),ar(this,"onChange",(e=>{(0,f.r)("g_pyroscope_app_hide_no_data_changed",{hideNoData:e}),this.setState({hideNoData:e})}))}}function sr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}ar(ir,"DEFAULT_VALUE","off"),ar(ir,"Component",(({model:e})=>{const{hideNoData:t}=e.useState();return a().createElement(l.InlineSwitch,{"data-testid":"noDataSwitcher",showLabel:!0,label:"Hide panels without data",value:"on"===t,onChange:t=>e.onChange(t.target.checked?"on":"off")})}));class lr extends s.Bs{setPlaceholder(e){this.setState({placeholder:e})}setResultsCount(e){this.setState({resultsCount:String(e)})}getUrlState(){return{searchText:this.state.searchText}}updateFromUrl(e){const t={};"string"==typeof e.searchText&&e.searchText!==this.state.searchText&&(t.searchText=e.searchText),this.setState(t)}reset(){this.setState({placeholder:"",searchText:"",resultsCount:""})}constructor({placeholder:e}){super({key:"quick-filter",placeholder:e,searchText:lr.DEFAULT_SEARCH_TEXT,resultsCount:""}),sr(this,"_urlSync",new s.So(this,{keys:["searchText"]})),sr(this,"onChange",(e=>{this.setState({searchText:e.target.value})})),sr(this,"clearSearchText",(()=>{this.setState({searchText:""})})),sr(this,"onFocus",(()=>{(0,f.r)("g_pyroscope_app_quick_filter_focused")}))}}sr(lr,"DEFAULT_SEARCH_TEXT",""),sr(lr,"DEBOUNCE_DELAY",250),sr(lr,"Component",(({model:e})=>{const t=(0,l.useStyles2)(cr),{placeholder:n,searchText:r,resultsCount:o}=e.useState();return a().createElement(l.Input,{type:"text",className:"quick-filter","aria-label":"Quick filter",placeholder:n,value:r,prefix:a().createElement(l.Icon,{name:"search"}),suffix:a().createElement(a().Fragment,null,""!==o&&a().createElement(l.Tag,{className:t.resultsCount,name:o,colorIndex:9,"data-testid":"quick-filter-results-count"}),a().createElement(l.IconButton,{name:"times","aria-label":"Clear search",onClick:e.clearSearchText})),onChange:e.onChange,onKeyDown:t=>{"Escape"===t.key&&e.clearSearchText()},onFocus:e.onFocus})}));const cr=e=>({resultsCount:i.css`
    margin-right: ${e.spacing(1)};
    border-radius: 11px;
    padding: 2px 8px;
    color: ${e.colors.text.primary};
    background-color: ${e.colors.background.secondary};
  `});function ur(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function dr(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){ur(a,r,o,i,s,"next",e)}function s(e){ur(a,r,o,i,s,"throw",e)}i(void 0)}))}}function pr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function mr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){pr(e,t,n[t])}))}return e}class fr extends s.UU{static getAllFavorites(){var e;return(null===(e=Mt.x.get(Mt.x.KEYS.PROFILES_EXPLORER))||void 0===e?void 0:e.favorites)||[]}static areFavoritesEqual(e,t){return e.panelType===t.panelType&&(0,b.isEqual)(e.queryRunnerParams,t.queryRunnerParams)}static exists(e){return fr.getAllFavorites().some((t=>fr.areFavoritesEqual(t,e)))}static addFavorite(e){const t=Mt.x.get(Mt.x.KEYS.PROFILES_EXPLORER);t.favorites.push(e),Mt.x.set(Mt.x.KEYS.PROFILES_EXPLORER,t)}static removeFavorite(e){const t=Mt.x.get(Mt.x.KEYS.PROFILES_EXPLORER);t.favorites=t.favorites.filter((t=>!fr.areFavoritesEqual(t,e))),Mt.x.set(Mt.x.KEYS.PROFILES_EXPLORER,t)}query(){return dr((function*(){return{state:h.LoadingState.Done,data:[{name:"Favories",fields:[{name:null,type:h.FieldType.other,values:[],config:{}}],length:0}]}}))()}metricFindQuery(){return dr((function*(){return fr.getAllFavorites().map((e=>{const{serviceName:t,profileMetricId:n,groupBy:r,filters:o}=e.queryRunnerParams||{},a=[t,Fn(n)];return(null==r?void 0:r.label)&&a.push(r.label),(null==o?void 0:o.length)&&a.push(o.map((({key:e,operator:t,value:n})=>`${e}${t}"${n}"`)).join(", ")),{value:JSON.stringify(mr({value:JSON.stringify(e)},e)),text:a.join(" · ")}}))}))()}testDatasource(){return dr((function*(){return{status:"success",message:"OK"}}))()}constructor(){var e;super(Rt.type,Rt.uid);const t=Mt.x.get(Mt.x.KEYS.PROFILES_EXPLORER)||{};(e=t).favorites||(e.favorites=[]),t.favorites=t.favorites.map((e=>mr({panelType:ln.TIMESERIES},e))),Mt.x.set(Mt.x.KEYS.PROFILES_EXPLORER,t)}}function hr(e,t){const{queryRunnerParams:n}=t,r=(0,b.defaults)((0,b.clone)(n),{serviceName:an(e,"serviceName"),profileMetricId:an(e,"profileMetricId")}),o=s.jh.lookupVariable("filters",e).state.filters.map((({key:e,operator:t,value:n})=>({key:e,operator:t,value:n})));return r.filters=(0,b.uniqBy)([...r.filters||[],...o],(({key:e,operator:t,value:n})=>`${e}${t}${n}`)),r}function gr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class yr extends s.Bs{update(){this.setState({isFav:this.isStored()})}isStored(){return fr.exists(this.buildFavorite())}static buildFavorite(e){var t;const{index:n,queryRunnerParams:r,panelType:o}=e,a={index:n,queryRunnerParams:{serviceName:r.serviceName,profileMetricId:r.profileMetricId},panelType:o};return r.groupBy&&(a.queryRunnerParams.groupBy={label:r.groupBy.label}),(null===(t=r.filters)||void 0===t?void 0:t.length)&&(a.queryRunnerParams.filters=r.filters),a}buildFavorite(){const{item:e,skipVariablesInterpolation:t}=this.state;return yr.buildFavorite({index:e.index,queryRunnerParams:t?e.queryRunnerParams:hr(this,e),panelType:e.panelType})}constructor(e){super(e),gr(this,"_variableDependency",new s.Sh(this,{variableNames:["serviceName","profileMetricId","filters"],onReferencedVariableValueChanged:()=>{this.update()}})),gr(this,"onClick",(()=>{(0,f.r)("g_pyroscope_app_fav_action_clicked",{favAfterClick:!this.state.isFav}),this.state.isFav?fr.removeFavorite(this.buildFavorite()):fr.addFavorite(this.buildFavorite()),this.setState({isFav:!this.state.isFav})})),this.addActivationHandler((()=>this.update()))}}gr(yr,"Component",(({model:e})=>{const t=(0,l.useStyles2)(br),{isFav:n}=e.useState();return a().createElement(l.IconButton,{className:n?t.favedButton:t.notFavedbutton,name:n?"favorite":"star",variant:"secondary",size:"sm","aria-label":n?"Unfavorite":"Favorite",tooltip:n?"Unfavorite":"Favorite",tooltipPlacement:"top",onClick:e.onClick})}));const br=()=>({favedButton:i.css`
    color: #f2cc0d;
    margin: 0;
  `,notFavedbutton:i.css`
    margin: 0;
  `}),vr=function(e,t){const n=fr.exists(yr.buildFavorite(e)),r=fr.exists(yr.buildFavorite(t));return n&&r?Ze(e.label,t.label):r?1:n?-1:0},Er="240px";class Sr extends s.Bs{static buildGridItemKey(e){return`grid-item-${e.index}-${e.value}`}static getGridColumnsTemplate(e){return e===rr.ROWS?"1fr":"repeat(auto-fit, minmax(400px, 1fr))"}onActivate(){const e=s.jh.lookupVariable(this.state.variableName,this),t=e.subscribeToState(((e,t)=>{!e.loading&&t.loading&&this.renderGridItems()}));e.update();const n=this.subscribeToRefreshClick(),r=this.subscribeToQuickFilterChange(),o=this.subscribeToLayoutChange(),a=this.subscribeToHideNoDataChange(),i=this.subscribeToFiltersChange();return()=>{i.unsubscribe(),a.unsubscribe(),o.unsubscribe(),r.unsubscribe(),n.unsubscribe(),t.unsubscribe()}}subscribeToRefreshClick(){const e=s.jh.lookupVariable(this.state.variableName,this),t=e.state.refresh;e.setState({refresh:h.VariableRefresh.never});const n=()=>{e.update()},r=document.querySelector('[data-testid="data-testid RefreshPicker run button"]');return r||y.v.error(new Error("SceneByVariableRepeaterGrid: Refresh button not found! The list of items will never be updated.")),null==r||r.addEventListener("click",n),null==r||r.setAttribute("title","Click to completely refresh all the panels present on the screen"),{unsubscribe(){null==r||r.removeAttribute("title"),null==r||r.removeEventListener("click",n),e.setState({refresh:t})}}}subscribeToQuickFilterChange(){const e=s.jh.findByKeyAndType(this,"quick-filter",lr);this.subscribeToState(((t,n)=>{t.items.length!==n.items.length&&e.setResultsCount(t.items.length)}));return e.subscribeToState((0,b.debounce)(((e,t)=>{e.searchText!==(null==t?void 0:t.searchText)&&this.renderGridItems()}),lr.DEBOUNCE_DELAY))}subscribeToLayoutChange(){const e=s.jh.findByKeyAndType(this,"layout-switcher",or),t=this.state.body,n=(e,n)=>{e.layout!==(null==n?void 0:n.layout)&&t.setState({templateColumns:Sr.getGridColumnsTemplate(e.layout)})};return n(e.state),e.subscribeToState(n)}subscribeToHideNoDataChange(){const e=s.jh.findByKeyAndType(this,"no-data-switcher",ir);if(!e.isActive)return this.setState({hideNoData:!1}),{unsubscribe:g.f};const t=(e,t)=>{e.hideNoData!==(null==t?void 0:t.hideNoData)&&(this.setState({hideNoData:"on"===e.hideNoData}),this.renderGridItems(!0))};return t(e.state),e.subscribeToState(t)}subscribeToFiltersChange(){const e=s.jh.findByKeyAndType(this,"filters",on),t=s.jh.findByKeyAndType(this,"no-data-switcher",ir);return e.subscribeToState((()=>{"on"===t.state.hideNoData&&this.renderGridItems(!0)}))}buildItemsData(e){const{mapOptionToItem:t}=this.state,n={serviceName:an(this,"serviceName"),profileMetricId:an(this,"profileMetricId"),panelType:s.jh.findByKeyAndType(this,"panel-type-switcher",cn).state.panelType},r=e.state.options.map(((e,r)=>t(e,r,n))).filter(Boolean);return this.filterItems(r).sort(this.state.sortItemsFn)}shouldRenderItems(e){const{items:t}=this.state;return!e.length||t.length!==e.length||!(0,b.isEqual)(t,e)}renderGridItems(e=!1){const t=s.jh.lookupVariable(this.state.variableName,this);if(t.state.loading)return;if(t.state.error)return void this.renderErrorState(t.state.error);const n=this.buildItemsData(t);if(!e&&!this.shouldRenderItems(n))return;if(this.setState({items:n}),!this.state.items.length)return void this.renderEmptyState();const r=this.state.items.map((e=>{const t=Gn(e.panelType,{item:e,headerActions:this.state.headerActions.bind(null,e,this.state.items)});return this.state.hideNoData&&this.setupHideNoData(t),new s.xK({key:Sr.buildGridItemKey(e),body:t})}));this.state.body.setState({autoRows:Er,children:r})}setupHideNoData(e){const t=e.subscribeToEvent(v,(t=>{var n;if(null===(n=t.payload.series)||void 0===n?void 0:n.length)return;const r=s.jh.getAncestor(e,s.xK),{key:o}=r.state,a=s.jh.getAncestor(r,s.gF),i=a.state.children.filter((e=>e.state.key!==o));i.length?a.setState({children:i}):this.renderEmptyState()}));e.addActivationHandler((()=>()=>{t.unsubscribe()}))}filterItems(e){const t=s.jh.findByKeyAndType(this,"quick-filter",lr),{searchText:n}=t.state;if(!n)return e;const r=n.split(",").map((e=>e.trim())).filter(Boolean).map((e=>{try{return new RegExp(e)}catch(e){return null}})).filter(Boolean);return e.filter((({label:e})=>r.some((t=>t.test(e)))))}renderEmptyState(){this.state.body.setState({autoRows:"480px",children:[new s.xK({body:new er({message:"No results"})})]})}renderErrorState(e){this.state.body.setState({autoRows:"480px",children:[new s.xK({body:new tr({message:e.message||e.toString()})})]})}static Component({model:e}){var t;const{body:n,variableName:r}=e.useState(),{loading:o}=null===(t=s.jh.lookupVariable(r,e))||void 0===t?void 0:t.useState();return o?a().createElement(l.Spinner,null):a().createElement(n.Component,{model:n})}constructor({key:e,variableName:t,headerActions:n,mapOptionToItem:r,sortItemsFn:o}){super({key:e,variableName:t,items:[],headerActions:n,mapOptionToItem:r,sortItemsFn:o||vr,hideNoData:!1,body:new s.gF({templateColumns:Sr.getGridColumnsTemplate(or.DEFAULT_LAYOUT),autoRows:Er,isLazy:!0,$behaviors:[new s.Gg.K2({key:"metricCrosshairSync",sync:h.DashboardCursorSync.Crosshair})],children:[]})}),this.addActivationHandler(this.onActivate.bind(this))}}class wr extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(wr,"type","expand-panel");class Or extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Or,"type","select-label");class xr extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(xr,"type","view-service-flame-graph");class Tr extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Tr,"type","view-service-labels");class Pr extends h.BusEventWithPayload{}function Cr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function kr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Cr(e,t,n[t])}))}return e}function Ar(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Pr,"type","view-service-profiles");const jr=new Map([["expand-panel",Object.freeze({ariaLabel:"Expand panel",icon:"expand-arrows",tooltip:()=>"Expand this panel to view all the data for the current filters",EventConstructor:wr})],["select-label",Object.freeze({label:"Select",tooltip:({queryRunnerParams:e})=>{var t;return`View "${null===(t=e.groupBy)||void 0===t?void 0:t.label}" values breakdown`},EventConstructor:Or})],["view-flame-graph",Object.freeze({label:"Flame graph",tooltip:({queryRunnerParams:e},t)=>{const n=e.serviceName||an(t,"serviceName");return`View the "${jt(e.profileMetricId||an(t,"profileMetricId")).type}" flame graph of ${n}`},EventConstructor:xr})],["view-labels",Object.freeze({label:"Labels",tooltip:({queryRunnerParams:e},t)=>`Explore the labels of ${e.serviceName||an(t,"serviceName")}`,EventConstructor:Tr})],["view-profiles",Object.freeze({label:"Profile types",tooltip:({queryRunnerParams:e},t)=>`View the profile types of ${e.serviceName||an(t,"serviceName")}`,EventConstructor:Pr})]]);class Nr extends s.Bs{buildEvent(){const{EventConstructor:e,item:t,skipVariablesInterpolation:n}=this.state;return new e({item:Ar(kr({},t),{queryRunnerParams:n?t.queryRunnerParams:hr(this,t)})})}constructor({type:e,item:t,tooltip:n,skipVariablesInterpolation:r}){const o=jr.get(e);if(!o)throw new TypeError(`Unknown event type="${e}"!`);super(kr({type:e,item:t},(0,b.merge)({},o,{tooltip:n,skipVariablesInterpolation:r}))),Cr(this,"onClick",(()=>{(0,f.r)("g_pyroscope_app_select_action_clicked",{type:this.state.type}),this.publishEvent(this.buildEvent(),!0)}))}}Cr(Nr,"Component",(({model:e})=>{const t=(0,l.useStyles2)(_r),{ariaLabel:n,label:r,icon:o,tooltip:i,item:s}=e.useState();return a().createElement(l.Button,{className:t.selectButton,"aria-label":n||r,variant:"primary",size:"sm",fill:"text",onClick:e.onClick,icon:o,tooltip:null==i?void 0:i(s,e),tooltipPlacement:"top"},r)}));const _r=()=>({selectButton:i.css`
    margin: 0;
    padding: 0;
  `});class Ir extends s.Bs{onActivate(){s.jh.findByKeyAndType(this,"quick-filter",lr).setPlaceholder("Search services (comma-separated regexes are supported)")}getVariablesAndGridControls(){return{variables:[s.jh.findByKeyAndType(this,"profileMetricId",$t)],gridControls:[s.jh.findByKeyAndType(this,"quick-filter",lr),s.jh.findByKeyAndType(this,"layout-switcher",or)]}}static Component({model:e}){const{body:t}=e.useState();return a().createElement(t.Component,{model:t})}constructor(){super({key:"explore-all-services",$variables:new s.Pj({variables:[new qt({query:qt.QUERY_PROFILE_METRIC_DEPENDENT,skipUrlSync:!0})]}),body:new Sr({key:"all-services-grid",variableName:"serviceName",mapOptionToItem:(e,t,{profileMetricId:n})=>({index:t,value:e.value,label:e.label,queryRunnerParams:{serviceName:e.value,profileMetricId:n},panelType:ln.TIMESERIES}),headerActions:e=>[new Nr({type:"view-profiles",item:e}),new Nr({type:"view-labels",item:e}),new Nr({type:"view-flame-graph",item:e}),new yr({item:e})]})}),this.addActivationHandler(this.onActivate.bind(this))}}function Rr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Lr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Rr(e,t,n[t])}))}return e}function Dr(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}class Fr extends s.Bs{constructor(e){super(Lr({key:"drawer",isOpen:!1},e)),Rr(this,"open",(({title:e,subTitle:t,body:n})=>{this.setState(Dr(Lr({},this.state),{isOpen:!0,title:e,subTitle:t,body:n}))})),Rr(this,"close",(()=>{this.setState({isOpen:!1})}))}}function $r(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}Rr(Fr,"Component",(({model:e})=>{const{isOpen:t,title:n,subTitle:r,body:o}=e.useState();return a().createElement(a().Fragment,null,o&&t&&a().createElement(l.Drawer,{size:"lg",title:n,subtitle:r,closeOnMaskClick:!0,onClose:e.close},a().createElement(o.Component,{model:o})))}));class Br extends s.fS{update(){var e,t=this;return(e=function*(){if(t.state.loading)return;let e=[],n=null;t.setState({loading:!0,options:[],error:null});try{e=yield(0,Nt.lastValueFrom)(t.getValueOptions({}))}catch(e){n=e}finally{t.setState({loading:!1,options:e,error:n})}},function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){$r(a,r,o,i,s,"next",e)}function s(e){$r(a,r,o,i,s,"throw",e)}i(void 0)}))})()}constructor(){super({name:"favorite",label:"🔖 Favorite",datasource:Rt,query:"$dataSource",loading:!0,refresh:h.VariableRefresh.never,skipUrlSync:!0})}}function Mr(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}class Ur extends s.Bs{onActivate(){s.jh.findByKeyAndType(this,"quick-filter",lr).setPlaceholder("Search favorites (comma-separated regexes are supported)");var e=this;const t=this.subscribeToEvent(wr,function(){var t,n=(t=function*(t){e.openExpandedPanelDrawer(t.payload.item)},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){Mr(a,r,o,i,s,"next",e)}function s(e){Mr(a,r,o,i,s,"throw",e)}i(void 0)}))});return function(e){return n.apply(this,arguments)}}());return()=>{t.unsubscribe()}}getVariablesAndGridControls(){return{variables:[],gridControls:[s.jh.findByKeyAndType(this,"quick-filter",lr),s.jh.findByKeyAndType(this,"layout-switcher",or),s.jh.findByKeyAndType(this,"no-data-switcher",ir)]}}openExpandedPanelDrawer(e){this.state.drawer.open({title:e.label,body:Gn(e.panelType,{displayAllValues:!0,legendPlacement:"right",item:e,headerActions:()=>[new Nr({type:"view-labels",item:e}),new Nr({type:"view-flame-graph",item:e})]})})}static Component({model:e}){const{body:t,drawer:n}=e.useState();return a().createElement(a().Fragment,null,a().createElement(t.Component,{model:t}),a().createElement(n.Component,{model:n}))}constructor(){super({key:"explore-favorites",$variables:new s.Pj({variables:[new Br]}),body:new Sr({key:"favorites-grid",variableName:"favorite",mapOptionToItem:e=>{const{index:t,value:n,panelType:r,queryRunnerParams:o}=JSON.parse(e.value);return{index:t,value:n,label:e.label,queryRunnerParams:o,panelType:r}},sortItemsFn:(e,t)=>Ze(e.label,t.label),headerActions:e=>{const t=[new Nr({type:"view-labels",item:e,skipVariablesInterpolation:!0}),new Nr({type:"view-flame-graph",item:e,skipVariablesInterpolation:!0})];return e.queryRunnerParams.groupBy&&t.push(new Nr({type:"expand-panel",item:e,tooltip:()=>"Expand panel to view all the data",skipVariablesInterpolation:!0})),t.push(new yr({item:e,skipVariablesInterpolation:!0})),t}}),drawer:new Fr}),this.addActivationHandler(this.onActivate.bind(this))}}var Vr=n(5540);function qr({options:e,mainLabels:t,value:n,onChange:r,onRefresh:i}){const s=(0,l.useStyles2)(Gr),c=(0,l.useTheme2)(),[u,d]=(0,o.useState)(0),[p,m]=(0,o.useState)(0),f=p>u,h=(0,o.useRef)(null);(0,Vr.w)({ref:h,onResize:()=>{const e=h.current;e&&m(e.clientWidth)}});const y=e.filter((e=>t.includes(e.value))),b=e.filter((e=>!t.includes(e.value)));return(0,o.useEffect)((()=>{const{fontSize:e}=c.typography,t=y.map((e=>e.label||e.text||"")).join(" "),n=(0,l.measureText)(t,e).width;d(n+70*y.length)}),[y,c]),a().createElement(l.Field,{label:"Group by labels"},a().createElement("div",{ref:h,className:s.container},f?a().createElement(a().Fragment,null,a().createElement(l.RadioButtonGroup,{"aria-label":"Labels selector",options:y,value:n,onChange:r}),a().createElement(l.Select,{"aria-label":"Other labels selector",className:s.select,placeholder:"Other labels",options:b,value:n&&b.some((e=>e.value===n))?n:null,onChange:e=>{var t;return r(null!==(t=null==e?void 0:e.value)&&void 0!==t?t:"all")},isClearable:!0})):a().createElement(l.Select,{"aria-label":"Labels selector",className:s.select,value:n,placeholder:"Select label",options:e,onChange:e=>r((null==e?void 0:e.value)||Yr.DEFAULT_VALUE),isClearable:!0}),a().createElement(l.RefreshPicker,{noIntervalPicker:!0,onRefresh:i,isOnCanvas:!1,onIntervalChanged:g.f,tooltip:"Click to refresh all labels"})))}const Gr=e=>({container:i.css`
    display: flex;
    gap: ${e.spacing(1)};
  `,select:i.css`
    max-width: ${e.spacing(22)};
  `});function Kr(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Hr(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Kr(a,r,o,i,s,"next",e)}function s(e){Kr(a,r,o,i,s,"throw",e)}i(void 0)}))}}function zr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Yr extends s.fS{onActivate(){this.state.value||this.setState({value:Yr.DEFAULT_VALUE})}findCurrentOption(){const{value:e}=this.state,t=this.state.options.filter((e=>"all"!==e.value)).find((t=>JSON.parse(t.value).value===e));if(t){const e=JSON.parse(t.value);return{index:e.index,value:e.value,label:e.value,groupBy:e.groupBy}}return{index:0,value:e,label:e,groupBy:void 0}}constructor(){var e;super({key:"groupBy",name:"groupBy",label:"Group by labels",datasource:Lt,query:'$dataSource and $profileMetricId{service_name="$serviceName"}',loading:!0}),e=this,zr(this,"update",Hr((function*(){if(e.state.loading)return;let t=[],n=null;e.setState({loading:!0,options:[],error:null});try{t=yield(0,Nt.lastValueFrom)(e.getValueOptions({}))}catch(e){n=e}finally{e.setState({loading:!1,options:t,error:n})}}))),zr(this,"onChange",(e=>{(0,f.r)("g_pyroscope_app_group_by_label_clicked"),u(),this.changeValueTo(e)})),this.changeValueTo=this.changeValueTo.bind(this),this.addActivationHandler(this.onActivate.bind(this))}}zr(Yr,"DEFAULT_VALUE","all"),zr(Yr,"MAX_MAIN_LABELS",8),zr(Yr,"Component",(({model:e})=>{const t=(0,l.useStyles2)(Qr),{loading:n,value:r,options:i,error:s}=e.useState(),c=(0,o.useMemo)((()=>i.map((({label:e,value:t})=>"all"===t?{label:e,value:t}:{label:e,value:JSON.parse(String(t)).value}))),[i]);if(n)return a().createElement(l.Field,{label:"Group by labels"},a().createElement(l.Spinner,{className:t.spinner}));if(s)return a().createElement(l.Field,{label:"Group by labels"},a().createElement("div",{className:t.groupByErrorContainer},a().createElement(l.Tooltip,{theme:"error",content:s.toString()},a().createElement(l.Icon,{className:t.iconError,name:"exclamation-triangle",size:"xl"})),a().createElement(l.RefreshPicker,{noIntervalPicker:!0,onRefresh:e.update,isOnCanvas:!1,onIntervalChanged:g.f})));return a().createElement(qr,{options:c,value:r,mainLabels:(e=>e.slice(0,Yr.MAX_MAIN_LABELS).map((({value:e})=>e)))(c),onChange:e.onChange,onRefresh:e.update})}));const Qr=e=>({spinner:i.css`
    height: 32px;
    line-height: 32px;
  `,groupByErrorContainer:i.css`
    display: flex;
  `,iconError:i.css`
    height: 32px;
    align-self: center;
    color: ${e.colors.error.text};
  `});function Wr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Jr extends s.Bs{onActivate(e,t){e&&this.initVariables(e),this.setState({body:this.buildTimeseries(e,t)}),t&&this.subscribeToGroupByStateChanges(e)}initVariables(e){const{serviceName:t,profileMetricId:n,filters:r}=e.queryRunnerParams;if(t){s.jh.findByKeyAndType(this,"serviceName",qt).changeValueTo(t)}if(n){s.jh.findByKeyAndType(this,"profileMetricId",$t).changeValueTo(n)}if(r){s.jh.findByKeyAndType(this,"filters",on).setState({filters:r})}}buildTimeseries(e,t){const{headerActions:n}=this.state,r={index:0,value:"",queryRunnerParams:{},label:this.buildTitle(),panelType:ln.TIMESERIES};e&&t&&(r.queryRunnerParams.groupBy=e.queryRunnerParams.groupBy);const o=s.jh.findByKeyAndType(this,"groupBy",Yr).state.value;return new qn({item:r,headerActions:n,data:!e&&t&&o&&"all"!==o?new s.Es({$data:new s.dt({datasource:_t,queries:[]}),transformations:[bn,vn]}):void 0})}subscribeToGroupByStateChanges(e){const t=s.jh.findByKeyAndType(this,"groupBy",Yr);this._subs.add(t.subscribeToState(((n,r)=>{!n.loading&&n.options.length&&(e||!r.loading?n.value!==r.value&&this.onGroupByChanged(t):this.onGroupByChanged(t))})))}onGroupByChanged(e){var t;if(!e.state.value||"all"===e.state.value)return void this.resetTimeseries();const{index:n,value:r,groupBy:o}=e.findCurrentOption();null===(t=this.state.body)||void 0===t||t.updateItem({index:n,label:`${this.buildTitle()}, grouped by ${r}`,queryRunnerParams:{groupBy:o}})}resetTimeseries(e=!1){var t;e&&s.jh.findByKeyAndType(this,"filters",on).reset(),null===(t=this.state.body)||void 0===t||t.updateItem({index:0,label:this.buildTitle(),queryRunnerParams:{groupBy:void 0}})}buildTitle(){const e=an(this,"profileMetricId"),{description:t}=jt(e);return t||Fn(e)}static Component({model:e}){const{body:t}=e.useState();return t&&a().createElement(t.Component,{model:t})}constructor({item:e,headerActions:t,supportGroupBy:n}){super({headerActions:t,body:void 0}),Wr(this,"_variableDependency",new s.Sh(this,{variableNames:["serviceName","profileMetricId"],onReferencedVariableValueChanged:e=>{this.resetTimeseries("serviceName"===e.state.name)}})),this.addActivationHandler(this.onActivate.bind(this,e,n))}}Wr(Jr,"MIN_HEIGHT",240);class Xr extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Xr,"type","view-diff-flame-graph");var Zr=n(9897);class eo extends h.BusEventWithPayload{}function to({option:e,checked:t,onChange:n}){var r;const s=(0,l.useStyles2)(no),[c,u]=(0,o.useState)(!1),d=(0,o.useRef)(null),p=null===(r=d.current)||void 0===r?void 0:r.closest("label");return(0,o.useEffect)((()=>{if(!p||t)return void u(!1);const e=()=>{u(!0)},n=()=>{u(!1)};return p.addEventListener("mouseenter",e),p.addEventListener("mouseleave",n),()=>{p.removeEventListener("mouseleave",n),p.removeEventListener("mouseenter",e)}}),[t,p]),a().createElement(a().Fragment,null,a().createElement(l.Tooltip,{content:e.description,show:!t&&c,placement:"top"},a().createElement("span",{className:s.tooltipAnchor})),a().createElement(l.Checkbox,{ref:d,className:(0,i.cx)(s.checkbox,"checkbox",t&&"checked"),checked:t,label:e.label,onChange:()=>n(e.value)}))}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(eo,"type","select-for-compare");const no=e=>({tooltipAnchor:i.css`
    position: relative;
    left: 42px;
  `,checkbox:i.css`
    column-gap: 4px;

    &:last-child {
      & :nth-child(1) {
        grid-column-start: 2;
      }
      & :nth-child(2) {
        grid-column-start: 1;
      }
    }

    span {
      color: ${e.colors.text.secondary};
    }
    span:hover {
      color: ${e.colors.text.primary};
    }

    &.checked span {
      color: ${e.colors.text.primary};
    }
  `});function ro({item:e,itemStats:t,statsDescription:n,compareActionChecks:r,onChangeCompareTarget:i}){const s=(0,l.useStyles2)(oo),{index:c,value:u}=e,d=dn(c),p=(0,o.useMemo)((()=>{if(!t)return a().createElement(l.Spinner,{inline:!0});const{allValuesSum:e,unit:n}=t,{text:r,suffix:o}=(0,h.getValueFormat)(n)(e);return`${r}${o}`}),[t]),m=(0,o.useMemo)((()=>[{label:"Baseline",value:Zr.N.BASELINE,description:r[0]?"":`Click to select "${u}" as baseline for comparison`},{label:"Comparison",value:Zr.N.COMPARISON,description:r[1]?"":`Click to select "${u}" as target for comparison`}]),[r,u]);return a().createElement("div",{className:s.container,"data-testid":`stats-panel-${u}`},a().createElement("h1",{style:{color:d},className:s.title,title:`${n}: ${p}`},p),a().createElement("div",{className:s.compareActions},a().createElement(to,{option:m[0],checked:r[0],onChange:i}),a().createElement(to,{option:m[1],checked:r[1],onChange:i})))}const oo=e=>({container:i.css`
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 100%;
    background-color: ${e.colors.background.canvas};
    padding: ${e.spacing(1)};
    border: 1px solid ${e.colors.border.weak};
    border-right: none;
    border-radius: 2px 0 0 2px;
  `,title:i.css`
    font-size: 24px;
    width: 100%;
    text-align: center;
    margin-top: ${e.spacing(5)};
  `,compareActions:i.css`
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    border-top: 1px solid ${e.colors.border.weak};
    padding: ${e.spacing(1)} 0 0 0;

    & .checkbox:nth-child(2) {
      padding-right: 4px;
      border-right: 1px solid ${e.colors.border.strong};
    }
    & .checkbox:nth-child(4) {
      padding-left: 4px;
    }
  `});function ao(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class io extends s.Bs{onActivate(){const e=s.jh.findByKeyAndType(this,"group-by-labels",To).getCompare();this.updateCompareActions(e.get(Zr.N.BASELINE),e.get(Zr.N.COMPARISON)),this.setState({statsDescription:this.getStatsDescription()})}updateCompareActions(e,t){const{item:n}=this.state;this.setState({compareActionChecks:[(null==e?void 0:e.value)===n.value,(null==t?void 0:t.value)===n.value]})}getStatsDescription(){const e=an(this,"profileMetricId"),{description:t}=jt(e);return t||Fn(e)}getStats(){return this.state.itemStats}updateStats(e){this.setState({itemStats:e})}static Component({model:e}){const{item:t,itemStats:n,statsDescription:r,compareActionChecks:o}=e.useState();return a().createElement(ro,{item:t,itemStats:n,statsDescription:r,compareActionChecks:o,onChangeCompareTarget:e.onChangeCompareTarget})}constructor({item:e}){super({item:e,itemStats:void 0,compareActionChecks:[!1,!1],statsDescription:""}),ao(this,"onChangeCompareTarget",(e=>{this.publishEvent(new eo({compareTarget:e,item:this.state.item}),!0)})),this.addActivationHandler(this.onActivate.bind(this))}}ao(io,"WIDTH_IN_PIXELS",186);class so extends s.Bs{static buildPanelKey(e){return`compare-panel-${e.value}`}onActivate(){const{statsPanel:e,timeseriesPanel:t}=this.state,n=t.subscribeToEvent(v,(t=>{var n,r;const o=null===(n=t.payload.series)||void 0===n?void 0:n[0];if(!o)return void e.updateStats({allValuesSum:0,unit:"short"});const a=mn(o,"allValuesSum")||0;(null===(r=e.getStats())||void 0===r?void 0:r.allValuesSum)!==a&&e.updateStats({allValuesSum:a,unit:o.fields[1].config.unit||"short"})}));return()=>{n.unsubscribe()}}static Component({model:e}){const t=(0,l.useStyles2)(lo),{statsPanel:n,timeseriesPanel:r}=e.useState(),{compareActionChecks:o}=n.useState(),s=o[0]||o[1];return a().createElement("div",{className:(0,i.cx)(t.container,s&&"selected")},a().createElement("div",{className:t.statsPanel},a().createElement(n.Component,{model:n})),a().createElement("div",{className:t.timeseriesPanel},a().createElement(r.Component,{model:r})))}constructor({item:e,headerActions:t}){super({key:"label-value-panel",statsPanel:new io({item:e}),timeseriesPanel:new qn({item:e,headerActions:t})}),this.addActivationHandler(this.onActivate.bind(this))}}const lo=e=>({container:i.css`
    display: flex;
    min-width: 0px;
    min-height: ${uo};
    flex-flow: row;

    box-sizing: border-box;
    border: 1px solid transparent;
    &.selected {
      border: 1px solid ${e.colors.primary.main};
    }

    & > div {
      display: flex;
      position: relative;
      flex-direction: row;
      align-self: stretch;
      min-height: ${uo};
    }
  `,statsPanel:i.css`
    width: ${io.WIDTH_IN_PIXELS}px;
  `,timeseriesPanel:i.css`
    flex-grow: 1;

    & [data-viz-panel-key] > * {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
  `});function co({label:e}){const t='service_name="$serviceName"';return new s.dt({datasource:_t,queries:[{refId:`$profileMetricId-${t}-${e}`,queryType:"metrics",profileTypeId:"$profileMetricId",labelSelector:`{${t}}`,groupBy:[e]}]})}const uo="160px";class po extends s.Bs{static buildGridItemKey(e){return`grid-item-${e.index}-${e.value}`}onActivate(){this.subscribeOnceToDataChange();const e=this.subscribeToGroupByChange(),t=this.subscribeToRefreshClick(),n=this.subscribeToQuickFilterChange(),r=this.subscribeToLayoutChange(),o=this.subscribeToHideNoDataChange(),a=this.subscribeToFiltersChange();return()=>{a.unsubscribe(),o.unsubscribe(),r.unsubscribe(),n.unsubscribe(),t.unsubscribe(),e.unsubscribe()}}subscribeOnceToDataChange(e=!1){const t=this.state.$data.subscribeToState((n=>{var r;(null===(r=n.data)||void 0===r?void 0:r.state)!==h.LoadingState.Loading&&(t.unsubscribe(),this.renderGridItems(e),this.setState({isLoading:!1}))}))}subscribeToGroupByChange(){return s.jh.findByKeyAndType(this,"groupBy",Yr).subscribeToState(((e,t)=>{!e.loading&&t.loading&&this.refetchData()}))}subscribeToRefreshClick(){const e=()=>{this.refetchData()},t=document.querySelector('[data-testid="data-testid RefreshPicker run button"]');return t||y.v.error(new Error("SceneByVariableRepeaterGrid: Refresh button not found! The list of items will never be updated.")),null==t||t.addEventListener("click",e),null==t||t.setAttribute("title","Click to completely refresh all the panels present on the screen"),{unsubscribe(){null==t||t.removeAttribute("title"),null==t||t.removeEventListener("click",e)}}}subscribeToQuickFilterChange(){const e=s.jh.findByKeyAndType(this,"quick-filter",lr);this.subscribeToState(((t,n)=>{t.items.length!==n.items.length&&e.setResultsCount(t.items.length)}));return e.subscribeToState((0,b.debounce)(((e,t)=>{e.searchText!==(null==t?void 0:t.searchText)&&this.renderGridItems()}),lr.DEBOUNCE_DELAY))}subscribeToLayoutChange(){const e=s.jh.findByKeyAndType(this,"layout-switcher",or),t=this.state.body,n=(e,n)=>{e.layout!==(null==n?void 0:n.layout)&&t.setState({templateColumns:e.layout===rr.ROWS?"1fr":"repeat(auto-fit, minmax(600px, 1fr))"})};return n(e.state),e.subscribeToState(n)}subscribeToHideNoDataChange(){const e=s.jh.findByKeyAndType(this,"no-data-switcher",ir);this.setState({hideNoData:"on"===e.state.hideNoData});return e.subscribeToState(((e,t)=>{e.hideNoData!==(null==t?void 0:t.hideNoData)&&(this.setState({hideNoData:"on"===e.hideNoData}),this.refetchData(!0))}))}subscribeToFiltersChange(){const e=s.jh.findByKeyAndType(this,"filters",on),t=s.jh.findByKeyAndType(this,"no-data-switcher",ir);return e.subscribeToState((()=>{"on"===t.state.hideNoData&&this.refetchData()}))}refetchData(e=!1){this.setState({isLoading:!0,$data:new s.Es({$data:co({label:this.state.label}),transformations:[bn,vn]})}),this.subscribeOnceToDataChange(e)}shouldRenderItems(e){const{items:t}=this.state;return!e.length||t.length!==e.length||!(0,b.isEqual)(t,e)}buildItemsData(e){const t=an(this,"serviceName"),n=an(this,"profileMetricId"),{label:r,startColorIndex:o,sortItemsFn:a}=this.state,i=e.map(((e,a)=>{var i;const s=e.fields[1],l=(null===(i=s.labels)||void 0===i?void 0:i[r])||"",c=pn(s,r);return{index:o+a,value:l,label:c,queryRunnerParams:{serviceName:t,profileMetricId:n,filters:[{key:r,operator:"=",value:l}]},panelType:ln.TIMESERIES}}));return this.filterItems(i).sort(a)}renderGridItems(e=!1){if(!this.state.$data.state.data)return;const{state:t,series:n,errors:r}=this.state.$data.state.data;if(t===h.LoadingState.Loading)return;if(t===h.LoadingState.Error)return void this.renderErrorState(null==r?void 0:r[0]);const o=this.buildItemsData(n);if(!e&&!this.shouldRenderItems(o))return;if(this.setState({items:o}),!this.state.items.length)return void this.renderEmptyState();const a=o.map((e=>new s.xK({key:po.buildGridItemKey(e),body:this.buildVizPanel(e)})));this.state.body.setState({autoRows:uo,children:a})}buildVizPanel(e){const t=new so({item:e,headerActions:this.state.headerActions.bind(null,e,this.state.items)}),n=t.subscribeToEvent(v,(e=>{var n;if(!this.state.hideNoData||(null===(n=e.payload.series)||void 0===n?void 0:n.length))return;const r=s.jh.getAncestor(t,s.xK),{key:o}=r.state,a=s.jh.getAncestor(r,s.gF),i=a.state.children.filter((e=>e.state.key!==o));i.length?a.setState({children:i}):this.renderEmptyState()}));return t.addActivationHandler((()=>()=>{n.unsubscribe()})),t}filterItems(e){const t=s.jh.findByKeyAndType(this,"quick-filter",lr),{searchText:n}=t.state;if(!n)return e;const r=n.split(",").map((e=>e.trim())).filter(Boolean).map((e=>{try{return new RegExp(e)}catch(e){return null}})).filter(Boolean);return e.filter((({label:e})=>r.some((t=>t.test(e)))))}renderEmptyState(){this.state.body.setState({autoRows:"480px",children:[new s.xK({body:new er({message:"No results"})})]})}renderErrorState(e){this.state.body.setState({autoRows:"480px",children:[new s.xK({body:new tr({message:e.message||e.toString()})})]})}static Component({model:e}){const{body:t,isLoading:n}=e.useState();return n?a().createElement(l.Spinner,null):a().createElement("div",{style:{marginBottom:"2px"}},a().createElement(t.Component,{model:t}))}constructor({key:e,label:t,startColorIndex:n,headerActions:r}){super({key:e,label:t,startColorIndex:n,items:[],isLoading:!0,$data:new s.Es({$data:co({label:t}),transformations:[bn,vn]}),hideNoData:!1,headerActions:r,sortItemsFn:vr,body:new s.gF({templateColumns:"1fr",autoRows:uo,isLazy:!0,$behaviors:[new s.Gg.K2({key:"metricCrosshairSync",sync:h.DashboardCursorSync.Crosshair})],children:[]})}),this.addActivationHandler(this.onActivate.bind(this))}}class mo extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(mo,"type","clear-label-from-filters");class fo extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(fo,"type","exclude-label-from-filters");class ho extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(ho,"type","include-label-in-filters");const go=e=>{const t=(0,l.useStyles2)(bo),{include:n,exclude:r}=function({status:e,label:t,onInclude:n,onExclude:r,onClear:o}){const a="included"===e,i="excluded"===e;return{include:{isSelected:a,tooltip:a?`Clear "${t}" from the filters`:`Include "${t}" in the filters`,onClick:a?o:n},exclude:{isSelected:i,tooltip:i?`Clear "${t}" from the filters`:`Exclude "${t}" in the filters`,onClick:i?o:r}}}(e);return a().createElement("div",{className:t.container},a().createElement(l.Button,{size:"sm",fill:"outline",variant:n.isSelected?"primary":"secondary","aria-selected":n.isSelected,className:(0,i.cx)(t.includeButton,n.isSelected&&"selected"),onClick:n.onClick,tooltip:n.tooltip,tooltipPlacement:"top","data-testid":"filter-button-include"},"Include"),a().createElement(l.Button,{size:"sm",fill:"outline",variant:r.isSelected?"primary":"secondary","aria-selected":r.isSelected,className:(0,i.cx)(t.excludeButton,r.isSelected&&"selected"),onClick:r.onClick,tooltip:r.tooltip,tooltipPlacement:"top","data-testid":"filter-button-exclude"},"Exclude"))},yo=(0,o.memo)(go),bo=e=>({container:i.css`
      display: flex;
      justify-content: center;
    `,includeButton:i.css`
      border-radius: ${e.shape.radius.default} 0 0 ${e.shape.radius.default};

      &:not(.selected) {
        border-right: none;
      }
    `,excludeButton:i.css`
      border-radius: 0 ${e.shape.radius.default} ${e.shape.radius.default} 0;

      &:not(.selected) {
        border-left: none;
      }
    `});function vo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Eo extends s.Bs{getStatus(e){const{key:t,value:n}=this.state.item.queryRunnerParams.filters[0],r=e.find((e=>e.key===t));return r?ke(r.operator)&&r.value.split("|").includes(n)?"=~"===r.operator?"included":"excluded":r.value===n?"="===r.operator?"included":"excluded":"clear":"clear"}constructor({item:e}){super({item:e}),vo(this,"onInclude",(()=>{(0,f.r)("g_pyroscope_app_include_action_clicked"),this.publishEvent(new ho({item:this.state.item}),!0)})),vo(this,"onExclude",(()=>{(0,f.r)("g_pyroscope_app_exclude_action_clicked"),this.publishEvent(new fo({item:this.state.item}),!0)})),vo(this,"onClear",(()=>{this.publishEvent(new mo({item:this.state.item}),!0)}))}}function So({compare:e,onClickCompare:t,onClickClear:n}){const r=(0,l.useStyles2)(wo),s=e.size<2,c=e.size>0,u=(0,o.useMemo)((()=>{var t,n,r,o;return 2===e.size?`Compare "${null===(r=e.get(Zr.N.BASELINE))||void 0===r?void 0:r.label}" vs "${null===(o=e.get(Zr.N.COMPARISON))||void 0===o?void 0:o.label}"`:0===e.size?"Select both a baseline and a comparison panel to compare their flame graphs":e.has(Zr.N.BASELINE)?`Select another panel to compare against "${null===(t=e.get(Zr.N.BASELINE))||void 0===t?void 0:t.label}"`:`Select another panel to compare against "${null===(n=e.get(Zr.N.COMPARISON))||void 0===n?void 0:n.label}"`}),[e]);return a().createElement("div",{className:r.container},a().createElement(l.Button,{"arial-label":"Compare",className:r.compareButton,variant:"primary",disabled:s,onClick:s?g.f:t,tooltip:u},"Compare (",e.size,"/2)"),a().createElement(l.Button,{"data-testid":"clearComparison",className:(0,i.cx)(r.clearButton,s?void 0:r.clearButtonActive),icon:"times",variant:"secondary",tooltip:c?"Clear comparison selection":"",disabled:!c,onClick:c?n:g.f}))}vo(Eo,"Component",(({model:e})=>{const{item:t}=e.useState(),{filters:n}=s.jh.findByKeyAndType(e,"filters",on).useState(),r=(0,o.useMemo)((()=>e.getStatus(n)),[n,e]);return a().createElement(yo,{label:t.value,status:r,onInclude:e.onInclude,onExclude:e.onExclude,onClear:e.onClear})}));const wo=e=>({container:i.css`
    display: flex;
    align-items: center;
    width: ${io.WIDTH_IN_PIXELS}px;
  `,compareButton:i.css`
    width: ${io.WIDTH_IN_PIXELS-32}px;
    border-right: none;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
  `,clearButton:i.css`
    box-sizing: border-box;
    width: 32px !important;
    height: 32px !important;
    color: ${e.colors.text.secondary};
    background-color: transparent;
    border-left: none !important;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;

    &:not([disabled]),
    &:not([disabled]):hover {
      background-color: transparent;
      box-shadow: none;
    }
  `,clearButtonActive:i.css`
    border-color: ${e.colors.border.medium};

    &:hover {
      border-color: ${e.colors.border.medium};
    }
  `});function Oo(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function xo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class To extends s.Bs{onActivate(e){var t,n=this;return(t=function*(){const t=s.jh.findByKeyAndType(n,"groupBy",Yr);yield t.update(),e&&n.initVariablesAndControls(e),n.renderBody(t);const r=n.subscribeToGroupByChange(),o=n.subscribeToPanelEvents();return()=>{var e;o.unsubscribe(),r.unsubscribe(),null===(e=n.state.panelTypeChangeSub)||void 0===e||e.unsubscribe()}},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){Oo(a,r,o,i,s,"next",e)}function s(e){Oo(a,r,o,i,s,"throw",e)}i(void 0)}))})()}initVariablesAndControls(e){const{queryRunnerParams:t,panelType:n}=e,{groupBy:r}=t;if(null==r?void 0:r.label){s.jh.findByKeyAndType(this,"groupBy",Yr).changeValueTo(r.label)}if(n){s.jh.findByKeyAndType(this,"panel-type-switcher",cn).setState({panelType:n})}}subscribeToGroupByChange(){const e=s.jh.findByKeyAndType(this,"groupBy",Yr),t=s.jh.findByKeyAndType(this,"quick-filter",lr);return e.subscribeToState(((n,r)=>{n.value!==(null==r?void 0:r.value)&&(t.clearSearchText(),this.renderBody(e))}))}subscribeToPanelEvents(){const e=this.subscribeToEvent(Or,(e=>{this.selectLabel(e.payload.item)})),t=this.subscribeToEvent(eo,(e=>{const{compareTarget:t,item:n}=e.payload;this.selectForCompare(t,n)})),n=this.subscribeToEvent(ho,(e=>{this.includeLabelValueInFilters(e.payload.item)})),r=this.subscribeToEvent(fo,(e=>{this.excludeLabelValueFromFilters(e.payload.item)})),o=this.subscribeToEvent(mo,(e=>{this.clearLabelValueFromFilters(e.payload.item)}));return{unsubscribe(){o.unsubscribe(),r.unsubscribe(),n.unsubscribe(),t.unsubscribe(),e.unsubscribe()}}}subscribeToPanelTypeChange(){return s.jh.findByKeyAndType(this,"panel-type-switcher",cn).subscribeToState(((e,t)=>{var n;e.panelType!==(null==t?void 0:t.panelType)&&(null===(n=this.state.body)||void 0===n||n.renderGridItems())}))}renderBody(e){var t;null===(t=this.state.panelTypeChangeSub)||void 0===t||t.unsubscribe(),"all"===e.state.value?(this.setState({panelTypeChangeSub:this.subscribeToPanelTypeChange()}),this.switchToLabelNamesGrid()):this.switchToLabelValuesGrid(e)}switchToLabelNamesGrid(){s.jh.findByKeyAndType(this,"quick-filter",lr).setPlaceholder("Search labels (comma-separated regexes are supported)"),this.setState({body:this.buildSceneLabelNamesGrid()})}buildSceneLabelNamesGrid(){return new Sr({key:"service-labels-grid",variableName:"groupBy",mapOptionToItem:(e,t,{serviceName:n,profileMetricId:r,panelType:o})=>{if("all"===e.value)return null;const{value:a,groupBy:i}=JSON.parse(e.value);return{index:t-1,value:a,label:a,queryRunnerParams:{serviceName:n,profileMetricId:r,groupBy:i,filters:[]},panelType:o}},headerActions:e=>[new Nr({type:"select-label",item:e}),new Nr({type:"expand-panel",item:e}),new yr({item:e})]})}switchToLabelValuesGrid(e){s.jh.findByKeyAndType(this,"quick-filter",lr).setPlaceholder("Search label values (comma-separated regexes are supported)"),this.clearCompare();const{index:t,value:n}=e.findCurrentOption();this.setState({body:this.buildSceneLabelValuesGrid(n,t)})}buildSceneLabelValuesGrid(e,t){return new po({key:"service-label-values-grid",startColorIndex:t,label:e,headerActions:e=>[new Nr({type:"view-flame-graph",item:e,tooltip:(e,t)=>{const{queryRunnerParams:n,label:r}=e,o=n.profileMetricId||an(t,"profileMetricId"),a=an(t,"groupBy");return`View the "${jt(o).type}" flame graph for "${a}=${r}"`}}),new Eo({item:e}),new yr({item:e})]})}selectLabel({queryRunnerParams:e}){const t=e.groupBy.label,n=s.jh.findByKeyAndType(this,"groupBy",Yr);u(),n.changeValueTo(t)}includeLabelValueInFilters(e){const[t]=e.queryRunnerParams.filters,n=s.jh.findByKeyAndType(this,"filters",on);n.setState({filters:Zt(n.state.filters,t)})}excludeLabelValueFromFilters(e){const t=s.jh.findByKeyAndType(this,"filters",on),[n]=e.queryRunnerParams.filters;t.setState({filters:en(t.state.filters,n)})}clearLabelValueFromFilters(e){const t=s.jh.findByKeyAndType(this,"filters",on),[n]=e.queryRunnerParams.filters;t.setState({filters:tn(t.state.filters,n)})}selectForCompare(e,t){var n;const r=new Map(this.state.compare);(null===(n=r.get(e))||void 0===n?void 0:n.value)===t.value?r.delete(e):r.set(e,t),this.setState({compare:r}),this.updateStatsPanels()}updateStatsPanels(){const{compare:e}=this.state,t=e.get(Zr.N.BASELINE),n=e.get(Zr.N.COMPARISON),r=s.jh.findAllObjects(this,(e=>e instanceof io));for(const e of r)e.updateCompareActions(t,n)}getCompare(){return this.state.compare}clearCompare(){this.setState({compare:new Map})}constructor({item:e}){super({key:"group-by-labels",body:void 0,compare:new Map,panelTypeChangeSub:void 0}),xo(this,"onClickCompareButton",(()=>{(0,f.r)("g_pyroscope_app_compare_link_clicked");const{compare:e}=this.state,{filters:t}=hr(this,e.get(Zr.N.BASELINE)),{filters:n}=hr(this,e.get(Zr.N.COMPARISON));this.publishEvent(new Xr({useAncestorTimeRange:!0,clearDiffRange:!0,baselineFilters:t,comparisonFilters:n}),!0)})),xo(this,"onClickClearCompareButton",(()=>{this.clearCompare(),this.updateStatsPanels()})),this.addActivationHandler((()=>{this.onActivate(e)}))}}xo(To,"Component",(({model:e})=>{const t=(0,l.useStyles2)(Po),{body:n,compare:r}=e.useState(),i=s.jh.findByKeyAndType(e,"groupBy",Yr),{value:c}=i.useState(),u=(0,o.useMemo)((()=>"all"===c?s.jh.findByKeyAndType(e,"profiles-explorer",Xl).state.gridControls:[s.jh.findByKeyAndType(e,"quick-filter",lr),s.jh.findByKeyAndType(e,"layout-switcher",or),s.jh.findByKeyAndType(e,"no-data-switcher",ir)]),[c,e]);return a().createElement("div",{className:t.container,"data-testid":"groupByLabelsContainer"},a().createElement(i.Component,{model:i}),a().createElement("div",{className:t.sceneControls},a().createElement(l.Stack,{wrap:"wrap"},"all"!==c&&a().createElement(So,{compare:r,onClickCompare:e.onClickCompareButton,onClickClear:e.onClickClearCompareButton}),u.map((e=>a().createElement(e.Component,{key:e.state.key,model:e}))))),n&&a().createElement(n.Component,{model:n}))}));const Po=e=>({container:i.css`
    margin-top: ${e.spacing(1)};
  `,sceneControls:i.css`
    margin-bottom: ${e.spacing(1)};

    & .quick-filter {
      flex: 1;
      min-width: 112px;
    }
  `});function Co(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function ko(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ao(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){ko(e,t,n[t])}))}return e}function jo(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}class No extends s.Bs{onActivate(e){e&&this.initVariables(e);const t=s.jh.findByKeyAndType(this,"profileMetricId",$t);t.setState({query:$t.QUERY_SERVICE_NAME_DEPENDENT}),t.update(!0);const n=this.subscribeToPanelEvents();return()=>{n.unsubscribe(),t.setState({query:$t.QUERY_DEFAULT}),t.update(!0)}}initVariables(e){const{queryRunnerParams:t}=e,{serviceName:n,profileMetricId:r,filters:o}=t;if(n){s.jh.findByKeyAndType(this,"serviceName",qt).changeValueTo(n)}if(r){s.jh.findByKeyAndType(this,"profileMetricId",$t).changeValueTo(r)}if(o){s.jh.findByKeyAndType(this,"filters",on).setState({filters:o})}}subscribeToPanelEvents(){var e=this;const t=this.subscribeToEvent(wr,function(){var t,n=(t=function*(t){e.openExpandedPanelDrawer(t.payload.item)},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){Co(a,r,o,i,s,"next",e)}function s(e){Co(a,r,o,i,s,"throw",e)}i(void 0)}))});return function(e){return n.apply(this,arguments)}}()),n=this.subscribeToEvent(Or,(()=>{this.state.drawer.close()}));return{unsubscribe(){n.unsubscribe(),t.unsubscribe()}}}getVariablesAndGridControls(){return{variables:[s.jh.findByKeyAndType(this,"serviceName",qt),s.jh.findByKeyAndType(this,"profileMetricId",$t),s.jh.findByKeyAndType(this,"filters",on)],gridControls:[]}}openExpandedPanelDrawer(e){var t;const n=an(this,"serviceName"),r=an(this,"profileMetricId"),o=`${jt(r).description||Fn(r)}, grouped by ${(null===(t=e.queryRunnerParams.groupBy)||void 0===t?void 0:t.label)||"?"}`;this.state.drawer.open({title:n,body:Gn(e.panelType,{displayAllValues:!0,legendPlacement:"right",item:jo(Ao({},e),{label:o}),headerActions:()=>[new Nr({type:"select-label",item:e}),new yr({item:e})]})})}static Component({model:e}){const{body:t,drawer:n}=e.useState();return a().createElement(a().Fragment,null,a().createElement(t.Component,{model:t}),a().createElement(n.Component,{model:n}))}constructor({item:e}){super({key:"explore-service-labels",body:new s.G1({direction:"column",$behaviors:[new s.Gg.K2({key:"metricCrosshairSync",sync:h.DashboardCursorSync.Crosshair})],children:[new s.vA({minHeight:Jr.MIN_HEIGHT,body:new Jr({item:e,headerActions:e=>e.queryRunnerParams.groupBy?[new Nr({type:"view-flame-graph",item:e}),new Nr({type:"expand-panel",item:e}),new yr({item:e})]:[new Nr({type:"view-flame-graph",item:e}),new yr({item:e})],supportGroupBy:!0})}),new s.vA({body:new To({item:e})})]}),drawer:new Fr}),this.addActivationHandler(this.onActivate.bind(this,e))}}class _o extends s.Bs{onActivate(e){s.jh.findByKeyAndType(this,"quick-filter",lr).setPlaceholder("Search profile types (comma-separated regexes are supported)"),e&&this.initVariables(e)}initVariables(e){if(e.queryRunnerParams.serviceName){s.jh.findByKeyAndType(this,"serviceName",qt).changeValueTo(e.queryRunnerParams.serviceName)}}getVariablesAndGridControls(){return{variables:[s.jh.findByKeyAndType(this,"serviceName",qt)],gridControls:[s.jh.findByKeyAndType(this,"quick-filter",lr),s.jh.findByKeyAndType(this,"layout-switcher",or)]}}static Component({model:e}){const{body:t}=e.useState();return a().createElement(t.Component,{model:t})}constructor({item:e}){super({key:"explore-service-profile-types",$variables:new s.Pj({variables:[new $t({query:$t.QUERY_SERVICE_NAME_DEPENDENT,skipUrlSync:!0})]}),body:new Sr({key:"profile-metrics-grid",variableName:"profileMetricId",mapOptionToItem:(e,t,{serviceName:n})=>({index:t,value:e.value,label:e.label,queryRunnerParams:{serviceName:n,profileMetricId:e.value},panelType:ln.TIMESERIES}),headerActions:e=>[new Nr({type:"view-labels",item:e}),new Nr({type:"view-flame-graph",item:e}),new yr({item:e})]})}),this.addActivationHandler(this.onActivate.bind(this,e))}}function Io(e,t){return{from:e,to:t,value:{from:(0,h.dateTimeParse)(e),to:(0,h.dateTimeParse)(t),raw:{from:e,to:t}}}}const Ro=()=>Io("now-30m","now");function Lo(e,t){if(t){const n=e.services.get(t)||new Map;return Array.from(n.values()).sort(((e,t)=>Ze(t.group,e.group))).map((({id:e,type:t,group:n})=>({value:e,text:`${t} (${n})`})))}return Array.from(e.profileMetrics.keys()).map((e=>jt(e))).sort(((e,t)=>Ze(t.group,e.group))).map((({id:e,type:t,group:n})=>({value:e,text:`${t} (${n})`})))}function Do(e,t){if(t){const n=e.profileMetrics.get(t)||new Set;return Array.from(n).sort(Ze).map((e=>({text:e,value:e})))}return Array.from(e.services.keys()).sort(Ze).map((e=>({text:e,value:e})))}class Fo{static build(e,t){const n=`${e}-${t.name}`,r=Fo.cache.get(n);if(r instanceof t)return r;const o=new t({dataSourceUid:e});return Fo.cache.set(n,o),o}}function $o(e){let t,n;for(const{name:r,value:o}of e)if("service_name"===r&&(t=o),"__profile_type__"===r&&(n=o),t&&n)return[t,n];return[]}function Bo(e){const t=new Map,n=new Map;if(!e.labelsSet)return y.v.warn("Pyroscope SeriesApiClient: no data received!"),{services:t,profileMetrics:n};for(const{labels:r}of e.labelsSet){const[e,o]=$o(r);if(!e||!o){y.v.warn('Pyroscope ServicesApiClient: "service_name" and/or "__profile_type__" are missing in the labels received!',r);continue}const a=t.get(e)||new Map;a.set(o,jt(o)),t.set(e,a);const i=n.get(o)||new Set;i.add(e),n.set(o,i)}return{services:t,profileMetrics:n}}function Mo(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Fo,"cache",new Map);class Uo extends j{list(e){var t,n=this;return(t=function*(){const{from:t,to:r}=e;return n.fetch("/querier.v1.QuerierService/Series",{method:"POST",body:JSON.stringify({start:t,end:r,labelNames:["service_name","__profile_type__"],matchers:[]})}).then((e=>e.json())).then(Bo)},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){Mo(a,r,o,i,s,"next",e)}function s(e){Mo(a,r,o,i,s,"throw",e)}i(void 0)}))})()}constructor(e){super(e)}}function Vo(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}const qo=new class extends F{list(e){var t,n=this;return(t=function*(){const{from:t,to:r}=Tn(e.timeRange),o=[n.apiClient.baseUrl,t,r],a=n.cacheClient.get(o);if(a){const{services:e,profileMetrics:t}=yield a;return e.size||t.size||n.cacheClient.delete(o),{services:e,profileMetrics:t}}const i=n.apiClient.list({from:t,to:r});n.cacheClient.set(o,i);try{const{services:e,profileMetrics:t}=yield i;return{services:e,profileMetrics:t}}catch(e){throw n.cacheClient.delete(o),e}},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){Vo(a,r,o,i,s,"next",e)}function s(e){Vo(a,r,o,i,s,"throw",e)}i(void 0)}))})()}constructor(e){super(e)}}({cacheClient:new R});function Go(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Ko(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Go(a,r,o,i,s,"next",e)}function s(e){Go(a,r,o,i,s,"throw",e)}i(void 0)}))}}class Ho extends s.UU{fetchSeries(e,t,n){return Ko((function*(){qo.setApiClient(Fo.build(e,Uo));try{return yield qo.list({timeRange:t})}catch(e){throw y.v.error(e,{info:"Error while loading Pyroscope series!",variableName:n||""}),e}}))()}query(){return Ko((function*(){return{state:h.LoadingState.Done,data:[{name:"PyroscopeSeries",fields:[{name:"PyroscopeSeries",type:h.FieldType.other,values:[],config:{}}],length:0}]}}))()}metricFindQuery(e,t){var n=this;return Ko((function*(){var r,o,a;const i=null===(o=t.scopedVars)||void 0===o||null===(r=o.__sceneObject)||void 0===r?void 0:r.value,l=s.jh.interpolate(i,"$dataSource"),c=s.jh.interpolate(i,"$serviceName"),u=s.jh.interpolate(i,"$profileMetricId"),d=yield n.fetchSeries(l,t.range,null===(a=t.variable)||void 0===a?void 0:a.name);switch(e){case"$dataSource and all services":return Do(d);case"$dataSource and all profile metrics":return Lo(d);case"$dataSource and only $profileMetricId services":return Do(d,u);case"$dataSource and only $serviceName profile metrics":return Lo(d,c);default:throw new TypeError(`Unsupported query "${e}"!`)}}))()}testDatasource(){return Ko((function*(){return{status:"success",message:"OK"}}))()}constructor(){super(It.type,It.uid)}}class zo extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(zo,"type","enable-sync-timeranges");class Yo extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Yo,"type","sync-refresh");class Qo extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Qo,"type","sync-timeranges");class Wo extends s.KE{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(Wo,"Component",(function({model:e}){const{hidePicker:t,isOnCanvas:n}=e.useState(),r=s.jh.getTimeRange(e),o=r.getTimeZone(),i=r.useState();return t?null:a().createElement(l.TimeRangePicker,{isOnCanvas:null==n||n,value:i.value,onChange:r.onTimeRangeChange,timeZone:o,fiscalYearStartMonth:i.fiscalYearStartMonth,onMoveBackward:e.onMoveBackward,onMoveForward:e.onMoveForward,onZoom:e.onZoom,onChangeTimeZone:r.onTimeZoneChange,onChangeFiscalYearStartMonth:e.onChangeFiscalYearStartMonth,isSynced:!1})}));const Jo=/^\d+[yYmMsSwWhHdD]$/;function Xo(e){if("string"!=typeof e)return null;if(-1!==e.indexOf("now"))return e;if(Jo.test(e))return e;if(8===e.length){const t=(0,h.toUtc)(e,"YYYYMMDD");if(t.isValid())return t.toISOString()}else if(15===e.length){const t=(0,h.toUtc)(e,"YYYYMMDDTHHmmss");if(t.isValid())return t.toISOString()}else if(24===e.length){return(0,h.toUtc)(e).toISOString()}const t=parseInt(e,10);return isNaN(t)?null:(0,h.toUtc)(t).toISOString()}function Zo(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ea(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}class ta extends h.MutableDataFrame{addRange(e){this.add(ea(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Zo(e,t,n[t])}))}return e}({},e),{isRegion:!0}))}constructor(){super(),[{name:"time",type:h.FieldType.time},{name:"timeEnd",type:h.FieldType.time},{name:"isRegion",type:h.FieldType.boolean},{name:"color",type:h.FieldType.other},{name:"text",type:h.FieldType.string}].forEach((e=>this.addField(e)))}}function na(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ra(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){na(e,t,n[t])}))}return e}function oa(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}var aa=function(e){return e.ANNOTATIONS="annotations",e.DEFAULT="default",e}({});const ia={from:(0,h.dateTime)(0),to:(0,h.dateTime)(0),raw:{from:"",to:""}};class sa extends s.Bs{onActivate(){var e;this.setState((0,b.omit)(this.getAncestorTimeRange().state,"key")),this._subs.add(this.getAncestorTimeRange().subscribeToState((e=>{this.setState((0,b.omit)(e,"key"))}))),this._subs.add(null===(e=this.getTimeseries().state.$data)||void 0===e?void 0:e.subscribeToState(((e,t)=>{var n,r,o,a,i,s;e.data&&e.data.state===h.LoadingState.Done&&((null===(n=e.data.annotations)||void 0===n?void 0:n.length)||(null===(o=t.data)||void 0===o||null===(r=o.annotations)||void 0===r?void 0:r.length)?!(null===(a=e.data.annotations)||void 0===a?void 0:a.length)&&(null===(s=t.data)||void 0===s||null===(i=s.annotations)||void 0===i?void 0:i.length)&&(e.data.annotations=t.data.annotations):this.updateTimeseriesAnnotation())})))}getAncestorTimeRange(){if(!this.parent||!this.parent.parent)throw new Error(typeof this+" must be used within $timeRange scope");return s.jh.getTimeRange(this.parent.parent)}getTimeseries(){try{const e=s.jh.getAncestor(this,s.Eb);if("timeseries"!==e.state.pluginId)throw new TypeError("Incorrect VizPanel type!");return e}catch(e){throw new Error("Ancestor timeseries panel not found!")}}updateTimeseriesAnnotation(){const{annotationTimeRange:e,annotationColor:t,annotationTitle:n}=this.state,{$data:r}=this.getTimeseries().state,o=null==r?void 0:r.state.data;if(!o)return;const a=new ta;a.addRange({color:t,text:n,time:1e3*e.from.unix(),timeEnd:1e3*e.to.unix()}),null==r||r.setState({data:oa(ra({},o),{annotations:[a]})})}setAnnotationTimeRange(e,t=!1){this.setState({annotationTimeRange:e}),t&&this.updateTimeseriesAnnotation()}nullifyAnnotationTimeRange(){this.setAnnotationTimeRange(ia)}getUrlState(){const{annotationTimeRange:e}=this.state;return{diffFrom:"string"==typeof e.raw.from?e.raw.from:e.raw.from.toISOString(),diffTo:"string"==typeof e.raw.to?e.raw.to:e.raw.to.toISOString()}}updateFromUrl(e){const{diffFrom:t,diffTo:n}=e;if(!n&&!t)return;const{annotationTimeRange:r}=this.state;var o,a;this.setAnnotationTimeRange(this.buildAnnotationTimeRange(null!==(o=Xo(t))&&void 0!==o?o:r.from,null!==(a=Xo(n))&&void 0!==a?a:r.to))}buildAnnotationTimeRange(e,t){return function(e,t,n,r,o){const a=o&&"now"===t;return{from:h.dateMath.parse(e,!1,n,r),to:h.dateMath.parse(a?"now-"+o:t,!0,n,r),raw:{from:e,to:t}}}(e,t,this.getTimeZone(),this.state.fiscalYearStartMonth,this.state.UNSAFE_nowDelay)}onTimeRangeChange(e){const{mode:t}=this.state;"default"!==t?this.setAnnotationTimeRange(e,!0):this.getAncestorTimeRange().onTimeRangeChange(e)}onTimeZoneChange(e){this.getAncestorTimeRange().onTimeZoneChange(e)}getTimeZone(){return this.getAncestorTimeRange().getTimeZone()}onRefresh(){this.getAncestorTimeRange().onRefresh()}constructor(e){super(ra({from:ia.raw.from,to:ia.raw.to,value:ia,annotationTimeRange:ia},e)),na(this,"_variableDependency",new s.Sh(this,{variableNames:["dataSource","serviceName"],onReferencedVariableValueChanged:()=>{this.nullifyAnnotationTimeRange(),this.updateTimeseriesAnnotation()}})),na(this,"_urlSync",new s.So(this,{keys:["diffFrom","diffTo"]})),this.addActivationHandler(this.onActivate.bind(this))}}class la extends h.BusEventWithPayload{}function ca(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(la,"type","switch-timerange-selection-mode");var ua=function(e){return e.TIMEPICKER="timepicker",e.FLAMEGRAPH="flame-graph",e}({});class da extends s.Bs{constructor(){super({mode:"flame-graph"}),ca(this,"onChange",(e=>{this.setState({mode:e}),this.publishEvent(new la({mode:e}),!0)}))}}ca(da,"OPTIONS",[{label:"Time picker",value:"timepicker"},{label:"Flame graph",value:"flame-graph"}]),ca(da,"Component",(({model:e})=>{const t=(0,l.useStyles2)(pa),{mode:n}=e.useState();return a().createElement("div",{className:t.container},a().createElement("label",{className:t.label},a().createElement("span",null,"Range selection mode "),a().createElement(l.Tooltip,{content:a().createElement("div",{className:t.tooltip},a().createElement("div",null,"Use these buttons to change the behaviour when selecting a range with the mouse on the time series:"),a().createElement("dl",null,a().createElement("dt",null,"Time picker"),a().createElement("dd",null,"Time range zoom in (default behaviour)"),a().createElement("dt",null,"Flame graph"),a().createElement("dd",null,"Time range for building the flame graph (the stack traces will be retrieved only for the selected range)"))),placement:"top"},a().createElement(l.Icon,{name:"question-circle"}))),a().createElement(l.RadioButtonGroup,{size:"sm",options:da.OPTIONS,value:n,onChange:e.onChange,"aria-label":"Range selection mode"}))}));const pa=e=>({container:i.css`
    display: flex;
    flex-direction: column;
  `,tooltip:i.css`
    padding: ${e.spacing(1)};
    & dl {
      margin-top: ${e.spacing(2)};
      display: grid;
      grid-gap: ${e.spacing(1)} ${e.spacing(2)};
      grid-template-columns: max-content;
    }
    & dt {
      font-weight: bold;
    }
    & dd {
      margin: 0;
      grid-column-start: 2;
    }
  `,label:i.css`
    font-size: 12px;
    text-align: right;
    margin-bottom: 2px;
    color: ${e.colors.text.secondary};
  `});function ma({filterKey:e}){return hn(new s.dt({datasource:_t,queries:[{refId:`$profileMetricId-$serviceName-${e}}`,queryType:"metrics",profileTypeId:"$profileMetricId",labelSelector:`{service_name="$serviceName",$${e}}`}]}))}var fa=n(4308),ha=n.n(fa);const ga={COLOR:ha()("#d066d4"),OVERLAY:ha()("#d066d4").alpha(.3)},ya={COLOR:ha()("#1398f6"),OVERLAY:ha()("#1398f6").alpha(.3)};function ba(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function va(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){ba(e,t,n[t])}))}return e}class Ea extends s.Bs{onActivate(e,t,n){const{$timeRange:r,timeseriesPanel:o,filterKey:a}=this.state;if(t&&this.setDiffRange(null),e&&r.setState((0,b.omit)(this.getAncestorTimeRange().state,"key")),n.length){s.jh.findByKey(this,a).setState({filters:n})}o.updateItem({label:this.buildTimeseriesTitle()});const i=this.subscribeToEvents();return()=>{i.unsubscribe()}}static buildTimeSeriesPanel({target:e,filterKey:t,title:n,color:r}){const o=new qn({item:{index:0,value:e,label:"",queryRunnerParams:{},panelType:ln.TIMESERIES},data:new s.Es({$data:ma({filterKey:t}),transformations:[bn,vn]}),overrides:e=>e.map((e=>{const t=e.fields[1],n=mn(e,"allValuesSum")||0,a=(0,h.getValueFormat)(t.config.unit)(n),i=`${a.text}${a.suffix}`,[s,l,c]=Ea.getDiffRange(o),u=s&&l?`Total = ${i} / Flame graph range = ${(0,h.dateTimeFormat)(s,{format:h.systemDateFormats.fullDate,timeZone:c})} → ${(0,h.dateTimeFormat)(l,{format:h.systemDateFormats.fullDate,timeZone:c})}`:`Total = ${i}`;return{matcher:{id:h.FieldMatcherID.byFrameRefID,options:e.refId},properties:[{id:"displayName",value:u},{id:"color",value:{mode:"fixed",fixedColor:r}}]}})),headerActions:()=>[new da]});return o.state.body.setState({$timeRange:new sa({key:`${e}-annotation-timerange`,mode:aa.ANNOTATIONS,annotationColor:e===Zr.N.BASELINE?ga.OVERLAY.toString():ya.OVERLAY.toString(),annotationTitle:`${n} flame graph range`})}),o}static getDiffRange(e){var t,n,r,o;let a,i;const s=null===(r=e.state.body.state.$data)||void 0===r||null===(n=r.state.data)||void 0===n||null===(t=n.annotations)||void 0===t?void 0:t[0];return null==s||s.fields.some((({name:e,values:t})=>(a="time"===e?t[0]:a,i="timeEnd"===e?t[0]:i,a&&i))),[a,i,null===(o=e.state.$timeRange)||void 0===o?void 0:o.state.timeZone]}getAncestorTimeRange(){if(!this.parent||!this.parent.parent)throw new Error(typeof this+" must be used within $timeRange scope");return s.jh.getTimeRange(this.parent.parent)}subscribeToEvents(){const{target:e,timeseriesPanel:t,$timeRange:n}=this.state,r=t.state.body.state.$timeRange,o=this.subscribeToEvent(la,(e=>{r.setState({mode:e.payload.mode===ua.FLAMEGRAPH?aa.ANNOTATIONS:aa.DEFAULT})})),a=r.subscribeToState(((t,n)=>{this.state.timeRangeSyncEnabled&&t.annotationTimeRange!==n.annotationTimeRange&&this.publishEvent(new Qo({source:e,annotationTimeRange:t.annotationTimeRange}),!0)})),i=n.subscribeToState(((t,n)=>{t.from===n.from&&t.to===n.to||(this.updateTitle(""),this.state.timeRangeSyncEnabled&&this.publishEvent(new Qo({source:e,timeRange:t}),!0))}));return{unsubscribe(){i.unsubscribe(),a.unsubscribe(),o.unsubscribe()}}}buildTimeseriesTitle(){const e=an(this,"profileMetricId"),{description:t}=jt(e);return t||Fn(e)}useDiffTimeRange(){return this.state.timeseriesPanel.state.body.state.$timeRange.useState()}applyPreset({from:e,to:t,diffFrom:n,diffTo:r,label:o}){this.setDiffRange({from:n,to:r}),this.setTimeRange(Io(e,t)),this.updateTitle(o)}setTimeRange(e){const{from:t,to:n}=this.state.$timeRange.state.value;t.isSame(e.value.from)&&n.isSame(e.value.to)||this.state.$timeRange.setState({from:e.from,to:e.to,value:e.value})}setDiffRange(e){const t=this.state.timeseriesPanel.state.body.state.$timeRange;if(null===e)return void t.nullifyAnnotationTimeRange();const{annotationTimeRange:n}=t.state,r=t.buildAnnotationTimeRange(e.from,e.to);n.from.isSame(r.from)&&n.to.isSame(r.to)||t.setAnnotationTimeRange(r,!0)}autoSelectDiffRange(e){const{$timeRange:t,target:n}=this.state,{from:r,to:o}=t.state.value;if(this.updateTitle(""),e)return void this.setDiffRange({from:r.toISOString(),to:o.toISOString()});const a=o.diff(r),i=Math.min(Math.round(.25*a),864e5);n===Zr.N.BASELINE?this.setDiffRange({from:r.toISOString(),to:(0,h.dateTime)(r).add(i).toISOString()}):this.setDiffRange({from:(0,h.dateTime)(o).subtract(i).toISOString(),to:o.toISOString()})}updateTitle(e=""){const t=this.state.target===Zr.N.BASELINE?"Baseline":"Comparison",n=e?`${t} (${e})`:t;this.setState({title:n})}toggleTimeRangeSync(e){this.setState({timeRangeSyncEnabled:e})}refreshTimeseries(){this.state.$timeRange.onRefresh()}constructor({target:e,useAncestorTimeRange:t,clearDiffRange:n,filters:r}){const o=e===Zr.N.BASELINE?"filtersBaseline":"filtersComparison",a=e===Zr.N.BASELINE?"Baseline":"Comparison",i=e===Zr.N.BASELINE?ga.COLOR.toString():ya.COLOR.toString();super({key:`${e}-panel`,target:e,filterKey:o,title:a,color:i,$timeRange:new s.JZ(va({key:`${e}-panel-timerange`},Io("now-1h","now"))),timePicker:new Wo({isOnCanvas:!0}),refreshPicker:new s.WM({isOnCanvas:!0}),timeseriesPanel:Ea.buildTimeSeriesPanel({target:e,filterKey:o,title:a,color:i}),timeRangeSyncEnabled:!1}),ba(this,"_variableDependency",new s.Sh(this,{variableNames:["profileMetricId"],onReferencedVariableValueChanged:()=>{this.state.timeseriesPanel.updateItem({label:this.buildTimeseriesTitle()})}})),ba(this,"onClickTimeRangeSync",(()=>{const{target:e,timeRangeSyncEnabled:t,$timeRange:n,timeseriesPanel:r}=this.state,o=r.state.body.state.$timeRange;this.publishEvent(new zo({source:e,enable:!t,timeRange:n.state,annotationTimeRange:o.state.annotationTimeRange}),!0)})),ba(this,"onClickRefresh",(()=>{this.publishEvent(new Yo({source:this.state.target}),!0)})),this.addActivationHandler(this.onActivate.bind(this,t,n,r))}}ba(Ea,"Component",(({model:e})=>{const{target:t,color:n,title:r,timeseriesPanel:o,timePicker:c,refreshPicker:u,filterKey:d,timeRangeSyncEnabled:p}=e.useState(),m=(0,l.useStyles2)(Sa,n),f=s.jh.findByKey(e,d);return a().createElement("div",{className:m.panel,"data-testid":`panel-${t}`},a().createElement("div",{className:m.panelHeader},a().createElement("h6",null,a().createElement("div",{className:m.colorCircle}),r),a().createElement("div",{className:m.timeControls},a().createElement(c.Component,{model:c}),a().createElement("div",{onClick:e.onClickRefresh},a().createElement(u.Component,{model:u})),a().createElement(l.IconButton,{className:(0,i.cx)(m.syncButton,p&&"active"),name:"link","aria-label":p?"Unsync time ranges":"Sync time ranges",tooltip:p?"Unsync time ranges":"Sync time ranges",onClick:e.onClickTimeRangeSync}))),a().createElement("div",{className:m.filter},a().createElement(f.Component,{model:f})),a().createElement("div",{className:m.timeseries},o&&a().createElement(o.Component,{model:o})))}));const Sa=(e,t)=>({panel:i.css`
    background-color: ${e.colors.background.primary};
    padding: ${e.spacing(1)} ${e.spacing(1)} 0 ${e.spacing(1)};
    border: 1px solid ${e.colors.border.weak};
    border-radius: 2px;
  `,panelHeader:i.css`
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: ${e.spacing(2)};
    flex-wrap: wrap;

    & > h6 {
      font-size: 15px;
      height: 32px;
      line-height: 32px;
      margin: 0 ${e.spacing(1)} 0 0;
    }
  `,colorCircle:i.css`
    display: inline-block;
    background-color: ${t};
    border-radius: 50%;
    width: 9px;
    height: 9px;
    margin-right: 6px;
  `,timeControls:i.css`
    display: flex;
    justify-content: flex-end;
    gap: 4px;
  `,syncButton:i.css`
    z-index: unset;
    padding: ${e.spacing(0,1)};
    margin: 0;
    background: ${e.colors.secondary.main};
    border: 1px solid ${e.colors.secondary.border};
    border-radius: ${e.shape.radius.default};

    &:hover {
      background: ${e.colors.secondary.shade};
    }

    &.active {
      color: ${e.colors.primary.text};
      border: 1px solid ${e.colors.primary.text};
    }
  `,filter:i.css`
    display: flex;
    margin-bottom: ${e.spacing(3)};
  `,timeseries:i.css`
    height: 200px;

    & [data-viz-panel-key] > * {
      border: 0 none;
    }

    & [data-viz-panel-key] [data-testid='uplot-main-div'] {
      cursor: crosshair;
    }
  `});var wa=n(8629);function Oa(){const[e,t]=(0,o.useState)(null),[n,r]=(0,o.useState)();return{onOpen(e){r((()=>e))},isOpen:t=>t===e,open(e){t(e),null==n||n()},close(){t(null)}}}var xa=n(8873),Ta=n(8536),Pa=n(7945);function Ca({children:e,delay:t}){const[n,r]=(0,o.useState)(!1);return(0,o.useEffect)((()=>{window.setTimeout((()=>{r(!0)}),t)}),[e,t]),a().createElement(a().Fragment,null,n?e:null)}function ka({menu:e,title:t,placement:n="bottom",offset:r,dragClassCancel:s,menuButtonClass:c,onVisibleChange:u,onOpenMenu:d}){const p=t?Pa.Tp.components.Panels.Panel.menu(t):"panel-menu-button",m=(0,o.useCallback)((e=>(e&&d&&d(),u)),[d,u]),f=t?`Menu for panel with title ${t}`:"Menu for panel with no title";return a().createElement(l.Dropdown,{overlay:e,placement:n,offset:r,onVisibleChange:m},a().createElement(l.ToolbarButton,{"aria-label":f,title:"Menu",icon:"ellipsis-v",iconSize:"md",narrow:!0,"data-testid":p,className:(0,i.cx)(c,s)}))}function Aa({menu:e,title:t,dragClass:n,children:r,offset:s=-32,onOpenMenu:c}){const u=(0,l.useStyles2)(ja),d=(0,o.useRef)(null),p=Pa.Tp.components.Panels.Panel.HoverWidget,m=(0,o.useCallback)((e=>{var t;null===(t=d.current)||void 0===t||t.setPointerCapture(e.pointerId)}),[]),f=(0,o.useCallback)((e=>{var t;null===(t=d.current)||void 0===t||t.releasePointerCapture(e.pointerId)}),[]),[h,g]=(0,o.useState)(!1);return void 0===r||0===a().Children.count(r)?null:a().createElement("div",{className:(0,i.cx)(u.container,{"show-on-hover":!h}),style:{top:`${s}px`},"data-testid":p.container},n&&a().createElement("div",{className:(0,i.cx)(u.square,u.draggable,n),onPointerDown:m,onPointerUp:f,ref:d,"data-testid":p.dragIcon},a().createElement(l.Icon,{name:"expand-arrows",className:u.draggableIcon})),!t&&a().createElement("h6",{className:(0,i.cx)(u.untitled,{[u.draggable]:!!n},n)},"Untitled"),r,e&&a().createElement(ka,{menu:e,title:t,placement:"bottom",menuButtonClass:u.menuButton,onVisibleChange:g,onOpenMenu:c}))}function ja(e){return{hidden:(0,i.css)({visibility:"hidden",opacity:"0"}),container:(0,i.css)({label:"hover-container-widget",transition:"all .1s linear",display:"flex",position:"absolute",zIndex:1,right:0,boxSizing:"content-box",alignItems:"center",background:e.colors.background.secondary,color:e.colors.text.primary,border:`1px solid ${e.colors.border.weak}`,borderRadius:e.shape.radius.default,height:e.spacing(4),boxShadow:e.shadows.z1}),square:(0,i.css)({display:"flex",justifyContent:"center",alignItems:"center",width:e.spacing(4),height:"100%"}),draggable:(0,i.css)({cursor:"move",[e.breakpoints.down("md")]:{display:"none"}}),menuButton:(0,i.css)({background:"inherit",border:"none","&:hover":{background:e.colors.secondary.main}}),untitled:(0,i.css)({color:e.colors.text.disabled,fontStyle:"italic",padding:e.spacing(0,1),marginBottom:0}),draggableIcon:(0,i.css)({transform:"rotate(45deg)",color:e.colors.text.secondary,"&:hover":{color:e.colors.text.primary}})}}function Na(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Na(e,t,n[t])}))}return e}function Ia(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function Ra(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}const La=(0,o.forwardRef)(((e,t)=>{var{className:n,children:r,href:o,onClick:s,target:c,title:u}=e,d=Ra(e,["className","children","href","onClick","target","title"]);const p=(0,l.useStyles2)(Da);return o?a().createElement("a",_a({ref:t,href:o,onClick:s,target:c,title:u,className:(0,i.cx)(p.linkItem,n)},d),r):s?a().createElement(l.Button,{ref:t,className:(0,i.cx)(p.item,n),variant:"secondary",fill:"text",onClick:s},r):a().createElement("span",_a({ref:t,className:(0,i.cx)(p.item,n)},d),r)}));La.displayName="TitleItem";const Da=e=>{const t=(0,i.css)({color:`${e.colors.text.secondary}`,label:"panel-header-item",cursor:"auto",border:"none",borderRadius:`${e.shape.radius.default}`,padding:`${e.spacing(0,1)}`,height:`${e.spacing(e.components.panel.headerHeight)}`,display:"flex",alignItems:"center",justifyContent:"center","&:focus, &:focus-visible":Ia(_a({},Fa(e)),{zIndex:1}),"&: focus:not(:focus-visible)":{outline:"none",boxShadow:"none"},"&:hover ":{boxShadow:`${e.shadows.z1}`,background:`${e.colors.background.secondary}`,color:`${e.colors.text.primary}`}});return{item:t,linkItem:(0,i.cx)(t,(0,i.css)({cursor:"pointer"}))}};function Fa(e){return{outline:"2px dotted transparent",outlineOffset:"2px",boxShadow:`0 0 0 2px ${e.colors.background.canvas}, 0 0 0px 4px ${e.colors.primary.main}`,transitionTimingFunction:"cubic-bezier(0.19, 1, 0.22, 1)",transitionDuration:"0.2s",transitionProperty:"outline, outline-offset, box-shadow"}}function $a({description:e,className:t}){const n=(0,l.useStyles2)(Ba);return""!==e?a().createElement(l.Tooltip,{interactive:!0,content:()=>{const t="function"==typeof e?e():e;return a().createElement("div",{className:"panel-info-content markdown-html"},a().createElement("div",{dangerouslySetInnerHTML:{__html:t}}))}},a().createElement(La,{className:(0,i.cx)(t,n.description)},a().createElement(l.Icon,{name:"info-circle",size:"md"}))):null}const Ba=()=>({description:(0,i.css)({code:{whiteSpace:"normal",wordWrap:"break-word"},"pre > code":{display:"block"}})});function Ma({message:e,onClick:t,ariaLabel:n="status"}){const r=(0,l.useStyles2)(Ua);return a().createElement(l.ToolbarButton,{className:r.buttonStyles,onClick:t,variant:"destructive",icon:"exclamation-triangle",iconSize:"md",tooltip:e||"","aria-label":n})}const Ua=e=>{const{headerHeight:t,padding:n}=e.components.panel;return{buttonStyles:(0,i.css)({label:"panel-header-state-button",display:"flex",alignItems:"center",justifyContent:"center",padding:e.spacing(n),width:e.spacing(t),height:e.spacing(t),borderRadius:e.shape.radius.default})}};function Va({children:e,padding:t="md",title:n="",description:r="",displayMode:s="default",titleItems:c,menu:u,dragClass:d,dragClassCancel:p,hoverHeader:m=!1,hoverHeaderOffset:f,loadingState:g,statusMessage:y,statusMessageOnClick:b,actions:v,onCancelQuery:E,onOpenMenu:S}){const w=(0,l.useTheme2)(),O=(0,l.useStyles2)(Ha),[x,T]=(0,o.useState)(0),P=(0,o.useRef)(null);(0,o.useEffect)((()=>{P.current&&T(P.current.offsetWidth)}),[P]);const C=!m,k=Ga(w,C),{contentStyle:A}=Ka(t,w),j={height:k,cursor:d?"move":"auto"},N={};"transparent"===s&&(N.backgroundColor="transparent",N.border="none");const _=n?Pa.Tp.components.Panels.Panel.title(n):"Panel",I=a().createElement(a().Fragment,null,n&&a().createElement("h6",{title:n,className:O.title},n),a().createElement("div",{className:(0,i.cx)(O.titleItems,p),"data-testid":"title-items-container"},a().createElement($a,{description:r,className:p}),c),g===h.LoadingState.Streaming&&a().createElement(l.Tooltip,{content:E?"Stop streaming":"Streaming"},a().createElement(La,{className:p,"data-testid":"panel-streaming",onClick:E},a().createElement(l.Icon,{name:"circle-mono",size:"md",className:O.streaming}))),g===h.LoadingState.Loading&&E&&a().createElement(Ca,{delay:2e3},a().createElement(l.Tooltip,{content:"Cancel query"},a().createElement(La,{className:(0,i.cx)(p,O.pointer),"data-testid":"panel-cancel-query",onClick:E},a().createElement(l.Icon,{name:"sync-slash",size:"md"})))),a().createElement("div",{className:O.rightAligned},v&&a().createElement("div",{className:O.rightActions},qa(v,(e=>e)))));return a().createElement("div",{className:O.container,style:N,"data-testid":_},a().createElement("div",{className:O.loadingBarContainer},g===h.LoadingState.Loading?a().createElement(l.LoadingBar,{width:x,ariaLabel:"Panel loading bar"}):null),m&&a().createElement(a().Fragment,null,a().createElement(Aa,{menu:u,title:n,offset:f,dragClass:d,onOpenMenu:S},I),y&&a().createElement("div",{className:O.errorContainerFloating},a().createElement(Ma,{message:y,onClick:b,ariaLabel:"Panel status"}))),C&&a().createElement("div",{className:(0,i.cx)(O.headerContainer,d),style:j,"data-testid":"header-container"},y&&a().createElement("div",{className:p},a().createElement(Ma,{message:y,onClick:b,ariaLabel:"Panel status"})),I,u&&a().createElement(ka,{menu:u,title:n,placement:"bottom-end",menuButtonClass:(0,i.cx)(O.menuItem,p,"show-on-hover"),onOpenMenu:S})),a().createElement("div",{className:O.content,style:A,ref:P},e))}const qa=(e,t)=>{const n=a().Children.toArray(e).filter(Boolean);return n.length>0?t(n):null},Ga=(e,t)=>t?e.spacing.gridSize*e.components.panel.headerHeight:0,Ka=(e,t)=>({contentStyle:{padding:("md"===e?t.components.panel.padding:0)*t.spacing.gridSize}}),Ha=e=>{const{background:t,borderColor:n,padding:r}=e.components.panel;return{container:(0,i.css)({label:"panel-container",backgroundColor:t,border:`1px solid ${n}`,position:"relative",borderRadius:e.shape.radius.default,height:"100%",display:"flex",flexDirection:"column",".show-on-hover":{visibility:"hidden",opacity:"0"},"&:focus-visible, &:hover":{".show-on-hover":{visibility:"visible",opacity:"1"}},"&:focus-visible":{outline:`1px solid ${e.colors.action.focus}`},"&:focus-within":{".show-on-hover":{visibility:"visible",opacity:"1"}}}),loadingBarContainer:(0,i.css)({label:"panel-loading-bar-container",position:"absolute",top:0,width:"100%",overflow:"hidden"}),content:(0,i.css)({label:"panel-content",flexGrow:1}),headerContainer:(0,i.css)({label:"panel-header",display:"flex",alignItems:"center"}),pointer:(0,i.css)({cursor:"pointer"}),streaming:(0,i.css)({label:"panel-streaming",marginRight:0,color:e.colors.success.text,"&:hover":{color:e.colors.success.text}}),title:(0,i.css)({label:"panel-title",marginBottom:0,padding:e.spacing(0,r),textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap",fontSize:e.typography.h6.fontSize,fontWeight:e.typography.h6.fontWeight}),items:(0,i.css)({display:"flex"}),item:(0,i.css)({display:"flex",justifyContent:"center",alignItems:"center"}),hiddenMenu:(0,i.css)({visibility:"hidden"}),menuItem:(0,i.css)({label:"panel-menu",border:"none",background:e.colors.secondary.main,"&:hover":{background:e.colors.secondary.shade}}),errorContainerFloating:(0,i.css)({label:"error-container",position:"absolute",left:0,top:0,zIndex:e.zIndex.tooltip}),rightActions:(0,i.css)({display:"flex",padding:e.spacing(0,r),gap:e.spacing(1)}),rightAligned:(0,i.css)({label:"right-aligned-container",marginLeft:"auto",display:"flex",alignItems:"center"}),titleItems:(0,i.css)({display:"flex",height:"100%"})}},za=e=>({panelWrap:i.css`
    margin-bottom: ${e.spacing(1)};
  `});function Ya({isLoading:e,title:t,description:n,children:r,className:o="",headerActions:i,dataTestId:s}){const c=(0,l.useStyles2)(za),u=e?h.LoadingState.Loading:h.LoadingState.Done;return a().createElement("div",{className:`${o} ${c.panelWrap}`,"data-testid":s||"panel"},a().createElement(Va,{loadingState:u,title:t,description:n,actions:i},r))}var Qa=n(9660),Wa=n(1630),Ja=n(7616);function Xa({children:e,onClick:t,disabled:n,interactionName:r}){const o=(0,l.useStyles2)(Za),{isEnabled:i,error:s,isFetching:c}=function(){const{data:e,isFetching:t,error:n}=(0,Ja.I)({queryKey:["llm"],queryFn:()=>Wa.Sn()});return n&&y.v.error(n,{info:"Error while checking the status of the Grafana LLM plugin!"}),{isEnabled:Boolean(e),isFetching:t,error:n}}();let u="ai",d="";return c?(u="fa fa-spinner",d="Checking the status of the Grafana LLM plugin..."):s?(u="exclamation-triangle",d="Error while checking the status of the Grafana LLM plugin!"):i||(u="shield-exclamation",d="Grafana LLM plugin missing or not configured! Please check the plugins administration page."),a().createElement(l.Button,{className:o.aiButton,size:"md",fill:"text",icon:u,disabled:!i||n,tooltip:d,tooltipPlacement:"top",onClick:e=>{(0,f.r)(r),t(e)}},e)}const Za=()=>({aiButton:i.css`
    padding: 0 4px;
  `});var ei=n(7879);const ti=e=>{const t=document.querySelector('[placeholder^="Search"]');if(null===t)return void y.v.error(new Error("Cannot find search input element!"));((e,t)=>{const n=Object.getOwnPropertyDescriptor(e,"value").set,r=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(e),"value").set;n&&n!==r?r.call(e,t):n.call(e,t)})(t,e.target.textContent.trim()),t.dispatchEvent(new Event("input",{bubbles:!0}))},ni={overrides:{code:{component:({children:e})=>{const t=(0,l.useStyles2)(oi);return"string"==typeof e&&e.includes("\n")?a().createElement("code",null,e):a().createElement("code",{className:t.searchLink,title:"Search for this node",onClick:ti},e)}}}};function ri({reply:e}){var t;const n=(0,l.useStyles2)(oi);return a().createElement("div",{className:n.container},null==e||null===(t=e.messages)||void 0===t?void 0:t.filter((e=>"system"!==e.role)).map((e=>a().createElement(a().Fragment,null,a().createElement("div",{className:n.reply},a().createElement(ei.Ay,{options:ni},e.content)),a().createElement("hr",null)))),a().createElement("div",{className:n.reply},a().createElement(ei.Ay,{options:ni},e.text)))}const oi=()=>({container:i.css`
    width: 100%;
    height: 100%;
  `,reply:i.css`
    font-size: 13px;

    & ol,
    & ul {
      margin: 0 0 16px 24px;
    }
  `,searchLink:i.css`
    color: rgb(255, 136, 51);
    border: 1px solid transparent;
    padding: 2px 4px;
    cursor: pointer;
    font-size: 13px;

    &:hover,
    &:focus,
    &:active {
      box-sizing: border-box;
      border: 1px solid rgb(255, 136, 51, 0.8);
      border-radius: 4px;
    }
  `}),ai=()=>({textarea:i.css`
    margin-bottom: 8px;
  `,sendButton:i.css`
    float: right;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  `});function ii({onSubmit:e}){const t=(0,l.useStyles2)(ai),{question:n,onChangeInput:r,onClickSend:i}=function(e){const[t,n]=(0,o.useState)(""),r=(0,o.useCallback)((e=>{n(e.target.value)}),[]),a=(0,o.useCallback)((()=>{const r=t.trim();r&&(e(r),n(""))}),[t,e]);return{question:t,onChangeInput:r,onClickSend:a}}(e);return a().createElement("div",null,a().createElement(l.TextArea,{className:t.textarea,placeholder:"Ask a follow-up question...",value:n,onChange:r,onKeyDown:e=>{"Enter"!==e.code||e.shiftKey||i()}}),a().createElement(l.Button,{className:t.sendButton,onClick:i},"Send"))}const si={system:{empty:()=>"\n    You are a performance profiling expert and excel at analyzing profiles in the DOT format.\n    In the DOT format, a row like N47 -> N61 means the function from N47 called the function from N61.\n"},user:{single:(e,t)=>`\n    Analyze this flamegraph in DOT format and address these key aspects:\n    - **Performance Bottleneck**: Identify the primary factors slowing down the process, consuming excessive memory, or causing a bottleneck in the system.\n    - **Root Cause**: Explain clearly why these bottlenecks are occurring.\n    - **Recommended Fix**: Suggest practical solutions for these issues.\n\n    Guidelines:\n    - Always use full function names without splitting them from package names.\n    - Exclude numeric values, percentages, and node names (e.g., N1, N3, Node 1, Node 2).\n    - Focus on user code over low-level runtime optimizations.\n    - For standard library or runtime functions, explain their presence/function and link them to user code functions calling them. Avoid repetitive mentions from the same call chain.\n    - Do not mention that the flamegraph profile is in DOT format.\n    - Only use h5 and h6 markdown headers (e.g., ##### Performance Bottleneck, ###### Recommended Fix)\n    - Do not use h1,h2,h3,h4 headers (e.g., ## Bottleneck, ### Root Cause, #### Recommended Fix)\n\n    Format the response using markdown headers for each section corresponding to the key aspects.\n\n    The profile type is: ${e}\n    Profile in DOT format:\n    ${t[0]}\n`,anton:(e,t)=>`\nGive me actionable feedback and suggestions on how I improve the application performance.\n\nDo not break function names.\nDo not show any numeric values, absolute or percents.\nDo not show node names like N1, N3, or Node 1, Node 2.\nDo not suggest low-level runtime optimisations, focus on the user code.\n\nAlways use full function names.\nNever split function and package name.\n\nRemove any numeric values, absolute or percents, from the output.\nRemove node names like N1, N3, or Node 1, Node 2 from the output.\n\nIf the function is widely known (e.g., a runtime or stdlib function), provide me concise explanation why the function is present in the profile and what could be the cause.\nIf a function is defined in the runtime or in the standard library, tell me which function in the user code calls it.\nAvoid mentioning functions from the same call-chain.\n\n5 suggestions is enough.\nThe profile type is ${e}\nBelow is the performance profile in DOT format:\n${t[0]}\n`,diff:(e,t)=>`\nAnalyze the differences between these two performance profiles presented in DOT format. Provide a detailed comparison focusing on the following aspects:\n\n- Performance Change: Determine how the performance has changed from the first profile to the second. Identify if there are new bottlenecks, improved or worsened performance areas, or significant changes in resource consumption.\n- Function Impact: Highlight no more than 3 specific functions that have undergone notable changes in their performance impact. Discuss any new functions that have appeared in the second profile or any existing functions that have significantly increased or decreased in resource usage.\n- Potential Causes: Discuss the possible reasons for these changes in performance, linking them to the differences in function execution or resource usage between the two profiles.\n\nGuidelines for Analysis:\n- Use full function names without separating them from their package names\n- Focus on user code rather than low-level runtime optimizations or standard library functions unless they are directly relevant to the user code's performance changes\n- Exclude numeric values, percentages, and node names (e.g., N1, N3, Node 1, Node 2) from the analysis\n- Format the response using markdown headers for each section to structure the analysis clearly\n\nThe profile type is: ${e}\n\nFirst performance profile in DOT format:\n${t[0]}\n\nSecond performance profile in DOT format:\n${t[1]}\n`}},li=({system:e,user:t,profileType:n,profiles:r})=>{const o=si.system[e];if("function"!=typeof o)throw new Error(`Cannot find system prompt "${e}"!`);const a=si.user[t];if("function"!=typeof a)throw new Error(`Cannot find user prompt "${t}"!`);return{system:o(n,r),user:a(n,r)}};function ci(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}class ui extends j{get(e){var t,n=this;return(t=function*(){const t=new URLSearchParams({query:e.query,from:String(1e3*e.timeRange.from.unix()),until:String(1e3*e.timeRange.to.unix()),format:e.format});e.maxNodes&&t.set("max-nodes",String(e.maxNodes));const r=yield n.fetch(`/pyroscope/render?${t.toString()}`);switch(e.format){case"dot":return r.text();case"json":return r.json();default:throw new TypeError(`Unknown format "${e.format}"!`)}},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){ci(a,r,o,i,s,"next",e)}function s(e){ci(a,r,o,i,s,"throw",e)}i(void 0)}))})()}constructor(e){super(e)}}function di(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class pi extends s.Bs{validateFetchParams(e,t){let n,r=t;return e&&2!==t.length?(n=new Error(`Invalid number of fetch parameters for analyzing the diff flame graph (${t.length})!`),r=[]):e||1===t.length||(n=new Error(`Invalid number of fetch parameters for analyzing the flame graph (${t.length})!`),r=[]),{params:r,error:n}}constructor(){super({key:"ai-panel"}),di(this,"useSceneAiPanel",((e,t)=>{const n=s.jh.findByKeyAndType(this,"dataSource",Ht).useState().value,{params:r,error:a}=this.validateFetchParams(e,t),{error:i,isFetching:l,profiles:c}=function(e,t){const n=Fo.build(e,ui),{isFetching:r,error:o,data:a}=(0,Ja.I)({queryKey:["dot-profiles",e,...t.flatMap((({query:e,timeRange:t})=>[e,t.from.unix(),t.to.unix()])),100],queryFn:()=>Promise.all(t.map((({query:e,timeRange:t})=>n.get({query:e,timeRange:t,format:"dot",maxNodes:100}).then((e=>e.replace(/fontsize=\d+ /g,"").replace(/id="node\d+" /g,"").replace(/labeltooltip=".*\)" /g,"").replace(/tooltip=".*\)" /g,"").replace(/(N\d+ -> N\d+).*/g,"$1").replace(/N\d+ \[label="other.*\n/,"").replace(/shape=box /g,"").replace(/fillcolor="#\w{6}"/g,"").replace(/color="#\w{6}" /g,""))))))});return{isFetching:r,error:o,profiles:a||[]}}(n,r),u=jt(an(this,"profileMetricId")).type,{reply:d,error:p,retry:m}=function(e,t){const[n,r]=(0,o.useState)(""),[a,i]=(0,o.useState)(!1),[s,l]=(0,o.useState)(!1),[c,u]=(0,o.useState)([]),[d,p]=(0,o.useState)(null),[m,f]=(0,o.useState)(),h=(0,o.useCallback)((e=>{u(e),p(null),r(""),i(!0),l(!1);const t=Wa.qH({model:"gpt-4-1106-preview",messages:e}).pipe(Wa.qA()).subscribe({next:r,error(e){p(e),i(!1),l(!0),f(void 0)},complete(){i(!1),l(!0),f(void 0)}});f(t)}),[]),g=(0,o.useCallback)((e=>{const t=[{role:"assistant",content:n},{role:"user",content:e}];try{h([...c,...t])}catch(e){p(e)}}),[c,n,h]);return(0,o.useEffect)((()=>{if(!t.length||c.length>0)return;const n=li({system:"empty",user:2===t.length?"diff":"single",profileType:e,profiles:t});try{h([{role:"system",content:n.system},{role:"system",content:n.user}])}catch(e){p(e)}}),[c.length,e,t,t.length,h]),(0,o.useEffect)((()=>()=>{m&&(m.unsubscribe(),f(void 0))}),[m]),{reply:{text:n,hasStarted:a,hasFinished:s,messages:c,askFollowupQuestion:g},retry(){if(c.length>0)try{h(c)}catch(e){p(e)}},error:d}}(u,c);return{data:{validationError:a,isLoading:l||!l&&!i&&!p&&!d.text.trim(),fetchError:i,llmError:p,reply:d,shouldDisplayReply:Boolean((null==d?void 0:d.hasStarted)||(null==d?void 0:d.hasFinished)),shouldDisplayFollowUpForm:!i&&!p&&Boolean(null==d?void 0:d.hasFinished)},actions:{retry:m,submitFollowupQuestion(e){d.askFollowupQuestion(e)}}}}))}}di(pi,"Component",(({model:e,isDiff:t,fetchParams:n,onClose:r})=>{const o=(0,l.useStyles2)(mi),{data:i,actions:s}=e.useSceneAiPanel(t,n);return a().createElement(Ya,{className:o.sidePanel,title:"Flame graph analysis",isLoading:i.isLoading,headerActions:a().createElement(l.IconButton,{title:"Close panel",name:"times-circle",variant:"secondary","aria-label":"close",onClick:r}),dataTestId:"ai-panel"},a().createElement("div",{className:o.content},i.validationError&&a().createElement(Ta._,{severity:"error",title:"Validation error!",error:i.validationError}),i.fetchError&&a().createElement(Ta._,{severity:"error",title:"Error while loading profile data!",message:"Sorry for any inconvenience, please try again later.",error:i.fetchError}),i.shouldDisplayReply&&a().createElement(ri,{reply:i.reply}),i.isLoading&&a().createElement(a().Fragment,null,a().createElement(l.Spinner,{inline:!0})," Analyzing..."),i.llmError&&a().createElement(l.Alert,{title:"An error occured while generating content using OpenAI!",severity:"warning"},a().createElement("div",null,a().createElement("div",null,a().createElement("p",null,i.llmError.message),a().createElement("p",null,"Sorry for any inconvenience, please retry or if the problem persists, contact your organization admin."))),a().createElement(l.Button,{className:o.retryButton,variant:"secondary",fill:"outline",onClick:()=>s.retry()},"Retry")),i.shouldDisplayFollowUpForm&&a().createElement(ii,{onSubmit:s.submitFollowupQuestion})))}));const mi=e=>({sidePanel:i.css`
    flex: 1 0 50%;
    margin-left: 8px;
    max-width: calc(50% - 4px);
  `,title:i.css`
    margin: -4px 0 4px 0;
  `,content:i.css`
    padding: ${e.spacing(1)};
  `,retryButton:i.css`
    float: right;
  `});class fi extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(fi,"type","diff-auto-select");class hi extends h.BusEventWithPayload{}!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(hi,"type","diff-choose-preset");var gi=n(9993);function yi(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}class bi extends j{get(e){var t,n=this;return(t=function*(){const t=new URLSearchParams({leftQuery:e.leftQuery,leftFrom:String(1e3*e.leftTimeRange.from.unix()),leftUntil:String(1e3*e.leftTimeRange.to.unix()),rightQuery:e.rightQuery,rightFrom:String(1e3*e.rightTimeRange.from.unix()),rightUntil:String(1e3*e.rightTimeRange.to.unix())});e.maxNodes&&t.set("max-nodes",String(e.maxNodes));const r=yield n.fetch(`/pyroscope/render-diff?${t.toString()}`);return yield r.json()},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){yi(a,r,o,i,s,"next",e)}function s(e){yi(a,r,o,i,s,"throw",e)}i(void 0)}))})()}constructor(e){super(e)}}function vi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ei(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function Si({enabled:e,dataSourceUid:t,baselineTimeRange:n,baselineQuery:r,comparisonTimeRange:o,comparisonQuery:a}){const[i]=(0,gi.I)(),s=Fo.build(t,bi),{isFetching:l,error:c,data:u,refetch:d}=(0,Ja.I)({placeholderData:e=>e,enabled:Boolean(e&&i),queryKey:["diff-profile",t,r,n.from.unix(),n.to.unix(),a,o.from.unix(),o.to.unix(),i],queryFn:()=>{s.abort();const e={leftQuery:r,leftTimeRange:n,rightQuery:a,rightTimeRange:o,maxNodes:i};return s.get(e).then((e=>({profile:{version:e.version,flamebearer:e.flamebearer,metadata:e.metadata}})))}});return Ei(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){vi(e,t,n[t])}))}return e}({isFetching:l,error:s.isAbortError(c)?null:c},u),{refetch:d})}function wi({onClickAutoSelect:e,onClickChoosePreset:t,onOpenLearnHow:n}){const r=(0,l.useStyles2)(Oi),[i,s]=(0,o.useState)(!1);return a().createElement(Ta._,{severity:"info",title:"Select both the baseline and the comparison flame graph ranges to view the diff flame graph",message:a().createElement("div",{className:r.infoMsg},a().createElement("p",null,"How?"),a().createElement("p",null,a().createElement(l.Button,{variant:"primary",onClick:e},"Auto-select")," ","or"," ",a().createElement(l.Button,{variant:"primary",fill:"text",className:r.textButton,onClick:t},"choose a preset")),a().createElement("p",null,"Alternatively:"),a().createElement(l.Collapse,{label:"Click here to learn how to select the flame graph ranges with the mouse",collapsible:!0,className:r.collapse,isOpen:i,onToggle:()=>{i||n(),s(!i)}},a().createElement("div",{className:r.collapseContent},a().createElement("ol",null,a().createElement("li",null,"Ensure that the “Flame graph” range selection mode is selected"),a().createElement("li",null,"Use your mouse to select the desired time ranges on both the baseline and the comparison time series")),a().createElement("img",{src:"public/plugins/grafana-pyroscope-app/img/8cdf4d2e2df8326311ab.gif",alt:"How to view the diff flame graph"}))))})}const Oi=e=>({infoMsg:i.css`
    padding: ${e.spacing(2)} 0 0 0;
  `,textButton:i.css`
    padding: 0;
  `,collapse:i.css`
    background: transparent;
    border: 0;
  `,collapseContent:i.css`
    padding: 0 ${e.spacing(5)};

    & img {
      max-width: 100%;
      width: auto;
      margin-top: ${e.spacing(2)};
    }
  `});function xi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Ti extends s.Bs{buildTitle(){const e=an(this,"serviceName"),t=jt(an(this,"profileMetricId")).type;return a().createElement(a().Fragment,null,a().createElement(Qa.S,{size:"small"}),"Diff flame graph for ",e," (",t,")")}constructor(){super({key:"diff-flame-graph",aiPanel:new pi}),xi(this,"useSceneDiffFlameGraph",(()=>{const{aiPanel:e}=this.useState(),{baselineTimeRange:t,comparisonTimeRange:n}=this.parent.useDiffTimeRanges(),r=Kt(this,"filtersBaseline"),o=Kt(this,"filtersComparison"),{settings:a,error:i}=(0,xa._)(),l=s.jh.findByKeyAndType(this,"dataSource",Ht).useState().value,c=Boolean(r&&o&&t.from.unix()&&t.to.unix()&&n.from.unix()&&n.to.unix()),{isFetching:u,error:d,profile:p}=Si({enabled:c,dataSourceUid:l,baselineTimeRange:t,baselineQuery:r,comparisonTimeRange:n,comparisonQuery:o}),m=c&&!u&&!d&&0===(null==p?void 0:p.flamebearer.numTicks),f=Boolean(c&&!d&&!m&&p),h=!c;return{data:{title:this.buildTitle(),isLoading:u,fetchProfileError:d,noProfileDataAvailable:m,shouldDisplayFlamegraph:f,hasMissingSelections:h,profile:p,settings:a,fetchSettingsError:i,ai:{panel:e,fetchParams:[{query:r,timeRange:t},{query:o,timeRange:n}]}},actions:{}}})),xi(this,"onClickAutoSelect",(()=>{(0,f.r)("g_pyroscope_app_diff_auto_select_clicked"),this.publishEvent(new fi({wholeRange:!1}),!0)})),xi(this,"onClickChoosePreset",(()=>{(0,f.r)("g_pyroscope_app_diff_choose_preset_clicked"),this.publishEvent(new hi({}),!0)})),xi(this,"onOpenLearnHow",(()=>{(0,f.r)("g_pyroscope_app_diff_learn_how_clicked")}))}}xi(Ti,"Component",(({model:e})=>{var t,n;const r=(0,l.useStyles2)(Pi),{data:i}=e.useSceneDiffFlameGraph(),s=Oa(),u=i.isLoading||i.hasMissingSelections||i.noProfileDataAvailable;(0,o.useEffect)((()=>{u&&s.close()}),[u,s]),i.fetchSettingsError&&(0,c.HA)(["Error while retrieving the plugin settings!","Some features might not work as expected (e.g. flamegraph export options). Please try to reload the page, sorry for the inconvenience."]);const d=(0,o.useMemo)((()=>a().createElement(a().Fragment,null,i.title,i.isLoading&&a().createElement(l.Spinner,{inline:!0,className:r.spinner}))),[i.isLoading,i.title,r.spinner]);return a().createElement("div",{className:r.flex},a().createElement(Ya,{dataTestId:"diff-flame-graph-panel",className:r.flamegraphPanel,title:d,isLoading:i.isLoading,headerActions:a().createElement(Xa,{disabled:u||s.isOpen("ai"),onClick:()=>s.open("ai"),interactionName:"g_pyroscope_app_explain_flamegraph_clicked"},"Explain Flame Graph")},i.hasMissingSelections&&a().createElement(wi,{onClickAutoSelect:e.onClickAutoSelect,onClickChoosePreset:e.onClickChoosePreset,onOpenLearnHow:e.onOpenLearnHow}),i.fetchProfileError&&a().createElement(Ta._,{severity:"error",title:"Error while loading profile data!",error:i.fetchProfileError}),i.noProfileDataAvailable&&a().createElement(Ta._,{severity:"warning",title:"No profile data available",message:"Please verify that you've selected adequate filters and time ranges."}),i.shouldDisplayFlamegraph&&a().createElement(wa.C,{diff:!0,profile:i.profile,enableFlameGraphDotComExport:null===(t=i.settings)||void 0===t?void 0:t.enableFlameGraphDotComExport,collapsedFlamegraphs:null===(n=i.settings)||void 0===n?void 0:n.collapsedFlamegraphs})),s.isOpen("ai")&&a().createElement(i.ai.panel.Component,{model:i.ai.panel,isDiff:!0,fetchParams:i.ai.fetchParams,onClose:s.close}))}));const Pi=e=>({flex:i.css`
    display: flex;
  `,flamegraphPanel:i.css`
    min-width: 0;
    flex-grow: 1;
  `,sidePanel:i.css`
    flex: 1 0 50%;
    margin-left: 8px;
    max-width: calc(50% - 4px);
  `,spinner:i.css`
    margin-left: ${e.spacing(1)};
  `,aiButton:i.css`
    margin-top: ${e.spacing(1)};
  `}),Ci="https://grafana.qualtrics.com/jfe/form/SV_6Gav4IUU6jcYfd4",ki=()=>{const e=(0,l.useStyles2)(Ai);return a().createElement("div",{className:e.wrapper},a().createElement("a",{href:Ci,className:e.feedback,title:"Share your thoughts about Profiles in Grafana.",target:"_blank",rel:"noreferrer noopener"},a().createElement(l.Icon,{name:"comment-alt-message"})," Give feedback"),a().createElement("a",{href:Ci,className:e.feedback,title:"Share your thoughts about Profiles in Grafana.",target:"_blank",rel:"noreferrer noopener"},a().createElement(l.Badge,{text:"Preview",color:"blue",icon:"rocket"})))},Ai=e=>({wrapper:(0,i.css)({display:"flex",gap:e.spacing(1),justifyContent:"flex-end",paddingTop:"4px"}),feedback:(0,i.css)({alignSelf:"center",color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,"&:hover":{color:e.colors.text.link}})});function ji(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Ni extends s.Bs{onActivate(){[Zr.N.BASELINE,Zr.N.COMPARISON].forEach((e=>{this._subs.add(s.jh.findByKeyAndType(this,`${e}-panel`,Ea).state.$timeRange.subscribeToState(((e,t)=>{e.from===t.from&&e.to===t.to||this.setState({value:null})})))}))}openSelect(){this.setState({isSelectOpen:!0})}closeSelect(){this.setState({isSelectOpen:!1})}reset(){this.setState({value:null,isSelectOpen:!1,isModalOpen:!1})}static Component({model:e}){const t=(0,l.useStyles2)(_i),{value:n,isSelectOpen:r,isModalOpen:o}=e.useState();return a().createElement(a().Fragment,null,a().createElement("div",{className:t.presetsContainer},a().createElement(l.Select,{className:t.select,placeholder:"Choose a preset",value:n,options:Ni.PRESETS,onChange:e.onChangePreset,isOpen:r,onOpenMenu:e.onOpenSelect,onCloseMenu:e.onCloseSelect}),a().createElement(l.Button,{icon:"save",variant:"secondary",tooltip:"Save the current time ranges and filters as a custom preset",onClick:e.onClickSave})),a().createElement(l.Modal,{title:"Custom user presets",isOpen:o,closeOnEscape:!0,closeOnBackdropClick:!0,onDismiss:e.closeModal},a().createElement("p",null,"This feature, which would allow you to save the current time ranges and filters, is currently not implemented."),a().createElement("p",null,"Please let us know if you would be interested to use it by"," ",a().createElement("a",{href:Ci,target:"_blank",rel:"noreferrer noopener",className:t.link},"leaving us your feedback.")),a().createElement("p",null,"Thank you!"),a().createElement(l.Modal.ButtonRow,null,a().createElement(l.Button,{variant:"secondary",fill:"outline",onClick:e.closeModal},"Cancel"),a().createElement(l.Button,{onClick:e.closeModal,disabled:!0},"Save"))))}constructor(){super({name:"compare-presets",label:"Comparison presets",value:null,isModalOpen:!1,isSelectOpen:!1}),ji(this,"_variableDependency",new s.Sh(this,{variableNames:["dataSource","serviceName"],onReferencedVariableValueChanged:()=>{this.reset()}})),ji(this,"onChangePreset",(e=>{var t;if((0,f.r)("g_pyroscope_app_diff_preset_selected",{value:e.value}),this.closeSelect(),"dummy"!==e.value){if(null===(t=e.value)||void 0===t?void 0:t.startsWith("auto-select-"))return this.setState({value:null}),void this.publishEvent(new fi({wholeRange:"auto-select-whole"===e.value}),!0);[Zr.N.BASELINE,Zr.N.COMPARISON].forEach((t=>{const n=s.jh.findByKeyAndType(this,`${t}-panel`,Ea);n.toggleTimeRangeSync(!1),n.applyPreset(e[t])})),this.setState({value:e.value})}else this.setState({value:null,isModalOpen:!0})})),ji(this,"onClickSave",(()=>{(0,f.r)("g_pyroscope_app_diff_preset_save_clicked"),this.setState({isModalOpen:!0})})),ji(this,"closeModal",(()=>{this.setState({isModalOpen:!1})})),ji(this,"onOpenSelect",(()=>{setTimeout((()=>this.openSelect()),0)})),ji(this,"onCloseSelect",(()=>{this.closeSelect()})),this.addActivationHandler(this.onActivate.bind(this))}}ji(Ni,"PRESETS",[{label:"Built-in presets",value:"built-in",options:[{value:"last hour (30m-window)",label:"Last hour (30m-window)",baseline:{from:"now-1h",to:"now",diffFrom:"now-1h",diffTo:"now-30m",label:"last hour"},comparison:{from:"now-1h",to:"now",diffFrom:"now-30m",diffTo:"now",label:"last hour"}},{value:"last hour (1h-window)",label:"Last hour (1h-window)",baseline:{from:"now-1h",to:"now",diffFrom:"now-1h",diffTo:"now",label:"last hour"},comparison:{from:"now-1h",to:"now",diffFrom:"now-1h",diffTo:"now",label:"last hour"}},{value:"6h ago vs now",label:"6h ago vs now (30m-window)",baseline:{from:"now-375m",to:"now-315m",diffFrom:"now-375m",diffTo:"now-345m",label:"6h ago"},comparison:{from:"now-1h",to:"now",diffFrom:"now-30m",diffTo:"now",label:"last hour"}},{value:"24h ago vs now",label:"24h ago vs now (30m-window)",baseline:{from:"now-1455m",to:"now-1395m",diffFrom:"now-1455m",diffTo:"now-1425m",label:"24h ago"},comparison:{from:"now-1h",to:"now",diffFrom:"now-30m",diffTo:"now",label:"last hour"}},{value:"auto-select-25",label:"Auto-select (25% range)"},{value:"auto-select-whole",label:"Auto-select (whole range)"}]},{label:"My presets",value:"custom",options:[{label:"Dummy preset saved earlier",value:"dummy"}]}]);const _i=e=>({presetsContainer:i.css`
    display: flex;
  `,select:i.css`
    min-width: ${e.spacing(24)};
    text-align: left;
  `,link:i.css`
    color: ${e.colors.text.link};
  `});function Ii(){return e=>{const t=new Map,n=e.subscribeToEvent(v,(n=>{var r;const o=null===(r=n.payload.series)||void 0===r?void 0:r[0];(null==o?void 0:o.refId)?(t.set(o.refId,Math.max(...o.fields[1].values)),function(e,t){const n=s.jh.findAllObjects(e,(e=>e instanceof s.Eb&&"timeseries"===e.state.pluginId));for(const e of n)e.clearFieldConfigCache(),e.setState({fieldConfig:(0,b.merge)((0,b.cloneDeep)(e.state.fieldConfig),{defaults:{max:t}})})}(e,Math.max(...t.values()))):y.v.warn("Missing refId! Cannot sync y-axis on the timeseries.",n.payload.series)}));return()=>{n.unsubscribe()}}}class Ri extends s.Bs{onActivate(){k.locationService.partial({},!0);const e=s.jh.findByKeyAndType(this,"profileMetricId",$t);return e.setState({query:$t.QUERY_SERVICE_NAME_DEPENDENT}),e.update(!0),this.subscribeToEvents(),()=>{e.setState({query:$t.QUERY_DEFAULT}),e.update(!0)}}subscribeToEvents(){this._subs.add(this.subscribeToEvent(fi,(e=>{const t=e.payload.wholeRange,{baselinePanel:n,comparisonPanel:r}=this.state;n.toggleTimeRangeSync(!1),r.toggleTimeRangeSync(!1),n.autoSelectDiffRange(t),r.autoSelectDiffRange(t)}))),this._subs.add(this.subscribeToEvent(hi,(()=>{this.state.presetsPicker.openSelect()}))),this._subs.add(this.subscribeToEvent(zo,(e=>{const{source:t,enable:n,timeRange:r,annotationTimeRange:o}=e.payload,{baselinePanel:a,comparisonPanel:i}=this.state,s=t===Zr.N.BASELINE?i:a;n&&this.syncTimeRanges(s,r,o),i.toggleTimeRangeSync(n),a.toggleTimeRangeSync(n)}))),this._subs.add(this.subscribeToEvent(Qo,(e=>{const{source:t,timeRange:n,annotationTimeRange:r}=e.payload,{baselinePanel:o,comparisonPanel:a}=this.state,i=t===Zr.N.BASELINE?a:o;this.syncTimeRanges(i,n,r)}))),this._subs.add(this.subscribeToEvent(Yo,(e=>{const{source:t}=e.payload,{baselinePanel:n,comparisonPanel:r}=this.state;(t===Zr.N.BASELINE?r:n).refreshTimeseries()})))}syncTimeRanges(e,t,n){t&&e.setTimeRange(t),n&&e.setDiffRange({from:n.from.toISOString(),to:n.to.toISOString()})}getVariablesAndGridControls(){return{variables:[s.jh.findByKeyAndType(this,"serviceName",qt),s.jh.findByKeyAndType(this,"profileMetricId",$t),this.state.presetsPicker],gridControls:[]}}static Component({model:e}){const t=(0,l.useStyles2)(Li),{baselinePanel:n,comparisonPanel:r,body:o}=e.useState();return a().createElement("div",{className:t.container},a().createElement("div",{className:t.columns},a().createElement(n.Component,{model:n}),a().createElement(r.Component,{model:r})),a().createElement(o.Component,{model:o}))}constructor({useAncestorTimeRange:e,clearDiffRange:t,baselineFilters:n,comparisonFilters:r}){super({key:"explore-diff-flame-graph",baselinePanel:new Ea({target:Zr.N.BASELINE,useAncestorTimeRange:Boolean(e),clearDiffRange:Boolean(t),filters:n||[]}),comparisonPanel:new Ea({target:Zr.N.COMPARISON,useAncestorTimeRange:Boolean(e),clearDiffRange:Boolean(t),filters:r||[]}),$behaviors:[new s.Gg.K2({key:"metricCrosshairSync",sync:h.DashboardCursorSync.Crosshair}),Ii()],body:new Ti,presetsPicker:new Ni}),function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(this,"useDiffTimeRanges",(()=>{const{baselinePanel:e,comparisonPanel:t}=this.state,{annotationTimeRange:n}=e.useDiffTimeRange(),{annotationTimeRange:r}=t.useDiffTimeRange();return{baselineTimeRange:n,comparisonTimeRange:r}})),this.addActivationHandler(this.onActivate.bind(this))}}const Li=e=>({container:i.css`
    width: 100%;
    display: flex;
    flex-direction: column;
  `,columns:i.css`
    display: flex;
    flex-direction: row;
    gap: ${e.spacing(1)};
    margin-bottom: ${e.spacing(1)};

    & > div {
      flex: 1 1 0;
    }
  `});function Di(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Fi(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Di(a,r,o,i,s,"next",e)}function s(e){Di(a,r,o,i,s,"throw",e)}i(void 0)}))}}class $i extends j{githubLogin(e){var t=this;return Fi((function*(){const n=yield t.fetch("/vcs.v1.VCSService/GithubLogin",{method:"POST",body:JSON.stringify({authorizationCode:e})});return yield n.json()}))()}githubApp(){var e=this;return Fi((function*(){const t=yield e.fetch("/vcs.v1.VCSService/GithubApp",{method:"POST",body:JSON.stringify({})});return(yield t.json()).clientID}))()}}function Bi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Mi{isUserTokenExpired(e=0){return Date.now()>=this.expiry.getTime()-e}static decode(e){if(void 0===e||""===e)return;let t;try{t=atob(e)}catch(e){return void y.v.error(e,{info:"Failed to base64 decode GitSession value"})}const{payload:n,isLegacy:r}=Mi.tryDecode(t);return r?new Mi(e,864e13):new Mi(n.metadata,Number(n.expiry))}static tryDecode(e){try{return{payload:JSON.parse(e),isLegacy:!1}}catch(e){return{payload:void 0,isLegacy:!0}}}constructor(e,t){Bi(this,"oauthTokenMetadata",void 0),Bi(this,"expiry",void 0),this.oauthTokenMetadata=e,this.expiry=new Date(t)}}function Ui(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Vi="pyroscope_git_session";class qi{getCookie(){return this.syncCookieWithBrowser(),this.sessionCookie}setCookie(e){e.startsWith(`${Vi}=`)||(e=`${Vi}=${e}`);const t=qi.getCookieFromJar(e,Vi);void 0!==t&&(this.deleteLegacyCookie(),this.rawCookie=t,this.sessionCookie=Mi.decode(t.value),document.cookie=`${e}; path=/`)}deleteCookie(){document.cookie=`${Vi}=; Path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;`,this.deleteLegacyCookie(),this.rawCookie=void 0,this.sessionCookie=void 0}deleteLegacyCookie(){document.cookie="GitSession=; Path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;"}syncCookieWithBrowser(){var e,t;const n=qi.getCookieFromJar(document.cookie,Vi);(null==n?void 0:n.key)===(null===(e=this.rawCookie)||void 0===e?void 0:e.key)&&(null==n?void 0:n.value)===(null===(t=this.rawCookie)||void 0===t?void 0:t.value)||(void 0!==n?this.setCookie(`${n.key}=${n.value}`):this.deleteCookie())}static getCookieFromJar(e,t){return e.split(";").map((e=>{const[t,...n]=e.trim().split("="),r=n.join("=");return{key:t.trim(),value:null==r?void 0:r.trim()}})).find((({key:e})=>e===t))}constructor(){Ui(this,"rawCookie",void 0),Ui(this,"sessionCookie",void 0)}}const Gi=new qi;const Ki=800,Hi=950;function zi(e,t){const n=function(e,t){const n=new URL("/login/oauth/authorize","https://github.com");return n.searchParams.set("client_id",e),n.searchParams.set("scope","repo"),n.searchParams.set("state",btoa(JSON.stringify({redirect_uri:window.location.origin,nonce:t}))),n.toString()}(e,t),{top:r}=window;var o,a;const i=(null!==(o=null==r?void 0:r.outerWidth)&&void 0!==o?o:0)/2+(null!==(a=null==r?void 0:r.screenX)&&void 0!==a?a:0)-Ki/2;var s,l;const c=(null!==(s=null==r?void 0:r.outerHeight)&&void 0!==s?s:0)/2+(null!==(l=null==r?void 0:r.screenY)&&void 0!==l?l:0)-Hi/2;return window.open(n,"GitHub Login",`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=${Ki}, height=${Hi}, top=${c}, left=${i}`)}function Yi(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Qi(){var e;return e=function*(e,t,n,r,o){if(r&&r.close(),null==n?void 0:n.isUserTokenExpired())try{return void(yield t.refresh())}catch(e){y.v.error(e,{info:"Failed to refresh GitHub user token"}),Gi.deleteCookie()}try{o(zi(yield e.githubApp(),ds))}catch(e){(0,c.jx)(e,["Failed to start login flow.",e.message])}},Qi=function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Yi(a,r,o,i,s,"next",e)}function s(e){Yi(a,r,o,i,s,"throw",e)}i(void 0)}))},Qi.apply(this,arguments)}function Wi(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Ji(){var e;return e=function*(e,t,n){const r=t.get("code");if(!r)return"";const o=t.get("state");if(!o)throw new Error("Invalid state parameter!");let a;try{a=JSON.parse(atob(o))}catch(e){throw new Error("Invalid state parameter!")}if(a.nonce!==n)throw new Error("Invalid nonce parameter!");return(yield e.githubLogin(r)).cookie},Ji=function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Wi(a,r,o,i,s,"next",e)}function s(e){Wi(a,r,o,i,s,"throw",e)}i(void 0)}))},Ji.apply(this,arguments)}function Xi(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Zi({vcsClient:e,externalWindow:t,setExternalWindow:n,setSessionCookie:r,nonce:a}){(0,o.useEffect)((()=>{const o=function(){var i,s=(i=function*(){if(t&&!t.closed){try{const o=function(e){try{return new URL(e.location.href).searchParams}catch(e){return null}}(t);if(null!==o){const i=yield function(e,t,n){return Ji.apply(this,arguments)}(e,o,a);if(i)return r(i),t.close(),void n(null)}}catch(e){return(0,c.jx)(e,["Error while login in with GitHub!",e.message]),t.close(),void n(null)}window.setTimeout(o,700)}else n(null)},function(){var e=this,t=arguments;return new Promise((function(n,r){var o=i.apply(e,t);function a(e){Xi(o,n,r,a,s,"next",e)}function s(e){Xi(o,n,r,a,s,"throw",e)}a(void 0)}))});return function(){return s.apply(this,arguments)}}();return t&&o(),()=>{t&&(t.close(),n(null))}}),[t,n,r,a,e])}function es(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function ts(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){es(a,r,o,i,s,"next",e)}function s(e){es(a,r,o,i,s,"throw",e)}i(void 0)}))}}const ns={isLoginInProgress:!1,isLoggedIn:!1,isSessionExpired:!1,login:ts((function*(){}))},rs=(0,o.createContext)(ns);function os(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function as(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){os(a,r,o,i,s,"next",e)}function s(e){os(a,r,o,i,s,"throw",e)}i(void 0)}))}}function is(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const ss=Object.freeze({sha:"<unknown>",date:void 0,author:{login:"unknown author",avatarURL:""},message:"",URL:""});class ls extends j{getFile(e,t,n,r){var o=this;return as((function*(){return(yield o.postWithRefresh("/vcs.v1.VCSService/GetFile",JSON.stringify({repositoryURL:e,ref:t,localPath:n,rootPath:r}))).json()}))()}getCommits(e){var t=this;return as((function*(){return yield Promise.all(e.map((({repositoryUrl:e,gitRef:n})=>e&&n?t.getCommit(e,n).catch((t=>(y.v.error(t,{info:`Error while fetching commit from repo "${e}" (${n})!'`}),ss))):ss)))}))()}refresh(){var e=this;return as((function*(){return e.refreshSession()}))()}getCommit(e,t){var n=this;return as((function*(){var r;const o=yield n.postWithRefresh("/vcs.v1.VCSService/GetCommit",JSON.stringify({repositoryURL:e,ref:t})),a=yield o.json();return(r=a).date&&(r.date=new Date(a.date)),a}))()}postWithRefresh(e,t){var n=this;return as((function*(){var r;if(n.isRefreshing)return n.queueRequest(e,t);if(null===(r=n.sessionManager.getCookie())||void 0===r?void 0:r.isUserTokenExpired(ls.BIAS_MS)){n.isRefreshing=!0;try{yield n.refreshSession()}catch(e){n.sessionManager.deleteCookie(),n.flushQueue(e)}n.flushQueue(),n.isRefreshing=!1}return n.post(e,t)}))()}post(e,t){var n=this;return as((function*(){return n.fetch(e,{method:"POST",body:t})}))()}refreshSession(){var e=this;return as((function*(){const t=yield e.fetch("/vcs.v1.VCSService/GithubRefresh",{method:"POST",body:JSON.stringify({})}),n=yield t.json();e.sessionManager.setCookie(n.cookie)}))()}queueRequest(e,t){var n=this;return as((function*(){return new Promise(((r,o)=>{n.pendingQueue.push((a=>{a?o(a):r(n.post(e,t))}))}))}))()}flushQueue(e=void 0){this.pendingQueue.forEach((t=>t(e))),this.pendingQueue=[]}constructor(e){super(e),is(this,"sessionManager",void 0),is(this,"pendingQueue",void 0),is(this,"isRefreshing",void 0),this.sessionManager=Gi,this.isRefreshing=!1,this.pendingQueue=[]}}function cs(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function us(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){cs(a,r,o,i,s,"next",e)}function s(e){cs(a,r,o,i,s,"throw",e)}i(void 0)}))}}is(ls,"BIAS_MS",3e5);const ds=btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(32))));function ps({dataSourceUid:e,children:t}){const n=Fo.build(e,$i),r=Fo.build(e,ls),[i,s]=(0,o.useState)(ns.isLoginInProgress),[l,u]=function(){const[e,t]=(0,o.useState)(Gi.getCookie());return[e,e=>{e?(Gi.setCookie(e),t(Gi.getCookie())):(Gi.deleteCookie(),t(void 0))}]}(),[d,p]=(0,o.useState)();(0,o.useEffect)((()=>{u("")}),[e]),Zi({vcsClient:n,externalWindow:d,setExternalWindow:p,setSessionCookie:u,nonce:ds});const m=!!d&&!d.closed;m!==i&&s(m);const f=(0,o.useCallback)(us((function*(){try{yield function(e,t,n,r,o){return Qi.apply(this,arguments)}(n,r,l,d,p)}catch(e){(0,c.jx)(e,["Failed to login to GitHub",e.message])}})),[n,r,l,d]);return a().createElement(rs.Provider,{value:{isLoginInProgress:i,isLoggedIn:Boolean(l&&!l.isUserTokenExpired()),isSessionExpired:Boolean(null==l?void 0:l.isUserTokenExpired()),login:f}},t)}var ms=n(3062);function fs({filters:e,maxNodes:t}){const n=e?[...e]:[];n.unshift({key:"service_name",operator:"=",value:"$serviceName"});const r=n.map((({key:e,operator:t,value:n})=>`${e}${t}"${n}"`)).join(",");return hn(new s.dt({datasource:_t,queries:[{refId:"profile",queryType:"profile",profileTypeId:"$profileMetricId",labelSelector:`{${r},$filters}`,maxNodes:t}]}))}var hs=n(9326),gs=(n(8727),n(2249)),ys=n.n(gs),bs=n(585);function vs(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Es(e,t,n,r){var o,a=arguments.length,i=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(i=(a<3?o(i):a>3?o(t,n,i):o(t,n))||i);return a>3&&i&&Object.defineProperty(t,n,i),i}class Ss extends bs.Message{constructor(e,t,n,r,o){super(),vs(this,"profile_typeID",void 0),vs(this,"label_selector",void 0),vs(this,"start",void 0),vs(this,"end",void 0),vs(this,"max_nodes",void 0),this.profile_typeID=e,this.label_selector=t,this.start=n,this.end=r,this.max_nodes=o}}function ws(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Os(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){ws(a,r,o,i,s,"next",e)}function s(e){ws(a,r,o,i,s,"throw",e)}i(void 0)}))}}Es([bs.Field.d(1,"string")],Ss.prototype,"profile_typeID",void 0),Es([bs.Field.d(2,"string")],Ss.prototype,"label_selector",void 0),Es([bs.Field.d(3,"int64")],Ss.prototype,"start",void 0),Es([bs.Field.d(4,"int64")],Ss.prototype,"end",void 0),Es([bs.Field.d(5,"int64")],Ss.prototype,"max_nodes",void 0);class xs extends j{static buildPprofRequest(e,t,n){const{profileMetricId:r,labelsSelector:o}=fn(e),a=1e3*t.from.unix(),i=1e3*t.to.unix(),s=new Ss(r,o,a,i,n);return Ss.encode(s).finish()}selectMergeProfile({query:e,timeRange:t,maxNodes:n}){var r=this;return Os((function*(){return(yield r.fetch("/querier.v1.QuerierService/SelectMergeProfile",{method:"POST",headers:{"content-type":"application/proto"},body:new Blob([xs.buildPprofRequest(e,t,n)])})).blob()}))()}selectMergeProfileJson({profileMetricId:e,labelsSelector:t,start:n,end:r,stackTrace:o,maxNodes:a}){var i=this;return Os((function*(){return(yield i.fetch("/querier.v1.QuerierService/SelectMergeProfile",{method:"POST",body:JSON.stringify({profile_typeID:e,label_selector:t,start:1e3*n,end:1e3*r,stackTraceSelector:{call_site:o.map((e=>({name:e})))},maxNodes:a})})).json()}))()}}function Ts(e,t){const{serviceId:n,profileMetricId:r}=fn(e),o=`${t.from.format("YYYY-MM-DD_HHmm")}-to-${t.to.format("YYYY-MM-DD_HHmm")}`;return`${n.replace(/\//g,"-")}_${r}_${o}`}function Ps(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}class Cs extends A.Q{upload(e,t){var n,r=this;return(n=function*(){const n=yield r.fetch("/upload/v1",{method:"POST",body:JSON.stringify({name:e,profile:btoa(JSON.stringify(t)),fileTypeData:{units:t.metadata.units,spyName:t.metadata.spyName},type:"json"})});return yield n.json()},function(){var e=this,t=arguments;return new Promise((function(r,o){var a=n.apply(e,t);function i(e){Ps(a,r,o,i,s,"next",e)}function s(e){Ps(a,r,o,i,s,"throw",e)}i(void 0)}))})()}constructor(){super("https://flamegraph.com/api",{"content-type":"application/json"})}}const ks=new Cs;function As(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function js(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){As(a,r,o,i,s,"next",e)}function s(e){As(a,r,o,i,s,"throw",e)}i(void 0)}))}}function Ns(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class _s extends s.Bs{fetchFlamebearerProfile({dataSourceUid:e,query:t,timeRange:n,maxNodes:r}){return js((function*(){const o=Fo.build(e,ui);let a;try{a=yield o.get({query:t,timeRange:n,format:"json",maxNodes:r||hs.a.maxNodes})}catch(e){return(0,c.jx)(e,["Error while loading flamebearer profile data!",e.message]),null}return a}))()}fetchPprofProfile({dataSourceUid:e,query:t,timeRange:n,maxNodes:r}){return js((function*(){const o=Fo.build(e,xs);let a;try{const e=yield o.selectMergeProfile({query:t,timeRange:n,maxNodes:r||hs.a.maxNodes});a=yield new Response(e.stream().pipeThrough(new CompressionStream("gzip"))).blob()}catch(e){return(0,c.jx)(e,["Failed to export to pprof!",e.message]),null}return a}))()}constructor(){super({key:"export-flame-graph-menu"}),Ns(this,"useSceneExportMenu",(({query:e,timeRange:t})=>{const n=s.jh.findByKeyAndType(this,"dataSource",Ht).useState().value,[r]=(0,gi.I)(),{settings:o}=(0,xa._)();var a=this;const i=function(){var o=js((function*(){(0,f.r)("g_pyroscope_app_export_profile",{format:"json"});const o=yield a.fetchFlamebearerProfile({dataSourceUid:n,query:e,timeRange:t,maxNodes:r});if(!o)return;const i=`${Ts(e,t)}.json`,s=`data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(o))}`;ys()(s,i)}));return function(){return o.apply(this,arguments)}}();var l=this;const u=function(){var o=js((function*(){(0,f.r)("g_pyroscope_app_export_profile",{format:"pprof"});const o=yield l.fetchPprofProfile({dataSourceUid:n,query:e,timeRange:t,maxNodes:r});if(!o)return;const a=`${Ts(e,t)}.pb.gz`;ys()(o,a)}));return function(){return o.apply(this,arguments)}}();var d=this;const p=function(){var o=js((function*(){(0,f.r)("g_pyroscope_app_export_profile",{format:"flamegraph.com"});const o=yield d.fetchFlamebearerProfile({dataSourceUid:n,query:e,timeRange:t,maxNodes:r});if(o)try{const n=yield ks.upload(Ts(e,t),o);if(!n.url)throw new Error("Empty URL received.");const r=document.createElement("a");r.target="_blank",r.href=n.url,document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(e){return void(0,c.jx)(e,["Failed to export to flamegraph.com!",e.message])}}));return function(){return o.apply(this,arguments)}}();return{data:{shouldDisplayFlamegraphDotCom:Boolean(null==o?void 0:o.enableFlameGraphDotComExport)},actions:{downloadPng:()=>{(0,f.r)("g_pyroscope_app_export_profile",{format:"png"});const n=`${Ts(e,t)}.png`;document.querySelector('canvas[data-testid="flameGraph"]').toBlob((e=>{if(e)ys()(e,n);else{const e=new Error("Error while creating the image, no blob.");(0,c.jx)(e,["Failed to export to png!",e.message])}}),"image/png")},downloadJson:i,downloadPprof:u,uploadToFlamegraphDotCom:p}}}))}}function Is(){return(0,o.useContext)(rs)}function Rs(e){const{login:t,isSessionExpired:n}=Is(),{settings:r}=(0,xa._)(),a=null==r?void 0:r.enableFunctionDetails,[i,s]=(0,o.useState)([]),l=(0,o.useCallback)((({item:r},o)=>a&&0!==r.level?[{label:"Function details",icon:"info-circle",onClick:()=>{(0,f.r)("g_pyroscope_app_function_details_clicked"),s(function(e,t){let n=[];const r=t.fields.find((({name:e})=>"label"===e));if(!r)return n;const o=(0,h.getDisplayProcessor)({field:r,theme:(0,h.createTheme)()});let a=e;for(;a&&a.level>0;){var i;for(const e of a.itemIndexes)n.unshift(o(r.values[e]).text);a=null===(i=a.parents)||void 0===i?void 0:i[0]}return n}(r,o)),e.open("function-details"),n&&t()}}]:[]),[a,n,t,e]);return{data:{stacktrace:i},actions:{getExtraFlameGraphMenuItems:l}}}Ns(_s,"Component",(({model:e,query:t,timeRange:n})=>{const{actions:r}=e.useSceneExportMenu({query:t,timeRange:n});return a().createElement(l.Dropdown,{overlay:a().createElement(l.Menu,null,a().createElement(l.Menu.Item,{label:"png",onClick:r.downloadPng}),a().createElement(l.Menu.Item,{label:"json",onClick:r.downloadJson}),a().createElement(l.Menu.Item,{label:"pprof",onClick:r.downloadPprof}))},a().createElement(l.Button,{icon:"download-alt",size:"sm",variant:"secondary",fill:"outline","aria-label":"Export profile data",tooltip:"Export profile data"}))}));const Ls="gpt-4-1106-preview",Ds=({functionDetails:e,lines:t})=>{const n=`\nYou are a code optimization expert. I will give you code, each line annotated with amount of time spent on a particular line (it's in the beginning of each line), and a function name.\n\nI want you to write back a new improved code for this function and explain why you made changes.\n\nMake sure to take annotations into strong consideration. If a suggested performance improvement isn't backed up by information from the annotations, do not include it.\n\nDo not mention the actual numbers from the annotations, users can already see how much time was spent on each line. Do not list various lines and their time spent. When you mention functions or lines, do not mention the time spent on them.\n\nIf you can't find any meaningful performance optimizations, say so. Ask for context if you think other context might help make decisions. If you think the problem is with user input and not the actual code itself, say so.\n\nWhen you output code in markdown, please don't specify language after 3 backticks (e.g instead of saying "\`\`\`go" say "\`\`\`"), and always add a new line after 3 backticks.\n\nFunction name is \`${e.name}\`. Do not mention the function name, users can already see it.\n\nWhen posting a response, follow the outline below:\n* give a brief explanation of things that could be improve\n* print new code if it's possible\n* explain each change in more details\n\n\nAnnotated code is below:\n\`\`\`\n${function(e,t){let n=t.map((t=>`(${t.cum} ${e.unit}) ${t.line}`)).join("\n");return n}(e,t)}\n\`\`\`\n`;return{system:"",user:n}};function Fs(e){const{reply:t,error:n}=function(e){const[t,n]=(0,o.useState)(""),[r,a]=(0,o.useState)(!1),[i,s]=(0,o.useState)(!1),[l,c]=(0,o.useState)([]),[u,d]=(0,o.useState)(null),p=(0,o.useCallback)((e=>{c(e),d(null),n(""),a(!0),s(!1),Wa.qH({model:Ls,messages:e}).pipe(Wa.qA()).subscribe({next:n,error(e){d(e),a(!1),s(!0)},complete(){a(!1),s(!0)}})}),[]),m=(0,o.useCallback)((e=>{const n=[{role:"assistant",content:t},{role:"user",content:e}];try{p([...l,...n])}catch(e){d(e)}}),[l,t,p]);return(0,o.useEffect)((()=>{if(l.length>0)return;const t=Ds(e);try{p([{role:"system",content:t.system},{role:"system",content:t.user}])}catch(e){d(e)}}),[l.length,e,p]),{reply:{text:t,hasStarted:r,hasFinished:i,messages:l,askFollowupQuestion:m},error:u}}(e);return{data:{isLoading:!n&&!t.text.trim(),llmError:n,reply:t,shouldDisplayReply:Boolean((null==t?void 0:t.hasStarted)||(null==t?void 0:t.hasFinished)),shouldDisplayFollowUpForm:!n&&Boolean(null==t?void 0:t.hasFinished)},actions:{submitFollowupQuestion(e){t.askFollowupQuestion(e)}}}}const $s=()=>({title:i.css`
    margin: -4px 0 4px 0;
  `,content:i.css``});function Bs({suggestionPromptInputs:e}){const t=(0,l.useStyles2)($s),{data:n,actions:r}=Fs(e);return a().createElement(a().Fragment,null,a().createElement("h6",{className:t.title},"Code Optimization Suggestions"),a().createElement("div",{className:t.content},n.isLoading&&a().createElement(a().Fragment,null,a().createElement(l.Spinner,{inline:!0})," Analyzing..."),n.fetchError&&a().createElement(Ta._,{severity:"error",title:"Error while fetching profiles!",message:"Sorry for any inconvenience, please try again later."}),n.llmError&&a().createElement(Ta._,{severity:"error",title:"Failed to generate content using OpenAI!",error:n.llmError,message:"Sorry for any inconvenience, please try again later or if the problem persists, contact your organization admin."}),n.shouldDisplayReply&&a().createElement(ri,{reply:n.reply}),n.shouldDisplayFollowUpForm&&a().createElement(ii,{onSubmit:r.submitFollowupQuestion})))}function Ms(e,t){let n=e;const r=e.match(/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/(.+)/);if(r){const[,e,t,o]=r;n=`https://github.com/${e}/${t}/blob/${o}`}return void 0===t||e.includes("#")||(n+=`#L${t}`),n}const Us=5;function Vs(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function qs(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function Gs(e,t){const{isLoggedIn:n}=Is(),{version:r}=t,[a,i]=(0,o.useState)(!1);var s,l,c;const{fileInfo:u,error:d,isFetching:p}=function({enabled:e,dataSourceUid:t,repository:n,gitRef:r,localPath:o,rootPath:a}){const i=Fo.build(t,ls),{isFetching:s,error:l,data:c}=(0,Ja.I)({enabled:Boolean(e&&o),queryKey:["vcs-file",n,r,o,a],queryFn:()=>i.getFile(n,r,o,a).then((e=>({content:e.content,URL:e.URL}))).then((e=>({URL:e.URL,content:atob(e.content)})))});return{isFetching:s,error:i.isAbortError(l)?null:l,fileInfo:c}}({enabled:n,dataSourceUid:e,localPath:t.fileName,repository:null!==(s=null==r?void 0:r.repository)&&void 0!==s?s:"",gitRef:null!==(l=null==r?void 0:r.git_ref)&&void 0!==l?l:"",rootPath:null!==(c=null==r?void 0:r.root_path)&&void 0!==c?c:""}),m=(0,o.useMemo)((()=>(null==u?void 0:u.content)?function(e,t){if(!t.size)return[];const n=Array.from(t.values()).sort(((e,t)=>e.line-t.line)),r=e.split("\n"),o=Math.max(0,n[0].line-Us-1),a=Math.min(r.length,n[n.length-1].line+Us);return r.slice(o,a).map(((e,n)=>{const r=n+o+1,a=t.get(r);var i,s;return{line:e,number:r,cum:null!==(i=null==a?void 0:a.cum)&&void 0!==i?i:0,flat:null!==(s=null==a?void 0:a.flat)&&void 0!==s?s:0}}))}(u.content,t.callSites):function(e){if(!e.size)return[];const t=Array.from(e.values()).sort(((e,t)=>e.line-t.line)),n=Math.max(0,t[0].line-Us-1),r=t[t.length-1].line+Us+1,o=[];for(let t=n+1;t<r;t++){const n=e.get(t);var a,i;o.push({line:void 0,number:t,cum:null!==(a=null==n?void 0:n.cum)&&void 0!==a?a:0,flat:null!==(i=null==n?void 0:n.flat)&&void 0!==i?i:0})}return o}(t.callSites)),[null==u?void 0:u.content,t.callSites]);return{data:{fetchError:d,openAiSuggestions:a,isLoadingCode:p,unit:t.unit,githubUrl:(null==u?void 0:u.URL)?Ms(u.URL,t.startLine):void 0,lines:m.map((e=>{var t;return qs(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){Vs(e,t,n[t])}))}return e}({},e),{line:null!==(t=e.line)&&void 0!==t?t:"???"})})),noCodeAvailable:Boolean(d)||!m.some((e=>e.line))},actions:{setOpenAiSuggestions:i}}}function Ks(e){switch(e){case"nanoseconds":return(0,h.getValueFormat)("ns");case"microseconds":return(0,h.getValueFormat)("µs");case"milliseconds":return(0,h.getValueFormat)("ms");case"seconds":return(0,h.getValueFormat)("s");case"count":return(0,h.getValueFormat)("short");default:return(0,h.getValueFormat)(e)}}const Hs=({lines:e,unit:t,githubUrl:n,isLoadingCode:r,noCodeAvailable:o,onOptimizeCodeClick:s})=>{const c=(0,l.useStyles2)(Js),u=Ks(t),d=e=>{if(e<=0)return".";const t=u(e);return t.suffix?t.text+t.suffix:t.text};Ys(e);const[p,m]=e.reduce((([e,t],{flat:n,cum:r})=>[e+n,t+r]),[0,0]);return a().createElement("div",{"data-testid":"function-details-code-container"},a().createElement("div",{className:c.container},a().createElement("div",{className:c.header},a().createElement("div",{className:c.breakdownLabel},a().createElement("h6",null,"Breakdown per line"),a().createElement("span",null,r&&a().createElement(l.Spinner,{inline:!0}),!r&&o&&"(file information unavailable)")),a().createElement("div",{className:c.buttons},a().createElement(l.LinkButton,{disabled:Boolean(r||!n),href:n,target:"_blank",icon:"github",fill:"text"},"View on GitHub"),a().createElement(Xa,{onClick:s,disabled:r||o,interactionName:"g_pyroscope_app_optimize_code_clicked"},"Optimize Code")))),a().createElement("pre",{className:c.codeBlock,"data-testid":"function-details-code"},a().createElement("div",{className:(0,i.cx)(c.highlighted,c.codeBlockHeader)},zs("Total:",d(p),d(m)," (self, total)")),e.map((({line:e,number:t,cum:n,flat:r})=>a().createElement("div",{key:e+t+n+r,className:r+n>0?c.highlighted:""},zs(`${t} `,d(r),d(n),e))))))},zs=(e,t,n,r)=>{const o=e.padStart(7," ")+t.padStart(12," ")+n.padStart(12," ");return r?`${o} ${r}`:o},Ys=e=>{if(0===e.length)return;let t=Qs(e[0].line);for(let n=1;n<e.length;n++){const{line:r}=e[n];if(""===r.trim())continue;const o=Qs(r);t=Ws(t,o)}if(t)for(let n=0;n<e.length;n++)e[n].line=e[n].line.substring(t.length)},Qs=e=>{const t=e.match(/^[ \t]*/);var n;return null!==(n=null==t?void 0:t[0])&&void 0!==n?n:""},Ws=(e,t)=>{let n=0;for(let r=0;r<Math.min(e.length,t.length)&&e[r]===t[r];r++)n++;return e.substring(0,n)},Js=e=>({container:i.css`
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    width: 100%;
  `,header:i.css`
    display: flex;
    justify-content: space-between;
    align-items: end;
    width: 100%;
  `,breakdownLabel:i.css`
    & > h6 {
      display: inline-block;
      margin-top: ${e.spacing(1)};
    }

    & > span {
      margin-left: ${e.spacing(1)};
      font-size: ${e.typography.bodySmall.fontSize};
    }

    & > svg {
      margin-left: ${e.spacing(1)};
    }
  `,buttons:i.css`
    display: flex;
    flex-wrap: no-wrap;
  `,codeBlock:i.css`
    position: relative;
    min-height: 240px;
    font-size: 12px;
    overflow-x: auto;
    white-space: pre;
    color: ${e.colors.text.secondary};
  `,highlighted:i.css`
    color: ${e.colors.text.maxContrast};
  `,codeBlockHeader:i.css`
    margin-bottom: 8px;
  `});function Xs({dataSourceUid:e,functionDetails:t}){var n,r;const{data:o,actions:i}=Gs(e,t);return o.fetchError&&404!==(null===(r=o.fetchError)||void 0===r||null===(n=r.response)||void 0===n?void 0:n.status)&&(0,c.jx)(o.fetchError,["Failed to fetch file information!",o.fetchError.message]),a().createElement(a().Fragment,null,a().createElement(Hs,{lines:o.lines,unit:o.unit,githubUrl:o.githubUrl,isLoadingCode:o.isLoadingCode,noCodeAvailable:o.noCodeAvailable,onOptimizeCodeClick:()=>{var e;i.setOpenAiSuggestions(!0),null===(e=document.getElementById("ai-suggestions-panel"))||void 0===e||e.scrollIntoView({behavior:"smooth"})}}),a().createElement("h6",{id:"ai-suggestions-panel",style:{height:0,marginBottom:0}}),o.openAiSuggestions?a().createElement(Bs,{suggestionPromptInputs:{functionDetails:t,lines:o.lines}}):null)}const Zs=e=>({ellipsis:i.css`
    color: ${e.colors.primary.text};
    text-overflow: ellipsis;
    overflow: hidden;
    direction: rtl;
    white-space: nowrap;
  `}),el=({enableIntegration:e,repository:t})=>{const n=(0,l.useStyles2)(Zs),{isLoginInProgress:r,isLoggedIn:o,login:i}=Is();return e?r?a().createElement(a().Fragment,null,a().createElement(l.Spinner,null),a().createElement("span",null,"Connecting to GitHub...")):o?a().createElement(a().Fragment,null,a().createElement(l.Icon,{name:"github",size:"lg"}),a().createElement("a",{className:n.ellipsis,href:t.commitUrl,target:"_blank",rel:"noreferrer",title:"View commit"},a().createElement(l.Icon,{name:"external-link-alt"})," ",t.commitName)):a().createElement(l.Button,{icon:"github",variant:"primary",onClick:i,tooltip:"Once connected, the GitHub code will be accessible only from this browser session.",tooltipPlacement:"top"},"Connect to ",t.name):a().createElement(a().Fragment,null,"-")};function tl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function nl(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function rl(e,t){const n=e.map((e=>{var n;return nl(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){tl(e,t,n[t])}))}return e}({},e.commit),{samples:{unit:null!==(n=e.unit)&&void 0!==n?n:"count",current:Array.from(e.callSites.values()).reduce(((e,{cum:t})=>e+t),0),total:t}})}));return n}const ol="https://github.com/";function al(e,t){if(!(null==t?void 0:t.repository))return null;const n=t.repository,r=n.replace(ol,""),o=t.git_ref;return{isGitHub:e,url:n,name:r,commitUrl:o?`${n}/commit/${o}`:n,commitName:o?`${r}@${o.substring(0,7)}`:r}}const il=(e,t,n)=>{let r;try{r=n?JSON.parse(e.stringTable[Number(n.buildId)]):void 0}catch(e){}return{name:e.stringTable[Number(t.name)],version:r,startLine:Number.isNaN(Number(t.startLine))?void 0:Number(t.startLine),fileName:e.stringTable[Number(t.filename)],callSites:new Map,unit:e.stringTable[Number(e.sampleType[0].unit)],commit:ss}};function sl(e,t,n,r,o,a,i){const s=new Set;a.locationId.forEach(((l,c)=>{const u=n.get(l);u&&u.line.forEach((n=>{const d=r.get(n.functionId);if(!d)return;if(t.stringTable[Number(d.name)]!==e)return;if(s.has(l))return;s.add(l);const p=i.get(u.mappingId)||il(t,d,o.get(u.mappingId));i.set(u.mappingId,function(e,t,n,r){const o=Number(t.line),a=e.callSites.get(o)||{line:Number(t.line),flat:0,cum:0},i=0===r?n:0,s=n;return a.flat+=i,a.cum+=s,e.callSites.set(o,a),e}(p,n,Number(a.value[0]),c))}))}))}function ll(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function cl(){var e;return e=function*(e,t){const n=Fo.build(e,ls),r=t.map((e=>{var t,n,r;return{repositoryUrl:(null==e||null===(t=e.version)||void 0===t?void 0:t.repository)||"",gitRef:(null==e||null===(n=e.version)||void 0===n?void 0:n.git_ref)||"HEAD",rootPath:(null==e||null===(r=e.version)||void 0===r?void 0:r.root_path)||""}}));return(yield n.getCommits(r)).forEach(((e,n)=>{t[n].commit=e})),t},cl=function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){ll(a,r,o,i,s,"next",e)}function s(e){ll(a,r,o,i,s,"throw",e)}i(void 0)}))},cl.apply(this,arguments)}const ul=e=>Array.from(e.callSites.values()).reduce(((e,{cum:t})=>e+t),0),dl=(e,t)=>ul(t)-ul(e);function pl(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function ml(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){pl(a,r,o,i,s,"next",e)}function s(e){pl(a,r,o,i,s,"throw",e)}i(void 0)}))}}function fl({dataSourceUid:e,query:t,timeRange:n,stackTrace:r}){const{profileMetricId:a,labelsSelector:i}=fn(t),[s,l]=[n.from.unix(),n.to.unix()],{isLoggedIn:c}=Is(),u=Fo.build(e,xs),{isFetching:d,error:p,data:m}=(0,Ja.I)({enabled:Boolean(a&&i&&r.length>0&&s>0&&l>0),queryKey:["function-details",a,i,s,l,r,c],queryFn:ml((function*(){const t=yield u.selectMergeProfileJson({profileMetricId:a,labelsSelector:i,start:s,end:l,stackTrace:r,maxNodes:500}),n=function(e,t){var n,r,o,a;const i=new Map,s=new Map(null===(n=t.location)||void 0===n?void 0:n.map((e=>[e.id,e]))),l=new Map(null===(r=t.function)||void 0===r?void 0:r.map((e=>[e.id,e]))),c=new Map(null===(o=t.mapping)||void 0===o?void 0:o.map((e=>[e.id,e])));return null===(a=t.sample)||void 0===a||a.filter((e=>void 0!==e.locationId)).forEach((n=>sl(e,t,s,l,c,n,i))),Array.from(i.values())}(r[r.length-1],t).sort(dl);return c?function(e,t){return cl.apply(this,arguments)}(e,n):n}))}),f=(0,o.useMemo)((()=>(null==m?void 0:m.length)?m:[{name:r.at(-1),startLine:void 0,fileName:"",callSites:new Map,unit:"",commit:ss}]),[m,r]);return{isFetching:d,error:u.isAbortError(p)?null:p,functionsDetails:f}}const hl=[60,3600,86400,604800,2592e3,31536e3,1/0],gl=["second","minute","hour","day","week","month","year"],yl=new Intl.RelativeTimeFormat("en-US",{numeric:"auto"});const bl=new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"2-digit"});function vl(e){return e?`${bl.format(e)} (${function(e){const t=e.getTime(),n=Math.round((t-Date.now())/1e3),r=hl.findIndex((e=>e>Math.abs(n))),o=r?hl[r-1]:1;return yl.format(Math.floor(n/o),gl[r])}(e)})`:"?"}const El=e=>({container:i.css`
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  `,firstLine:i.css`
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 1em;
  `,sha:i.css`
    font-family: monospace;
  `,sample:i.css`
    font-size: 12px;
  `,secondLine:i.css`
    display: flex;
    flex-direction: row;
    align-items: center;
    font-size: 12px;
    color: ${e.colors.text.secondary};
  `,avatar:i.css`
    display: inline-block;
    margin-right: 4px;
    border-radius: 50%;
    background: grey;
    width: 16px;
    height: 16px;
  `,message:i.css`
    font-size: 12px;
    color: ${e.colors.text.secondary};
  `});function Sl({commit:e}){const t=(0,l.useStyles2)(El),{author:n,samples:r}=e,o=n.login,i=n.avatarURL,s=Ks(r.unit)(r.current),c=Math.round(r.current/r.total*100);return a().createElement("div",{className:t.container},a().createElement("div",{className:t.firstLine},a().createElement("span",{className:t.sha},Pl(e.sha)),a().createElement("span",{className:t.sample},s.text,s.suffix," (",c,"%)")),a().createElement("div",{className:t.secondLine},i&&a().createElement("img",{className:t.avatar,src:i,alt:o}),a().createElement("span",null,o," on ",vl(e.date))),a().createElement("span",{className:t.message},Cl(e.message)))}const wl=e=>({container:i.css`
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: center;
    gap: 1em;
  `,sha:i.css`
    font-family: monospace;
  `,message:i.css`
    color: ${e.colors.text.secondary};
  `});function Ol({commit:e}){const t=(0,l.useStyles2)(wl);return a().createElement("div",{className:t.container},a().createElement("span",{className:t.sha},Pl(e.sha)),a().createElement("div",{className:t.message},a().createElement("span",null,Cl(e.message))))}function xl({commits:e,selectedCommit:t,onChange:n}){return a().createElement(l.Select,{options:e.map((e=>({label:e.sha,value:e}))),value:{label:t.sha,value:t},hideSelectedOptions:!0,isSearchable:!1,noOptionsMessage:"No commits found",formatOptionLabel:Tl,onChange:e=>{e.value&&n(e.value)}})}function Tl(e,t){var n;const{value:r}=e;if(!r)return null;return(null===(n=t.selectValue[0])||void 0===n?void 0:n.value)===r?a().createElement(Ol,{commit:r}):a().createElement(Sl,{commit:r})}const Pl=e=>e===ss.sha?e:e.substring(0,7),Cl=e=>e.split("\n")[0],kl=({onDismiss:e})=>a().createElement(l.Alert,{severity:"info",title:"Integrate with Github",buttonContent:"Dismiss",onRemove:e},a().createElement("p",null,"This language supports integration with ",a().createElement(l.Icon,{name:"github"})," GitHub."),a().createElement("p",null,"To activate this feature, you will need to add two new labels when sending profiles"," ",a().createElement("code",null,"service_repository")," and ",a().createElement("code",null,"service_ref"),"."," "),a().createElement("p",null,"They should respectively be set to the full repository GitHub URL and the current"," ",a().createElement(l.TextLink,{href:"https://docs.github.com/en/rest/git/refs?apiVersion=2022-11-28#about-git-references",external:!0},"git ref")," ","of the running service."),a().createElement(l.Icon,{name:"document-info"})," ",a().createElement(l.TextLink,{href:"https://grafana.com/docs/grafana-cloud/monitor-applications/profiles/pyroscope-github-integration/",external:!0},"Learn more"));function Al({isLoading:e,children:t}){return e?a().createElement(l.Spinner,{inline:!0}):a().createElement(a().Fragment,null,t)}const jl=(0,o.memo)(Al);function Nl(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function _l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Il extends s.Bs{constructor(){super({key:"function-details-panel"}),_l(this,"useSceneFunctionDetailsPanel",((e,t)=>{var n,r;const a=s.jh.findByKeyAndType(this,"dataSource",Ht).useState().value,i=Kt(this,"filters"),{functionsDetails:l,error:u,isFetching:d}=fl({dataSourceUid:a,query:i,timeRange:t,stackTrace:e}),[p,m]=(0,o.useState)(),[f,h]=(0,o.useState)(l[0]),[g,y]=(0,o.useState)(Mt.x.has(Mt.x.KEYS.GITHUB_INTEGRATION));l&&p!==l&&(m(l),f!==l[0]&&h(l[0]));const b=((null==f||null===(n=f.version)||void 0===n?void 0:n.repository)||"").startsWith(ol);const v=null==f||null===(r=f.fileName)||void 0===r?void 0:r.endsWith(".go"),E=!g&&!b&&v,S=(0,o.useMemo)((()=>l.map((e=>Array.from(e.callSites.values()).reduce(((e,{cum:t})=>e+t),0))).reduce(((e,t)=>e+t),0)),[l]),w=rl(l,S),O=w.find((({sha:e})=>{var t;return e===(null==f||null===(t=f.commit)||void 0===t?void 0:t.sha)}));return{data:{isLoading:d,fetchFunctionDetailsError:u,functionDetails:f,repository:al(b,null==f?void 0:f.version),commits:w,selectedCommit:O,isGitHubSupported:v,shouldDisplayGitHubBanner:E,dataSourceUid:a},actions:{selectCommit(e){const t=l.find((({commit:t})=>t.sha===e.sha));h(t)},copyFilePathToClipboard(){return(e=function*(){try{(null==f?void 0:f.fileName)&&(yield navigator.clipboard.writeText(f.fileName),(0,c.qq)(["File path copied to clipboard!"]))}catch(e){}},function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Nl(a,r,o,i,s,"next",e)}function s(e){Nl(a,r,o,i,s,"throw",e)}i(void 0)}))})();var e},dismissGitHubBanner(){Mt.x.set(Mt.x.KEYS.GITHUB_INTEGRATION,{}),y(!0)}}}}))}}_l(Il,"LABEL_WIDTH",16),_l(Il,"Component",(({model:e,timeRange:t,stackTrace:n,onClose:r})=>{const o=(0,l.useStyles2)(Rl),{data:i,actions:s}=e.useSceneFunctionDetailsPanel(n,t);return a().createElement(Ya,{className:o.sidePanel,title:"Function Details",isLoading:!1,headerActions:a().createElement(l.IconButton,{name:"times-circle",variant:"secondary","aria-label":"close",onClick:r}),dataTestId:"function-details-panel"},a().createElement("div",{className:o.content},i.fetchFunctionDetailsError&&a().createElement(Ta._,{severity:"error",title:"Error while fetching function details!",error:i.fetchFunctionDetailsError}),a().createElement("div",{className:o.container},a().createElement("div",{className:o.row,"data-testid":"row-function-name"},a().createElement(l.InlineLabel,{width:Il.LABEL_WIDTH},"Function name"),a().createElement(l.Tooltip,{content:i.functionDetails.name,placement:"top"},a().createElement("span",{className:o.textValue},i.functionDetails.name))),a().createElement("div",{className:o.row,"data-testid":"row-start-line"},a().createElement(l.InlineLabel,{tooltip:"The line where this function definition starts",width:Il.LABEL_WIDTH},"Start line"),a().createElement("span",{className:o.textValue},a().createElement(jl,{isLoading:i.isLoading},void 0!==i.functionDetails.startLine?i.functionDetails.startLine:"-"))),a().createElement("div",{className:o.row,"data-testid":"row-file-path"},a().createElement(l.InlineLabel,{tooltip:"File path where that function is defined",width:Il.LABEL_WIDTH},"File"),a().createElement(jl,{isLoading:i.isLoading},i.functionDetails.fileName?a().createElement(a().Fragment,null,a().createElement(l.Tooltip,{content:i.functionDetails.fileName,placement:"top"},a().createElement("span",{className:o.textValue},"‎","/"===(null==(c=i.functionDetails.fileName)?void 0:c[0])?c.substring(1)+"/":c)),a().createElement(l.IconButton,{name:"clipboard-alt",tooltip:"Copy to clipboard",onClick:s.copyFilePathToClipboard})):"-")),i.shouldDisplayGitHubBanner&&a().createElement("div",{className:o.row,"data-testid":"row-github-banner"},a().createElement(kl,{onDismiss:s.dismissGitHubBanner})),a().createElement("div",{className:o.row,"data-testid":"row-repository"},a().createElement(l.InlineLabel,{tooltip:"The repository configured for the selected service",width:Il.LABEL_WIDTH},"Repository"),a().createElement(jl,{isLoading:i.isLoading},i.repository?i.repository.isGitHub?a().createElement(el,{enableIntegration:i.isGitHubSupported,repository:i.repository}):a().createElement(l.TextLink,{href:i.repository,external:!0},i.repository):"-")),a().createElement("div",{className:o.row,"data-testid":"row-commit"},a().createElement(l.InlineLabel,{width:Il.LABEL_WIDTH,tooltip:"The version of the application (commit) where the function is defined. Use the dropdown menu to target a specific commit."},"Commit"),a().createElement(jl,{isLoading:i.isLoading},a().createElement(xl,{commits:i.commits,selectedCommit:i.selectedCommit,onChange:s.selectCommit})))),a().createElement(Xs,{dataSourceUid:i.dataSourceUid,functionDetails:i.functionDetails})));var c}));const Rl=e=>({sidePanel:i.css`
    flex: 1 0 50%;
    margin-left: 8px;
    max-width: calc(50% - 4px);
  `,title:i.css`
    margin: -4px 0 4px 0;
  `,content:i.css`
    padding: ${e.spacing(1)};
  `,container:i.css`
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  `,row:i.css`
    width: 100%;
    display: flex;
    flex-direction: row;
    align-items: center;
    padding-bottom: 10px;
    > * {
      margin-right: 10px !important;
    }
  `,textValue:i.css`
    // hack to have the ellipsis appear at the start of the string
    direction: rtl;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
  `});function Ll(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Dl extends s.Bs{onActivate(){let e;const t=this.subscribeToState(((t,n)=>{var r;t.$data!==n.$data&&(e&&e.unsubscribe(),e=null===(r=t.$data)||void 0===r?void 0:r.subscribeToState((e=>{var t;(null===(t=e.data)||void 0===t?void 0:t.state)===h.LoadingState.Done&&this.setState({lastTimeRange:e.data.timeRange})})))}));return()=>{t.unsubscribe(),null==e||e.unsubscribe()}}buildTitle(){const e=an(this,"serviceName"),t=jt(an(this,"profileMetricId")).type;return a().createElement(a().Fragment,null,a().createElement(Qa.S,{size:"small"}),"Flame graph for ",e," (",t,")")}constructor(){super({key:"flame-graph",$data:new s.dt({datasource:_t,queries:[]}),lastTimeRange:void 0,exportMenu:new _s,aiPanel:new pi,functionDetailsPanel:new Il}),Ll(this,"useSceneFlameGraph",(()=>{var e,t,n,r,a;const{isLight:i}=(0,l.useTheme2)(),s=(0,o.useMemo)((()=>()=>(0,h.createTheme)({colors:{mode:i?"light":"dark"}})),[i]),[u]=(0,gi.I)(),{settings:d,error:p}=(0,xa._)(),{$data:m,lastTimeRange:f,exportMenu:g,aiPanel:y,functionDetailsPanel:b}=this.useState();p&&(0,c.HA)(["Error while retrieving the plugin settings!","Some features might not work as expected (e.g. collapsed flame graphs). Please try to reload the page, sorry for the inconvenience."]),(0,o.useEffect)((()=>{u&&this.setState({$data:fs({maxNodes:u})})}),[u]);const v=m.useState(),E=null==v||null===(e=v.data)||void 0===e?void 0:e.state,S=E===h.LoadingState.Error?(null==v||null===(n=v.data)||void 0===n||null===(t=n.errors)||void 0===t?void 0:t[0])||new Error("Unknown error!"):null,w=E===h.LoadingState.Loading,O=null==v||null===(a=v.data)||void 0===a||null===(r=a.series)||void 0===r?void 0:r[0],x=Number(null==O?void 0:O.length)>1,T=Kt(this,"filters");return{data:{title:this.buildTitle(),isLoading:w,isFetchingProfileData:w,hasProfileData:x,profileData:O,fetchProfileError:S,settings:d,export:{menu:g,query:T,timeRange:f},ai:{panel:y,fetchParams:[{query:T,timeRange:f}]},gitHub:{panel:b,timeRange:f}},actions:{getTheme:s}}})),this.addActivationHandler(this.onActivate.bind(this))}}Ll(Dl,"Component",(({model:e})=>{var t;const n=(0,l.useStyles2)(Fl),{data:r,actions:i}=e.useSceneFlameGraph(),s=Oa(),c=Rs(s),u=r.isLoading||!r.hasProfileData;(0,o.useEffect)((()=>{u&&s.close()}),[u,s]);const d=(0,o.useMemo)((()=>a().createElement(a().Fragment,null,r.title,r.isLoading&&a().createElement(l.Spinner,{inline:!0,className:n.spinner}))),[r.isLoading,r.title,n.spinner]);return a().createElement("div",{className:n.flex},a().createElement(Ya,{dataTestId:"flame-graph-panel",className:n.flamegraphPanel,title:d,isLoading:r.isLoading,headerActions:a().createElement(Xa,{disabled:u||s.isOpen("ai"),onClick:()=>s.open("ai"),interactionName:"g_pyroscope_app_explain_flamegraph_clicked"},"Explain Flame Graph")},r.fetchProfileError&&a().createElement(Ta._,{severity:"error",title:"Error while loading profile data!",error:r.fetchProfileError}),!r.fetchProfileError&&a().createElement(ms.A,{data:r.profileData,disableCollapsing:!(null===(t=r.settings)||void 0===t?void 0:t.collapsedFlamegraphs),getTheme:i.getTheme,getExtraContextMenuButtons:c.actions.getExtraFlameGraphMenuItems,extraHeaderElements:a().createElement(r.export.menu.Component,{model:r.export.menu,query:r.export.query,timeRange:r.export.timeRange}),keepFocusOnDataChange:!0})),s.isOpen("ai")&&a().createElement(r.ai.panel.Component,{model:r.ai.panel,fetchParams:r.ai.fetchParams,onClose:s.close}),s.isOpen("function-details")&&a().createElement(r.gitHub.panel.Component,{model:r.gitHub.panel,timeRange:r.gitHub.timeRange,stackTrace:c.data.stacktrace,onClose:s.close}))}));const Fl=e=>({flex:i.css`
    display: flex;
  `,flamegraphPanel:i.css`
    min-width: 0;
    flex-grow: 1;
  `,spinner:i.css`
    margin-left: ${e.spacing(1)};
  `});class $l extends s.Bs{onActivate(e){e&&this.initVariables(e);const t=s.jh.findByKeyAndType(this,"profileMetricId",$t);return t.setState({query:$t.QUERY_SERVICE_NAME_DEPENDENT}),t.update(!0),()=>{t.setState({query:$t.QUERY_DEFAULT}),t.update(!0)}}initVariables(e){const{serviceName:t,profileMetricId:n,filters:r}=e.queryRunnerParams;if(t){s.jh.findByKeyAndType(this,"serviceName",qt).changeValueTo(t)}if(n){s.jh.findByKeyAndType(this,"profileMetricId",$t).changeValueTo(n)}if(r){s.jh.findByKeyAndType(this,"filters",on).setState({filters:r})}}getVariablesAndGridControls(){return{variables:[s.jh.findByKeyAndType(this,"serviceName",qt),s.jh.findByKeyAndType(this,"profileMetricId",$t),s.jh.findByKeyAndType(this,"filters",on)],gridControls:[]}}static Component({model:e}){const t=(0,l.useStyles2)(Bl),{mainTimeseries:n,body:r}=e.useState();return a().createElement("div",{className:t.flex},a().createElement("div",{className:t.mainTimeseries},a().createElement(n.Component,{model:n})),a().createElement(r.Component,{model:r}))}constructor({item:e}){super({key:"explore-service-flame-graph",mainTimeseries:new Jr({item:e,headerActions:e=>[new Nr({type:"view-labels",item:e}),new yr({item:e})]}),body:new Dl}),this.addActivationHandler(this.onActivate.bind(this,e))}}const Bl=e=>({flex:i.css`
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: ${e.spacing(1)};
  `,mainTimeseries:i.css`
    height: ${Jr.MIN_HEIGHT}px;
  `});var Ml=n(2932),Ul=n(1159),Vl=n(4137);function ql(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Gl(){return Kl.apply(this,arguments)}function Kl(){var e;return e=function*(){(0,f.r)("g_pyroscope_app_share_link_clicked");try{yield navigator.clipboard.writeText(function(){const e=new URL(window.location.toString()),{searchParams:t}=e;return t.get("from")||t.set("from",Ro().from),t.get("to")||t.set("to",Ro().to),["from","to","from-2","to-2","from-3","to-3","diffFrom","diffTo","diffFrom-2","diffTo-2"].forEach((e=>{const n=t.get(e);n&&t.set(e,String(h.dateMath.parse(n).valueOf()))})),e}().toString()),(0,c.qq)(["Link copied to clipboard!"])}catch(e){y.v.error(e,{info:"Error while creating the shareable link!"})}},Kl=function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){ql(a,r,o,i,s,"next",e)}function s(e){ql(a,r,o,i,s,"throw",e)}i(void 0)}))},Kl.apply(this,arguments)}function Hl({options:e,value:t,onChange:n}){const r=(0,l.useStyles2)(zl),s=e.findIndex((e=>e.value===t));return a().createElement("div",{className:r.explorationTypeContainer,"data-testid":"exploration-types"},a().createElement("div",{className:r.label},"Exploration"),a().createElement("div",{className:r.breadcrumb},e.map(((c,u)=>{const d=t===c.value,p=(m=u,s===e.length-1?m===s?"primary":"secondary":m<=s?"primary":"secondary");var m;const f=[d&&"active","primary"===p&&"primary"];return a().createElement(o.Fragment,{key:c.value},a().createElement(l.Button,{className:(0,i.cx)(r.button,...f),variant:p,size:"sm","aria-label":c.label,icon:c.icon,onClick:d?g.f:()=>n(c.value),tooltip:c.description,tooltipPlacement:"top","data-testid":d?"is-active":void 0},c.label),u<e.length-3&&a().createElement("div",{className:s!==e.length-1&&u<=s-1?(0,i.cx)(r.arrow,"arrow",...f):r.arrow}))}))))}const zl=e=>({explorationTypeContainer:i.css`
    display: flex;
    align-items: center;
  `,label:i.css`
    display: flex;
    gap: 2px;
    align-items: center;
    font-size: 14px;
    margin-right: ${e.spacing(1)};

    ${e.breakpoints.down("xxl")} {
      display: none;
    }
  `,breadcrumb:i.css`
    display: flex;
    align-items: center;
    height: 32px;
    line-height: 32px;

    .active {
      background-color: ${e.colors.primary.main};
    }

    .arrow.primary {
      background-color: ${e.colors.primary.main};
    }

    & button.primary:not(.active),
    & .arrow.primary:not(.active) {
      opacity: 0.7;
    }

    & button.primary:not(.active):hover {
      opacity: 1;
      background-color: ${e.colors.primary.main};
    }
  `,button:i.css`
    height: 27px;
    line-height: 27px;
    border-radius: 15px;

    &:hover {
      border-color: ${e.colors.primary.main};
    }

    &.active:hover {
      cursor: default;
      background-color: ${e.colors.primary.main};
    }

    &:nth-last-child(2) {
      margin-left: ${e.spacing(1)};
    }

    &:nth-last-child(1) {
      margin-left: ${e.spacing(2)};
    }
  `,arrow:i.css`
    background-color: ${e.colors.text.disabled};
    width: 10px;
    height: 2px;
  `});function Yl(e){const t=null===k.useChromeHeaderHeight||void 0===k.useChromeHeaderHeight?void 0:(0,k.useChromeHeaderHeight)(),n=(0,l.useStyles2)(Ql,null!=t?t:0),{data:r,actions:s}=function({explorationType:e,controls:t,body:n,$variables:r,onChangeExplorationType:a}){const[i,s]=e===Jl.DIFF_FLAME_GRAPH?[]:t,l=r.state.variables[0],c=null==n?void 0:n.state.primary;if("function"!=typeof c.getVariablesAndGridControls)throw new Error(`Error while rendering "${c.constructor.name}": the "getVariablesAndGridControls" method is missing! Please implement it.`);const{variables:u,gridControls:d}=c.getVariablesAndGridControls(),p=l.useState().value,m=(0,Ul.useNavigate)();return{data:{explorationType:e,dataSourceVariable:l,timePickerControl:i,refreshPickerControl:s,sceneVariables:u,gridControls:d,body:n,dataSourceUid:p},actions:{onChangeExplorationType:a,onClickShareLink:Gl,onClickAdHoc:(0,o.useCallback)((()=>{(0,f.r)("g_pyroscope_app_upload_ad_hoc_clicked"),m(`${Vl.Gy}${Vl.bw.ADHOC}`,{state:{referrer:window.location.href}})}),[m]),onClickUserSettings:(0,o.useCallback)((()=>{(0,f.r)("g_pyroscope_app_user_settings_clicked"),m(`${Vl.Gy}${Vl.bw.SETTINGS}`,{state:{referrer:window.location.href}})}),[m])}}}(e),{explorationType:c,dataSourceVariable:u,timePickerControl:d,refreshPickerControl:p,sceneVariables:m,gridControls:h}=r;return a().createElement("div",{className:n.header,"data-testid":"allControls"},a().createElement(ki,null),a().createElement("div",{className:n.appControls,"data-testid":"appControls"},a().createElement("div",{className:n.appControlsLeft},a().createElement(Hl,{options:Xl.EXPLORATION_TYPE_OPTIONS,value:c,onChange:s.onChangeExplorationType})),a().createElement("div",{className:n.appControlsRight},d&&a().createElement(d.Component,{key:d.state.key,model:d}),p&&a().createElement(p.Component,{key:p.state.key,model:p}),a().createElement("div",{className:n.appMiscButtons},a().createElement(l.IconButton,{name:"upload",tooltip:"Upload ad hoc profiles",onClick:s.onClickAdHoc}),a().createElement(l.IconButton,{name:"cog",tooltip:"View/edit tenant settings",onClick:s.onClickUserSettings}),a().createElement(l.IconButton,{name:"share-alt",tooltip:"Copy shareable link to the clipboard",onClick:s.onClickShareLink}),a().createElement(Ml.U,null)))),a().createElement("div",{id:`scene-controls-${c}`,className:n.sceneControls,"data-testid":"sceneControls"},a().createElement(l.Field,{label:u.state.label,className:(0,i.cx)(n.sceneVariable,u.state.name),"data-testid":u.state.name},a().createElement(u.Component,{model:u})),m.map((e=>a().createElement(l.Field,{key:e.state.name,label:"Filters"===e.state.label?a().createElement("div",{className:n.sceneVariableLabel},a().createElement(l.Icon,{name:"filter",className:n.icon}),e.state.label):e.state.label,className:(0,i.cx)(n.sceneVariable,e.state.name),"data-testid":e.state.name},a().createElement(e.Component,{model:e})))),h.map((e=>a().createElement(l.Field,{key:e.state.key,id:e.state.key,className:n.gridControl,label:""},a().createElement(e.Component,{model:e}))))))}const Ql=(e,t)=>({header:i.css`
    background-color: ${e.colors.background.canvas};
    position: sticky;
    top: ${t}px;
    z-index: 1;
    padding-bottom: ${e.spacing(2)};
  `,appControls:i.css`
    display: flex;
    padding: ${e.spacing(1)} 0;
    justify-content: space-between;
    gap: ${e.spacing(2)};
  `,appControlsLeft:i.css`
    display: flex;
    gap: ${e.spacing(1)};
  `,appControlsRight:i.css`
    display: flex;
    gap: ${e.spacing(1)};
  `,appMiscButtons:i.css`
    display: flex;
    align-items: center;
    gap: 4px;
    border: 1px solid ${e.colors.border.weak};
    background-color: ${e.colors.background.secondary};
    height: 32px;
    padding: 0 ${e.spacing(1)};

    & svg {
      width: 18px;
      height: 18px;
    }
  `,sceneControls:i.css`
    display: flex;
    flex-wrap: wrap;
    gap: ${e.spacing(1)};
    padding: 0;
    margin-top: 20px;
  `,sceneVariable:i.css`
    display: flex;
    margin-bottom: 0;

    & #dataSource {
      width: ${e.spacing(32)};
    }

    &.filters {
      flex-grow: 1;
    }

    &.compare-presets {
      margin-left: auto;
      text-align: right;
    }
  `,sceneVariableLabel:i.css`
    font-size: 12px;
    font-weight: 500;
    line-height: 15px;
    height: 15px;
    margin-bottom: 4px;
    color: ${e.colors.text.primary};
    max-width: 480px;
  `,icon:i.css`
    display: inline-block;
    margin-right: 4px;
  `,gridControl:i.css`
    margin-bottom: 0;

    &#quick-filter {
      flex: 1;
      min-width: 112px;
    }
  `});function Wl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Jl=function(e){return e.ALL_SERVICES="all",e.PROFILE_TYPES="profiles",e.LABELS="labels",e.FLAME_GRAPH="flame-graph",e.DIFF_FLAME_GRAPH="diff-flame-graph",e.FAVORITES="favorites",e}({});class Xl extends s.Bs{onActivate(){const e=this.subscribeToVariableChanges(),t=this.subscribeToEvents();return this.state.explorationType||this.setExplorationType({type:Xl.DEFAULT_EXPLORATION_TYPE}),()=>{t.unsubscribe(),e.unsubscribe()}}getUrlState(){return{explorationType:this.state.explorationType}}updateFromUrl(e){if("string"==typeof e.explorationType&&e.explorationType!==this.state.explorationType){const t=e.explorationType;this.setExplorationType({type:Object.values(Jl).includes(t)?t:Xl.DEFAULT_EXPLORATION_TYPE})}}registerRuntimeDataSources(){try{s.Go.registerRuntimeDataSource({dataSource:new Ho}),s.Go.registerRuntimeDataSource({dataSource:new fr}),s.Go.registerRuntimeDataSource({dataSource:new _n})}catch(e){const{message:t}=e;/A runtime data source with uid (.+) has already been registered/.test(t)||(0,c.jx)(e,["Fail to register all the runtime data sources!","The application cannot work as expected, please try reloading the page or if the problem persists, contact your organization admin."])}}subscribeToVariableChanges(){const e=s.jh.findByKeyAndType(this,"dataSource",Ht).subscribeToState(((e,t)=>{e.value&&e.value!==t.value&&on.resetAll(this)})),t=s.jh.findByKeyAndType(this,"serviceName",qt).subscribeToState(((e,t)=>{e.value&&e.value!==t.value&&on.resetAll(this)}));return{unsubscribe(){t.unsubscribe(),e.unsubscribe()}}}subscribeToEvents(){const e=this.subscribeToEvent(Pr,(e=>{this.setExplorationType({type:"profiles",comesFromUserAction:!0,item:e.payload.item})})),t=this.subscribeToEvent(Tr,(e=>{this.setExplorationType({type:"labels",comesFromUserAction:!0,item:e.payload.item})})),n=this.subscribeToEvent(xr,(e=>{this.setExplorationType({type:"flame-graph",comesFromUserAction:!0,item:e.payload.item})})),r=this.subscribeToEvent(Xr,(e=>{const{useAncestorTimeRange:t,clearDiffRange:n,baselineFilters:r,comparisonFilters:o}=e.payload;this.setExplorationType({type:"diff-flame-graph",comesFromUserAction:!0,bodySceneOptions:{useAncestorTimeRange:t,clearDiffRange:n,baselineFilters:r,comparisonFilters:o}})}));return{unsubscribe(){r.unsubscribe(),n.unsubscribe(),t.unsubscribe(),e.unsubscribe()}}}setExplorationType({type:e,comesFromUserAction:t,item:n,bodySceneOptions:r}){t&&(u(),this.resetVariables(e)),this.setState({explorationType:e,body:this.buildBodyScene(e,n,r)})}resetVariables(e){s.jh.findByKeyAndType(this,"quick-filter",lr).reset(),s.jh.findByKeyAndType(this,"groupBy",Yr).changeValueTo(Yr.DEFAULT_VALUE),s.jh.findByKeyAndType(this,"panel-type-switcher",cn).reset(),["labels","flame-graph","diff-flame-graph"].includes(e)||s.jh.findByKeyAndType(this,"filters",on).reset()}buildBodyScene(e,t,n){let r;switch(e){case"profiles":r=new _o({item:t});break;case"labels":r=new No({item:t});break;case"flame-graph":r=new $l({item:t});break;case"diff-flame-graph":r=new Ri(n||{});break;case"favorites":r=new Ur;break;default:r=new Ir}return new s.n1({direction:"column",primary:r})}static Component({model:e}){const t=(0,l.useStyles2)(Zl),{data:n,actions:r}=e.useProfilesExplorer(),{explorationType:o,controls:i,body:s,$variables:c,dataSourceUid:u}=n;return a().createElement(ps,{dataSourceUid:u},a().createElement(Yl,{explorationType:o,controls:i,body:s,$variables:c,onChangeExplorationType:r.onChangeExplorationType}),a().createElement("div",{className:t.body,"data-testid":"sceneBody"},s&&a().createElement(s.Component,{model:s})))}constructor(){super({key:"profiles-explorer",explorationType:void 0,body:void 0,$timeRange:new s.JZ(Ro()),$variables:new s.Pj({variables:[new Ht,new qt,new $t,new on({key:"filters"}),new on({key:"filtersBaseline"}),new on({key:"filtersComparison"}),new Yr]}),controls:[new s.KE({isOnCanvas:!0}),new s.WM({isOnCanvas:!0})],gridControls:[new lr({placeholder:""}),new cn,new or,new ir]}),Wl(this,"_urlSync",new s.So(this,{keys:["explorationType"]})),Wl(this,"onChangeExplorationType",(e=>{(0,f.r)("g_pyroscope_app_exploration_type_clicked",{explorationType:e}),this.setExplorationType({type:e,comesFromUserAction:!0})})),Wl(this,"useProfilesExplorer",(()=>{const{explorationType:e,controls:t,body:n,$variables:r}=this.useState();return{data:{explorationType:e,controls:t,body:n,$variables:r,dataSourceUid:r.state.variables[0].useState().value},actions:{onChangeExplorationType:this.onChangeExplorationType}}})),(0,s.Is)().initSync(this),this.registerRuntimeDataSources(),this.addActivationHandler(this.onActivate.bind(this))}}Wl(Xl,"EXPLORATION_TYPE_OPTIONS",[{value:"all",label:"All services",description:"Overview of all services, for any given profile type"},{value:"profiles",label:"Profile types",description:"Overview of all the profile types for a single service"},{value:"labels",label:"Labels",description:"Single service label exploration and filtering"},{value:"flame-graph",label:"Flame graph",description:"Single service flame graph"},{value:"diff-flame-graph",label:"Diff flame graph",description:"Compare the differences between two flame graphs"},{value:"favorites",label:"Favorites",description:"Overview of favorited visualizations",icon:"favorite"}]),Wl(Xl,"DEFAULT_EXPLORATION_TYPE",Xl.EXPLORATION_TYPE_OPTIONS[0].value);const Zl=()=>({body:i.css`
    position: relative;
    z-index: 0;
    background: transparent;
  `});function ec(){const e=(0,o.useMemo)((()=>new Xl),[]);return(0,r.f)("explore"),a().createElement(e.Component,{model:e})}},9897:(e,t,n)=>{n.d(t,{N:()=>r});var r=function(e){return e.BASELINE="baseline",e.COMPARISON="comparison",e}({})},8629:(e,t,n)=>{n.d(t,{C:()=>A});var r=n(7781),o=n(3062),a=n(2007),i=n(5959),s=n.n(i),l=n(2673),c=n(7907),u=(n(8727),n(2249)),d=n.n(u),p=n(9090);function m(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}class f extends p.Q{upload(e,t){var n,r=this;return(n=function*(){const n=yield r.fetch("/upload/v1",{method:"POST",body:JSON.stringify({name:e,profile:btoa(JSON.stringify(t)),fileTypeData:{units:t.metadata.units,spyName:t.metadata.spyName},type:"json"})});return yield n.json()},function(){var e=this,t=arguments;return new Promise((function(r,o){var a=n.apply(e,t);function i(e){m(a,r,o,i,s,"next",e)}function s(e){m(a,r,o,i,s,"throw",e)}i(void 0)}))})()}constructor(){super("https://flamegraph.com/api",{"content-type":"application/json"})}}const h=new f;var g=n(9897);const y=new Intl.DateTimeFormat("fr-CA",{year:"numeric",month:"2-digit",day:"2-digit",hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"});function b(e){const t=y.formatToParts(e).reduce(((e,{type:t,value:n})=>(e[t]=n,e)),{});return`${t.year}-${t.month}-${t.day}_${t.hour}${t.minute}`}function v(e){const t=new Date(Math.round(1e3*e.from.unix())),n=new Date(Math.round(1e3*e.to.unix()));return`${b(t)}-to-${b(n)}`}function E(e){const[t,n]=e===g.N.BASELINE?["diffFrom","diffTo"]:["diffFrom-2","diffTo-2"],o=new URLSearchParams(window.location.search),a=o.get(t),i=o.get(n);return{raw:{from:a,to:i},from:(0,r.dateTimeParse)(a),to:(0,r.dateTimeParse)(i)}}function S(e){const t=["baseline",v(E(g.N.BASELINE)),"comparison",v(E(g.N.COMPARISON))];return e?[e,...t].join("_"):["flamegraph",...t].join("_")}function w(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function O({profile:e,enableFlameGraphDotComExport:t}){const n=function(){var t,n=(t=function*(){(0,c.r)("g_pyroscope_app_export_profile",{format:"flamegraph.com"});const t=S(e.metadata.appName);let n;try{n=yield h.upload(t,e)}catch(e){return void(0,l.jx)(e,["Failed to export to flamegraph.com!",e.message])}const r=document.createElement("a");r.target="_blank",r.href=n.url,document.body.appendChild(r),r.click(),document.body.removeChild(r)},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){w(a,r,o,i,s,"next",e)}function s(e){w(a,r,o,i,s,"throw",e)}i(void 0)}))});return function(){return n.apply(this,arguments)}}();return{data:{shouldDisplayFlamegraphDotCom:Boolean(t)},actions:{downloadPng:()=>{(0,c.r)("g_pyroscope_app_export_profile",{format:"png"});const t=`${S(e.metadata.appName)}.png`;document.querySelector('canvas[data-testid="flameGraph"]').toBlob((e=>{if(e)d()(e,t);else{const e=new Error("No Blob, the image cannot be created.");(0,l.jx)(e,["Failed to export to png!",e.message])}}),"image/png")},downloadJson:()=>{(0,c.r)("g_pyroscope_app_export_profile",{format:"json"});const t=`${S(e.metadata.appName)}.json`,n=`data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(e))}`;try{d()(n,t)}catch(e){return void(0,l.jx)(e,["Failed to export to JSON!",e.message])}},uploadToFlamegraphDotCom:n}}}function x(e){const{actions:t}=O(e);return s().createElement(a.Menu,null,s().createElement(a.Menu.Item,{label:"png",onClick:t.downloadPng}),s().createElement(a.Menu.Item,{label:"json",onClick:t.downloadJson}))}function T(e){const{profile:t,enableFlameGraphDotComExport:n}=e;return s().createElement(a.Dropdown,{overlay:s().createElement(x,{profile:t,enableFlameGraphDotComExport:n})},s().createElement(a.Button,{icon:"download-alt",size:"sm",variant:"secondary",fill:"outline","aria-label":"Export profile data",tooltip:"Export profile data"}))}const P=(0,i.memo)(T);function C(e,t,n){const r=[],o=n?7:4;for(let a=0;a<e.length;a+=o)r.push({level:0,label:n?t[e[a+6]]:t[e[a+3]],offset:e[a],val:e[a+1],self:e[a+2],selfRight:n?e[a+5]:0,valRight:n?e[a+4]:0,valTotal:n?e[a+1]+e[a+4]:e[a+1],offsetRight:n?e[a+3]:0,offsetTotal:n?e[a]+e[a+3]:e[a],children:[]});return r}function k({profile:e,diff:t,vertical:n,enableFlameGraphDotComExport:l,collapsedFlamegraphs:c,getExtraContextMenuButtons:u}){const{isLight:d}=(0,a.useTheme2)(),p=(0,i.useMemo)((()=>function(e,t,n,o){if(!e.length)return;const a=[];for(let n=0;n<e.length;n++){a[n]=[];for(const r of C(e[n],t,o))if(r.level=n,a[n].push(r),n>0){const e=a[n].slice(0,-1).reduce(((e,t)=>t.offsetTotal+t.valTotal+e),0)+r.offsetTotal,t=a[n-1];let o=0;for(const n of t){const t=o+n.offsetTotal,a=t+n.valTotal;if(t<=e&&a>e){n.children.push(r);break}o+=n.offsetTotal+n.valTotal}}}const i=[a[0][0]],s=[],l=[],c=[],u=[],d=[],p=[];for(;i.length;){const e=i.shift();s.push(e.label),l.push(e.level),c.push(e.self),u.push(e.val),d.push(e.selfRight),p.push(e.valRight),i.unshift(...e.children)}let m="short";switch(n){case"samples":case"trace_samples":case"lock_nanoseconds":case"nanoseconds":m="ns";break;case"bytes":m="bytes"}const f=[{name:"level",values:l},{name:"label",values:s,type:r.FieldType.string},{name:"self",values:c,config:{unit:m}},{name:"value",values:u,config:{unit:m}}];o&&f.push({name:"selfRight",values:d,config:{unit:m}},{name:"valueRight",values:p,config:{unit:m}});const h={name:"response",meta:{preferredVisualisationType:"flamegraph"},fields:f};return(0,r.createDataFrame)(h)}(e.flamebearer.levels,e.flamebearer.names,e.metadata.units,Boolean(t))),[e,t]);return s().createElement(o.A,{data:p,disableCollapsing:!c,extraHeaderElements:s().createElement(P,{profile:e,enableFlameGraphDotComExport:l}),vertical:n,getTheme:()=>(0,r.createTheme)({colors:{mode:d?"light":"dark"}}),getExtraContextMenuButtons:u,keepFocusOnDataChange:!0})}const A=(0,i.memo)(k)},2673:(e,t,n)=>{n.d(t,{HA:()=>c,jx:()=>l,qq:()=>u});var r=n(7781),o=n(8531),a=n(2096);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function l(e,t){const n=t.reduce(((e,t,n)=>s(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){i(e,t,n[t])}))}return e}({},e),{[`info${n+1}`]:t})),{handheldBy:"displayError"});a.v.error(e,n),(0,o.getAppEvents)().publish({type:r.AppEvents.alertError.name,payload:t})}function c(e){a.v.warn(e),(0,o.getAppEvents)().publish({type:r.AppEvents.alertWarning.name,payload:e})}function u(e){(0,o.getAppEvents)().publish({type:r.AppEvents.alertSuccess.name,payload:e})}},7907:(e,t,n)=>{n.d(t,{r:()=>c});var r=n(8531),o=n(4137),a=n(5176);const i=o.bw.EXPLORE.slice(1);function s(){const{pathname:e}=new URL(window.location.toString());return e.split("/").pop()||""}function l(){const e={appRelease:r.config.apps[o.R2].version,appVersion:a.t,page:s()};return e.page===i&&(e.view=new URLSearchParams(window.location.search).get("explorationType")||""),e}function c(e,t){(0,r.reportInteraction)(e,{props:t,meta:l()})}},9993:(e,t,n)=>{n.d(t,{I:()=>l});var r=n(2673),o=n(9326),a=n(8873),i=n(2096),s=n(1159);function l(){const{searchParams:e,pushNewUrl:t}=function(){const e=(0,s.useNavigate)(),t=(0,s.useLocation)();return{searchParams:new URLSearchParams(t.search),pushNewUrl:t=>{const n=new URLSearchParams(window.location.search);for(const[e,r]of Object.entries(t))n.set(e,r);e({search:n.toString()},{replace:!0})}}}();var n;const l=Number(null!==(n=e.get("maxNodes"))&&void 0!==n?n:""),c=e=>{t({maxNodes:String(e)})};return function(e,t){const{isFetching:n,error:s,settings:l}=(0,a._)({enabled:!e});if(!e&&!n)s?((0,r.HA)(["Error while retrieving the plugin settings!","Some features might not work as expected (e.g. flame graph max nodes). Please try to reload the page, sorry for the inconvenience."]),i.v.error(s),t(o.a.maxNodes)):t(l.maxNodes)}(l>0,c),[l,c]}},9326:(e,t,n)=>{n.d(t,{a:()=>r});const r=Object.freeze({collapsedFlamegraphs:!1,maxNodes:16384,enableFlameGraphDotComExport:!0,enableFunctionDetails:!0})},8873:(e,t,n)=>{n.d(t,{_:()=>f});var r,o,a,i=n(7616),s=n(6667),l=n(9326),c=n(5656);function u(e,t,n,r,o,a,i){try{var s=e[a](i),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function d(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){u(a,r,o,i,s,"next",e)}function s(e){u(a,r,o,i,s,"throw",e)}i(void 0)}))}}class p extends c.O{get(){var e=this,t=()=>super.fetch;return d((function*(){return t().call(e,"/settings.v1.SettingsService/Get",{method:"POST",body:JSON.stringify({})}).then((e=>e.json())).then((e=>{var t;const n=null===(t=e.settings)||void 0===t?void 0:t.find((({name:e})=>e===p.PLUGIN_SETTING_NAME));return n?JSON.parse(n.value):{}}))}))()}set(e){var t=this,n=()=>super.fetch;return d((function*(){return n().call(t,"/settings.v1.SettingsService/Set",{method:"POST",body:JSON.stringify({setting:{name:p.PLUGIN_SETTING_NAME,value:JSON.stringify(e)}})}).then((e=>e.json()))}))()}}a="pluginSettings",(o="PLUGIN_SETTING_NAME")in(r=p)?Object.defineProperty(r,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):r[o]=a;const m=new p;function f({enabled:e}={}){const{isFetching:t,error:n,data:r}=(0,i.I)({enabled:e,queryKey:["settings"],queryFn:()=>m.get().then((e=>Object.keys(l.a).reduce(((e,t)=>{var n,r,o;return null!==(o=(n=e)[r=t])&&void 0!==o||(n[r]=l.a[t]),e}),e)))}),{mutateAsync:o}=(0,s.n)({mutationFn:e=>m.set(e),networkMode:"always"});return{isFetching:t,error:m.isAbortError(n)?null:n,settings:r,mutate:o}}},4776:(e,t,n)=>{n.d(t,{f:()=>a});var r=n(7907),o=n(5959);function a(e){const[t,n]=(0,o.useState)(!1);(0,o.useEffect)((()=>{t||(n(!0),(0,r.r)("g_pyroscope_app_page_initialized",{page:e}))}),[e,t])}}}]);
//# sourceMappingURL=75.js.map